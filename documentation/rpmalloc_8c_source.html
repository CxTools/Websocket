<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WSServer: rpmalloc.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.doxygen.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">WSServer
   &#160;<span id="projectnumber">v2.0.6</span>
   </div>
   <div id="projectbrief">C-WebSocket-Server</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('rpmalloc_8c_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">rpmalloc.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="rpmalloc_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* rpmalloc.c  -  Memory allocator  -  Public Domain  -  2016-2020 Mattias Jansson</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> * This library provides a cross-platform lock free thread caching malloc implementation in C11.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * The latest source code is always available at</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * https://github.com/mjansson/rpmalloc</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> * This library is put in the public domain; you can redistribute it and/or modify it without any restrictions.</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160; </div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="rpmalloc_8h.html">rpmalloc.h</a>&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; </div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#if defined(__clang__)</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#pragma clang diagnostic ignored &quot;-Wunused-macros&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#pragma clang diagnostic ignored &quot;-Wunused-function&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#elif defined(__GCC__)</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Wunused-macros&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#pragma GCC diagnostic ignored &quot;-Wunused-function&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160; </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#ifndef HEAP_ARRAY_SIZE</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#define HEAP_ARRAY_SIZE           47</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#ifndef ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#define ENABLE_THREAD_CACHE       1</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#ifndef ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#define ENABLE_GLOBAL_CACHE       1</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#ifndef ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#define ENABLE_VALIDATE_ARGS      0</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#ifndef ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#define ENABLE_STATISTICS         0</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#ifndef ENABLE_ASSERTS</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#define ENABLE_ASSERTS            0</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#ifndef ENABLE_OVERRIDE</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#define ENABLE_OVERRIDE           0</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#ifndef ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#define ENABLE_PRELOAD            0</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#ifndef DISABLE_UNMAP</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#define DISABLE_UNMAP             0</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor">#ifndef ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#define ENABLE_UNLIMITED_CACHE    0</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor">#ifndef ENABLE_ADAPTIVE_THREAD_CACHE</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#define ENABLE_ADAPTIVE_THREAD_CACHE 0</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="preprocessor">#ifndef DEFAULT_SPAN_MAP_COUNT</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="preprocessor">#define DEFAULT_SPAN_MAP_COUNT    64</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="preprocessor">#ifndef GLOBAL_CACHE_MULTIPLIER</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="preprocessor">#define GLOBAL_CACHE_MULTIPLIER   8</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="preprocessor">#if DISABLE_UNMAP &amp;&amp; !ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="preprocessor">#error Must use global cache if unmap is disabled</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#if DISABLE_UNMAP</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor">#undef ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="preprocessor">#define ENABLE_UNLIMITED_CACHE 1</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160; </div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">#if !ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#undef ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor">#define ENABLE_UNLIMITED_CACHE 0</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160; </div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#if !ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor">#undef ENABLE_ADAPTIVE_THREAD_CACHE</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#define ENABLE_ADAPTIVE_THREAD_CACHE 0</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor">#if defined(_WIN32) || defined(__WIN32__) || defined(_WIN64)</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#  define PLATFORM_WINDOWS 1</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor">#  define PLATFORM_POSIX 0</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00104"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a20cd3c4775f1897fb5658d2dc61382c3">  104</a></span>&#160;<span class="preprocessor">#  define PLATFORM_WINDOWS 0</span></div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ad0092e018a32f308bad3efeaa795c92b">  105</a></span>&#160;<span class="preprocessor">#  define PLATFORM_POSIX 1</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; </div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor">#if defined(_MSC_VER) &amp;&amp; !defined(__clang__)</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor">#  ifndef FORCEINLINE</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor">#    define FORCEINLINE inline __forceinline</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="preprocessor">#  define _Static_assert static_assert</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="preprocessor">#  ifndef FORCEINLINE</span></div>
<div class="line"><a name="l00116"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">  116</a></span>&#160;<span class="preprocessor">#    define FORCEINLINE inline __attribute__((__always_inline__))</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="preprocessor">#  ifndef WIN32_LEAN_AND_MEAN</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="preprocessor">#    define WIN32_LEAN_AND_MEAN</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="preprocessor">#  include &lt;Windows.h&gt;</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="preprocessor">#  if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor">#    include &lt;Intsafe.h&gt;</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="preprocessor">#  include &lt;unistd.h&gt;</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="preprocessor">#  include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="preprocessor">#  include &lt;stdlib.h&gt;</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="preprocessor">#  if defined(__APPLE__)</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="preprocessor">#    include &lt;TargetConditionals.h&gt;</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="preprocessor">#    if !TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="preprocessor">#    include &lt;mach/mach_vm.h&gt;</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="preprocessor">#    include &lt;mach/vm_statistics.h&gt;</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="preprocessor">#    endif</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="preprocessor">#    include &lt;pthread.h&gt;</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="preprocessor">#  if defined(__HAIKU__)</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="preprocessor">#    include &lt;OS.h&gt;</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="preprocessor">#    include &lt;pthread.h&gt;</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160; </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160; </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="preprocessor">#include &lt;fibersapi.h&gt;</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="keyword">static</span> DWORD fls_key;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> NTAPI</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;_rpmalloc_thread_destructor(<span class="keywordtype">void</span>* value) {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">if</span> (value)</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1138b9406eb249def65f0f30a4820553">rpmalloc_thread_finalize</a>();</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;}</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160; </div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="preprocessor">#if PLATFORM_POSIX</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#  include &lt;sys/mman.h&gt;</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="preprocessor">#  include &lt;sched.h&gt;</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="preprocessor">#  ifdef __FreeBSD__</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="preprocessor">#    include &lt;sys/sysctl.h&gt;</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="preprocessor">#    define MAP_HUGETLB MAP_ALIGNED_SUPER</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="preprocessor">#  ifndef MAP_UNINITIALIZED</span></div>
<div class="line"><a name="l00167"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a14828817b96941a8a2ad71e2bb95143b">  167</a></span>&#160;<span class="preprocessor">#    define MAP_UNINITIALIZED 0</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160; </div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="preprocessor">#if ENABLE_ASSERTS</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="preprocessor">#  undef NDEBUG</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="preprocessor">#  if defined(_MSC_VER) &amp;&amp; !defined(_DEBUG)</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="preprocessor">#    define _DEBUG</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="preprocessor">#  include &lt;assert.h&gt;</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="preprocessor">#  undef  assert</span></div>
<div class="line"><a name="l00180"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">  180</a></span>&#160;<span class="preprocessor">#  define assert(x) do {} while(0)</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="preprocessor">#  include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; </div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="preprocessor">#if defined(_MSC_VER) &amp;&amp; !defined(__clang__)</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <span class="keywordtype">long</span>      atomic32_t;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> atomic64_t;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <span class="keywordtype">void</span>*     atomicptr_t;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160; </div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t atomic_load32(atomic32_t* src) { <span class="keywordflow">return</span> *src; }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(atomic32_t* dst, int32_t val) { *dst = val; }</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t <a class="code" href="rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(atomic32_t* val) { <span class="keywordflow">return</span> (int32_t)InterlockedIncrement(val); }</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t <a class="code" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(atomic32_t* val) { <span class="keywordflow">return</span> (int32_t)InterlockedDecrement(val); }</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t <a class="code" href="rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(atomic32_t* val, int32_t add) { <span class="keywordflow">return</span> (int32_t)InterlockedExchangeAdd(val, add) + add; }</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span>     <a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(atomic32_t* dst, int32_t val, int32_t ref) { <span class="keywordflow">return</span> (InterlockedCompareExchange(dst, val, ref) == ref) ? 1 : 0; }</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(atomic32_t* dst, int32_t val) { *dst = val; }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int64_t <a class="code" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(atomic64_t* src) { <span class="keywordflow">return</span> *src; }</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int64_t <a class="code" href="rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">atomic_add64</a>(atomic64_t* val, int64_t add) { <span class="keywordflow">return</span> (int64_t)InterlockedExchangeAdd64(val, add) + add; }</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>*   <a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(atomicptr_t* src) { <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)*src; }</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">atomic_store_ptr</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val) { *dst = val; }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val) { *dst = val; }</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>*   <a class="code" href="rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val) { <span class="keywordflow">return</span> (<span class="keywordtype">void</span>*)InterlockedExchangePointer((<span class="keywordtype">void</span>* <span class="keyword">volatile</span>*)dst, val); }</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span>     <a class="code" href="rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val, <span class="keywordtype">void</span>* ref) { <span class="keywordflow">return</span> (InterlockedCompareExchangePointer((<span class="keywordtype">void</span>* <span class="keyword">volatile</span>*)dst, val, ref) == ref) ? 1 : 0; }</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160; </div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="preprocessor">#define EXPECTED(x) (x)</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="preprocessor">#define UNEXPECTED(x) (x)</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; </div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160; </div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="preprocessor">#include &lt;stdatomic.h&gt;</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160; </div>
<div class="line"><a name="l00220"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">  220</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a>(int32_t) atomic32_t;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a>(int64_t) atomic64_t;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keyword">typedef</span> <span class="keyword">volatile</span> <a class="code" href="rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a>(<span class="keywordtype">void</span>*) atomicptr_t;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t atomic_load32(atomic32_t* src) { <span class="keywordflow">return</span> <a class="code" href="ringbuf__utils_8h.html#ac51df1d84ac23ed8f656f9fbc3f66363">atomic_load_explicit</a>(src, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00225"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">  225</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(atomic32_t* dst, int32_t val) { <a class="code" href="ringbuf__utils_8h.html#a97d09c5205f08d3094379e5555289ab0">atomic_store_explicit</a>(dst, val, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00226"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">  226</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t <a class="code" href="rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(atomic32_t* val) { <span class="keywordflow">return</span> atomic_fetch_add_explicit(val, 1, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>) + 1; }</div>
<div class="line"><a name="l00227"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">  227</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t <a class="code" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(atomic32_t* val) { <span class="keywordflow">return</span> atomic_fetch_add_explicit(val, -1, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>) - 1; }</div>
<div class="line"><a name="l00228"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">  228</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int32_t <a class="code" href="rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(atomic32_t* val, int32_t add) { <span class="keywordflow">return</span> atomic_fetch_add_explicit(val, add, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>) + add; }</div>
<div class="line"><a name="l00229"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">  229</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span>     <a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(atomic32_t* dst, int32_t val, int32_t ref) { <span class="keywordflow">return</span> atomic_compare_exchange_weak_explicit(dst, &amp;ref, val, <a class="code" href="ringbuf__utils_8h.html#a79e2a618fa655a8bb4dcfc585dfc1780">memory_order_acquire</a>, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00230"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">  230</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(atomic32_t* dst, int32_t val) { <a class="code" href="ringbuf__utils_8h.html#a97d09c5205f08d3094379e5555289ab0">atomic_store_explicit</a>(dst, val, <a class="code" href="ringbuf__utils_8h.html#aa1c16a769601f3748a5839b20e6bd80e">memory_order_release</a>); }</div>
<div class="line"><a name="l00231"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">  231</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int64_t <a class="code" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(atomic64_t* val) { <span class="keywordflow">return</span> <a class="code" href="ringbuf__utils_8h.html#ac51df1d84ac23ed8f656f9fbc3f66363">atomic_load_explicit</a>(val, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00232"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">  232</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> int64_t <a class="code" href="rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">atomic_add64</a>(atomic64_t* val, int64_t add) { <span class="keywordflow">return</span> atomic_fetch_add_explicit(val, add, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>) + add; }</div>
<div class="line"><a name="l00233"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">  233</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>*   <a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(atomicptr_t* src) { <span class="keywordflow">return</span> <a class="code" href="ringbuf__utils_8h.html#ac51df1d84ac23ed8f656f9fbc3f66363">atomic_load_explicit</a>(src, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00234"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">  234</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">atomic_store_ptr</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val) { <a class="code" href="ringbuf__utils_8h.html#a97d09c5205f08d3094379e5555289ab0">atomic_store_explicit</a>(dst, val, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00235"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">  235</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>    <a class="code" href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val) { <a class="code" href="ringbuf__utils_8h.html#a97d09c5205f08d3094379e5555289ab0">atomic_store_explicit</a>(dst, val, <a class="code" href="ringbuf__utils_8h.html#aa1c16a769601f3748a5839b20e6bd80e">memory_order_release</a>); }</div>
<div class="line"><a name="l00236"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">  236</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">void</span>*   <a class="code" href="rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val) { <span class="keywordflow">return</span> atomic_exchange_explicit(dst, val, <a class="code" href="ringbuf__utils_8h.html#a79e2a618fa655a8bb4dcfc585dfc1780">memory_order_acquire</a>); }</div>
<div class="line"><a name="l00237"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">  237</a></span>&#160;<span class="keyword">static</span> <a class="code" href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a> <span class="keywordtype">int</span>     <a class="code" href="rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(atomicptr_t* dst, <span class="keywordtype">void</span>* val, <span class="keywordtype">void</span>* ref) { <span class="keywordflow">return</span> atomic_compare_exchange_weak_explicit(dst, &amp;ref, val, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>, <a class="code" href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a>); }</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; </div>
<div class="line"><a name="l00239"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">  239</a></span>&#160;<span class="preprocessor">#define EXPECTED(x) __builtin_expect((x), 1)</span></div>
<div class="line"><a name="l00240"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">  240</a></span>&#160;<span class="preprocessor">#define UNEXPECTED(x) __builtin_expect((x), 0)</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;    </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160; </div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_inc(counter) atomic_incr32(counter)</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_dec(counter) atomic_decr32(counter)</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_add(counter, value) atomic_add32(counter, (int32_t)(value))</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_add64(counter, value) atomic_add64(counter, (int64_t)(value))</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_add_peak(counter, value, peak) do { int32_t _cur_count = atomic_add32(counter, (int32_t)(value)); if (_cur_count &gt; (peak)) peak = _cur_count; } while (0)</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_sub(counter, value) atomic_add32(counter, -(int32_t)(value))</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_inc_alloc(heap, class_idx) do { \</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="preprocessor">    int32_t alloc_current = atomic_incr32(&amp;heap-&gt;size_class_use[class_idx].alloc_current); \</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="preprocessor">    if (alloc_current &gt; heap-&gt;size_class_use[class_idx].alloc_peak) \</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor">        heap-&gt;size_class_use[class_idx].alloc_peak = alloc_current; \</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor">    atomic_incr32(&amp;heap-&gt;size_class_use[class_idx].alloc_total); \</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="preprocessor">} while(0)</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_inc_free(heap, class_idx) do { \</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">    atomic_decr32(&amp;heap-&gt;size_class_use[class_idx].alloc_current); \</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor">    atomic_incr32(&amp;heap-&gt;size_class_use[class_idx].free_total); \</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="preprocessor">} while(0)</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00268"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">  268</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_inc(counter) do {} while(0)</span></div>
<div class="line"><a name="l00269"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">  269</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_dec(counter) do {} while(0)</span></div>
<div class="line"><a name="l00270"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">  270</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_add(counter, value) do {} while(0)</span></div>
<div class="line"><a name="l00271"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">  271</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_add64(counter, value) do {} while(0)</span></div>
<div class="line"><a name="l00272"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">  272</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_add_peak(counter, value, peak) do {} while (0)</span></div>
<div class="line"><a name="l00273"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">  273</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_sub(counter, value) do {} while(0)</span></div>
<div class="line"><a name="l00274"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">  274</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_inc_alloc(heap, class_idx) do {} while(0)</span></div>
<div class="line"><a name="l00275"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ab3168e56cb172bc471c410e9daaf7ca1">  275</a></span>&#160;<span class="preprocessor">#  define _rpmalloc_stat_inc_free(heap, class_idx) do {} while(0)</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160; </div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160; </div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">  284</a></span>&#160;<span class="preprocessor">#define SMALL_GRANULARITY         16</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="preprocessor">#define SMALL_GRANULARITY_SHIFT   4</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="preprocessor">#define SMALL_CLASS_COUNT         65</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#define SMALL_SIZE_LIMIT          (SMALL_GRANULARITY * (SMALL_CLASS_COUNT - 1))</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="preprocessor">#define MEDIUM_GRANULARITY        512</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor">#define MEDIUM_GRANULARITY_SHIFT  9</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="preprocessor">#define MEDIUM_CLASS_COUNT        61</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#define SIZE_CLASS_COUNT          (SMALL_CLASS_COUNT + MEDIUM_CLASS_COUNT)</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor">#define LARGE_CLASS_COUNT         63</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor">#define MEDIUM_SIZE_LIMIT         (SMALL_SIZE_LIMIT + (MEDIUM_GRANULARITY * MEDIUM_CLASS_COUNT))</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="preprocessor">#define LARGE_SIZE_LIMIT          ((LARGE_CLASS_COUNT * _memory_span_size) - SPAN_HEADER_SIZE)</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="preprocessor">#define SPAN_HEADER_SIZE          128</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="preprocessor">#define MAX_THREAD_SPAN_CACHE     256</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="preprocessor">#define THREAD_SPAN_CACHE_TRANSFER 64</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="preprocessor">#define MAX_THREAD_SPAN_LARGE_CACHE 64</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="preprocessor">#define THREAD_SPAN_LARGE_CACHE_TRANSFER 6</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160; </div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<a class="code" href="rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>((<a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a> &amp; (<a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a> - 1)) == 0, <span class="stringliteral">&quot;Small granularity must be power of two&quot;</span>);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<a class="code" href="rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>((<a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> &amp; (<a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> - 1)) == 0, <span class="stringliteral">&quot;Span header size must be power of two&quot;</span>);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160; </div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="preprocessor">#undef  MAX_ALLOC_SIZE</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="preprocessor">#define MAX_ALLOC_SIZE            (((size_t)-1) - _memory_span_size)</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160; </div>
<div class="line"><a name="l00325"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">  325</a></span>&#160;<span class="preprocessor">#define pointer_offset(ptr, ofs) (void*)((char*)(ptr) + (ptrdiff_t)(ofs))</span></div>
<div class="line"><a name="l00326"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">  326</a></span>&#160;<span class="preprocessor">#define pointer_diff(first, second) (ptrdiff_t)((const char*)(first) - (const char*)(second))</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">  328</a></span>&#160;<span class="preprocessor">#define INVALID_POINTER ((void*)((uintptr_t)-1))</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160; </div>
<div class="line"><a name="l00330"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">  330</a></span>&#160;<span class="preprocessor">#define SIZE_CLASS_LARGE SIZE_CLASS_COUNT</span></div>
<div class="line"><a name="l00331"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">  331</a></span>&#160;<span class="preprocessor">#define SIZE_CLASS_HUGE ((uint32_t)-1)</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160; </div>
<div class="line"><a name="l00340"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a75c19bcef00dee4542c1ddab212e29a8">  340</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structheap__t.html">heap_t</a> <a class="code" href="structheap__t.html">heap_t</a>;</div>
<div class="line"><a name="l00342"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aa34fdcc23a2d119e7436a33e05ddb665">  342</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structspan__t.html">span_t</a> <a class="code" href="structspan__t.html">span_t</a>;</div>
<div class="line"><a name="l00344"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">  344</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">span_list_t</a> <a class="code" href="rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">span_list_t</a>;</div>
<div class="line"><a name="l00346"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">  346</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">span_active_t</a> <a class="code" href="rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">span_active_t</a>;</div>
<div class="line"><a name="l00348"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a58b8a67689d7a172819769e39f933e66">  348</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structsize__class__t.html">size_class_t</a> <a class="code" href="structsize__class__t.html">size_class_t</a>;</div>
<div class="line"><a name="l00350"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#abb5df2e5e21b2980d57f68200c97da21">  350</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structglobal__cache__t.html">global_cache_t</a> <a class="code" href="structglobal__cache__t.html">global_cache_t</a>;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; </div>
<div class="line"><a name="l00353"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">  353</a></span>&#160;<span class="preprocessor">#define SPAN_FLAG_MASTER 1U</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="preprocessor">#define SPAN_FLAG_SUBSPAN 2U</span></div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;<span class="preprocessor">#define SPAN_FLAG_ALIGNED_BLOCKS 4U</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160; </div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keyword">struct </span>span_use_t {</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    atomic32_t current;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    atomic32_t high;</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    atomic32_t spans_to_global;</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    atomic32_t spans_from_global;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    atomic32_t spans_to_cache;</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    atomic32_t spans_from_cache;</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    atomic32_t spans_to_reserved;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    atomic32_t spans_from_reserved;</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    atomic32_t spans_map_calls;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;};</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>span_use_t span_use_t;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160; </div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="keyword">struct </span>size_class_use_t {</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    atomic32_t alloc_current;</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    int32_t alloc_peak;</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;    atomic32_t alloc_total;</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    atomic32_t free_total;</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;    atomic32_t spans_current;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    int32_t spans_peak;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;    atomic32_t spans_to_cache;</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;    atomic32_t spans_from_cache;</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;    atomic32_t spans_from_reserved;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    atomic32_t spans_map_calls;</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    int32_t unused;</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;};</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span>size_class_use_t size_class_use_t;</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160; </div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;<span class="comment">// A span can either represent a single span of memory pages with size declared by span_map_count configuration variable,</span></div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;<span class="comment">// or a set of spans in a continuous region, a super span. Any reference to the term &quot;span&quot; usually refers to both a single</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;<span class="comment">// span or a super span. A super span can further be divided into multiple spans (or this, super spans), where the first</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;<span class="comment">// (super)span is the master and subsequent (super)spans are subspans. The master span keeps track of how many subspans</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">// that are still alive and mapped in virtual memory, and once all subspans and master have been unmapped the entire</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="comment">// superspan region is released and unmapped (on Windows for example, the entire superspan range has to be released</span></div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;<span class="comment">// in the same call to release the virtual memory range, but individual subranges can be decommitted individually</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;<span class="comment">// to reduce physical memory use).</span></div>
<div class="line"><a name="l00420"></a><span class="lineno"><a class="line" href="structspan__t.html">  420</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structspan__t.html">span_t</a> {</div>
<div class="line"><a name="l00422"></a><span class="lineno"><a class="line" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">  422</a></span>&#160;    <span class="keywordtype">void</span>*       <a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l00424"></a><span class="lineno"><a class="line" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">  424</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>;</div>
<div class="line"><a name="l00426"></a><span class="lineno"><a class="line" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">  426</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>;</div>
<div class="line"><a name="l00428"></a><span class="lineno"><a class="line" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">  428</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l00430"></a><span class="lineno"><a class="line" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">  430</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>;</div>
<div class="line"><a name="l00432"></a><span class="lineno"><a class="line" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">  432</a></span>&#160;    atomicptr_t <a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>;</div>
<div class="line"><a name="l00434"></a><span class="lineno"><a class="line" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">  434</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l00436"></a><span class="lineno"><a class="line" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">  436</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>;</div>
<div class="line"><a name="l00438"></a><span class="lineno"><a class="line" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">  438</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a>;</div>
<div class="line"><a name="l00440"></a><span class="lineno"><a class="line" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">  440</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l00442"></a><span class="lineno"><a class="line" href="structspan__t.html#af32dc4254a995d8ba3ab99376c9ad4d0">  442</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a>;</div>
<div class="line"><a name="l00444"></a><span class="lineno"><a class="line" href="structspan__t.html#a07d2ba73260e7e5dbe98c76436888c5f">  444</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a>;</div>
<div class="line"><a name="l00446"></a><span class="lineno"><a class="line" href="structspan__t.html#a4aecbd1cbb36425fddd53125ea1a84c7">  446</a></span>&#160;    atomic32_t  <a class="code" href="structspan__t.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>;</div>
<div class="line"><a name="l00448"></a><span class="lineno"><a class="line" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">  448</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>    <a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a>;</div>
<div class="line"><a name="l00450"></a><span class="lineno"><a class="line" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">  450</a></span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>*     <a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>;</div>
<div class="line"><a name="l00452"></a><span class="lineno"><a class="line" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">  452</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*     <a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00454"></a><span class="lineno"><a class="line" href="structspan__t.html#a386f776cc556d33534161ece5083e4de">  454</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*     <a class="code" href="structspan__t.html#a386f776cc556d33534161ece5083e4de">prev</a>;</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;};</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<a class="code" href="rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>(<span class="keyword">sizeof</span>(<a class="code" href="structspan__t.html">span_t</a>) &lt;= <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>, <span class="stringliteral">&quot;span size mismatch&quot;</span>);</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160; </div>
<div class="line"><a name="l00458"></a><span class="lineno"><a class="line" href="structspan__cache__t.html">  458</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structspan__cache__t.html">span_cache_t</a> {</div>
<div class="line"><a name="l00459"></a><span class="lineno"><a class="line" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">  459</a></span>&#160;    <span class="keywordtype">size_t</span>       <a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>;</div>
<div class="line"><a name="l00460"></a><span class="lineno"><a class="line" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">  460</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      <a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[<a class="code" href="rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a>];</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;};</div>
<div class="line"><a name="l00462"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aece665fc81eaec031382485a4a2ea5b7">  462</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structspan__cache__t.html">span_cache_t</a> <a class="code" href="structspan__cache__t.html">span_cache_t</a>;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160; </div>
<div class="line"><a name="l00464"></a><span class="lineno"><a class="line" href="structspan__large__cache__t.html">  464</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structspan__large__cache__t.html">span_large_cache_t</a> {</div>
<div class="line"><a name="l00465"></a><span class="lineno"><a class="line" href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">  465</a></span>&#160;    <span class="keywordtype">size_t</span>       <a class="code" href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a>;</div>
<div class="line"><a name="l00466"></a><span class="lineno"><a class="line" href="structspan__large__cache__t.html#a77eff1faca249ec6ae27881769f7d979">  466</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      <a class="code" href="structspan__large__cache__t.html#a77eff1faca249ec6ae27881769f7d979">span</a>[<a class="code" href="rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a>];</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;};</div>
<div class="line"><a name="l00468"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a8e7b9e9139e15a9faa403425e19b0c13">  468</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structspan__large__cache__t.html">span_large_cache_t</a> <a class="code" href="structspan__large__cache__t.html">span_large_cache_t</a>;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160; </div>
<div class="line"><a name="l00470"></a><span class="lineno"><a class="line" href="structheap__size__class__t.html">  470</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structheap__size__class__t.html">heap_size_class_t</a> {</div>
<div class="line"><a name="l00472"></a><span class="lineno"><a class="line" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">  472</a></span>&#160;    <span class="keywordtype">void</span>*        <a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>;</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    <span class="comment">//  Previous span pointer in head points to tail span of list.</span></div>
<div class="line"><a name="l00475"></a><span class="lineno"><a class="line" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">  475</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      <a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l00477"></a><span class="lineno"><a class="line" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">  477</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      <a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>;</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;};</div>
<div class="line"><a name="l00479"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a10712f237da38c0bbb00bf9693dd9f6d">  479</a></span>&#160;<span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structheap__size__class__t.html">heap_size_class_t</a> <a class="code" href="structheap__size__class__t.html">heap_size_class_t</a>;</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="comment">// Control structure for a heap, either a thread heap or a first class heap if enabled</span></div>
<div class="line"><a name="l00482"></a><span class="lineno"><a class="line" href="structheap__t.html">  482</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structheap__t.html">heap_t</a> {</div>
<div class="line"><a name="l00484"></a><span class="lineno"><a class="line" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">  484</a></span>&#160;    uintptr_t    <a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a>;</div>
<div class="line"><a name="l00486"></a><span class="lineno"><a class="line" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">  486</a></span>&#160;    <a class="code" href="structheap__size__class__t.html">heap_size_class_t</a> <a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[<a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    <a class="code" href="structspan__cache__t.html">span_cache_t</a> <a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    atomicptr_t  <a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>;</div>
<div class="line"><a name="l00494"></a><span class="lineno"><a class="line" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">  494</a></span>&#160;    <span class="keywordtype">size_t</span>       <a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l00496"></a><span class="lineno"><a class="line" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">  496</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      <a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>;</div>
<div class="line"><a name="l00498"></a><span class="lineno"><a class="line" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">  498</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      <a class="code" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a>;</div>
<div class="line"><a name="l00500"></a><span class="lineno"><a class="line" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">  500</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>     <a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>;</div>
<div class="line"><a name="l00502"></a><span class="lineno"><a class="line" href="structheap__t.html#a59fb66e831ef1e0d56d826b1851576eb">  502</a></span>&#160;    atomic32_t   <a class="code" href="structheap__t.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>;</div>
<div class="line"><a name="l00504"></a><span class="lineno"><a class="line" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">  504</a></span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>*      <a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l00506"></a><span class="lineno"><a class="line" href="structheap__t.html#a87e83453c93d1e6de70f6a45044e510d">  506</a></span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>*      <a class="code" href="structheap__t.html#a87e83453c93d1e6de70f6a45044e510d">next_orphan</a>;</div>
<div class="line"><a name="l00508"></a><span class="lineno"><a class="line" href="structheap__t.html#ac4c9ca5afe45b09eb1ed79a98d308316">  508</a></span>&#160;    <span class="keywordtype">size_t</span>       <a class="code" href="structheap__t.html#ac4c9ca5afe45b09eb1ed79a98d308316">align_offset</a>;</div>
<div class="line"><a name="l00510"></a><span class="lineno"><a class="line" href="structheap__t.html#a2342224142317f85fca91614fc973131">  510</a></span>&#160;    int32_t      <a class="code" href="structheap__t.html#a2342224142317f85fca91614fc973131">id</a>;</div>
<div class="line"><a name="l00512"></a><span class="lineno"><a class="line" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">  512</a></span>&#160;    <span class="keywordtype">int</span>          <a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l00514"></a><span class="lineno"><a class="line" href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">  514</a></span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>*      <a class="code" href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>;</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    <a class="code" href="structspan__large__cache__t.html">span_large_cache_t</a> <a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a>[<a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a> - 1];</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;    <span class="comment">//  Previous span pointer in head points to tail span of list.</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      full_span[<a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>*      large_huge_span;</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    span_use_t   span_use[<a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;    size_class_use_t size_class_use[<a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a> + 1];</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;    atomic64_t   thread_to_global;</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    atomic64_t   global_to_thread;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;};</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160; </div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">// Size class for defining a block size bucket</span></div>
<div class="line"><a name="l00541"></a><span class="lineno"><a class="line" href="structsize__class__t.html">  541</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structsize__class__t.html">size_class_t</a> {</div>
<div class="line"><a name="l00543"></a><span class="lineno"><a class="line" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">  543</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l00545"></a><span class="lineno"><a class="line" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">  545</a></span>&#160;    uint16_t <a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>;</div>
<div class="line"><a name="l00547"></a><span class="lineno"><a class="line" href="structsize__class__t.html#a7524fc81b83a0b54ef5ec3fb4563b69d">  547</a></span>&#160;    uint16_t <a class="code" href="structsize__class__t.html#a7524fc81b83a0b54ef5ec3fb4563b69d">class_idx</a>;</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;};</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;<a class="code" href="rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a>(<span class="keyword">sizeof</span>(<a class="code" href="structsize__class__t.html">size_class_t</a>) == 8, <span class="stringliteral">&quot;Size class size mismatch&quot;</span>);</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160; </div>
<div class="line"><a name="l00551"></a><span class="lineno"><a class="line" href="structglobal__cache__t.html">  551</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structglobal__cache__t.html">global_cache_t</a> {</div>
<div class="line"><a name="l00553"></a><span class="lineno"><a class="line" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">  553</a></span>&#160;    atomic32_t <a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>;</div>
<div class="line"><a name="l00555"></a><span class="lineno"><a class="line" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">  555</a></span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> <a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>;</div>
<div class="line"><a name="l00557"></a><span class="lineno"><a class="line" href="structglobal__cache__t.html#a9d6636075b348ce9cbd7e59e45d097c7">  557</a></span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* <a class="code" href="structglobal__cache__t.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a>[<a class="code" href="rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a> * <a class="code" href="rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a>];</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;<span class="preprocessor">#if ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* overflow;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;};</div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160; </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160; </div>
<div class="line"><a name="l00571"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a04a025a8c2529bc60cb95c78d3948c52">  571</a></span>&#160;<span class="preprocessor">#define _memory_default_span_size (64 * 1024)</span></div>
<div class="line"><a name="l00572"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a3dedf1d71cda4a8f3d1f372934ddad30">  572</a></span>&#160;<span class="preprocessor">#define _memory_default_span_size_shift 16</span></div>
<div class="line"><a name="l00573"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ada0a343b3498bb882ebd7e0c3caa0935">  573</a></span>&#160;<span class="preprocessor">#define _memory_default_span_mask (~((uintptr_t)(_memory_span_size - 1)))</span></div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; </div>
<div class="line"><a name="l00576"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">  576</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a>;</div>
<div class="line"><a name="l00578"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">  578</a></span>&#160;<span class="keyword">static</span> <a class="code" href="structrpmalloc__config__t.html">rpmalloc_config_t</a> <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>;</div>
<div class="line"><a name="l00580"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">  580</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l00582"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">  582</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l00584"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">  584</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>;</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="preprocessor">#if RPMALLOC_CONFIGURABLE</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="keyword">static</span> uintptr_t <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>;</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;<span class="preprocessor">#define _memory_span_size _memory_default_span_size</span></div>
<div class="line"><a name="l00595"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">  595</a></span>&#160;<span class="preprocessor">#define _memory_span_size_shift _memory_default_span_size_shift</span></div>
<div class="line"><a name="l00596"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">  596</a></span>&#160;<span class="preprocessor">#define _memory_span_mask _memory_default_span_mask</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l00601"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a03eedb1d5d48520b6ec939744051f9ee">  601</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a03eedb1d5d48520b6ec939744051f9ee">_memory_span_release_count</a>;</div>
<div class="line"><a name="l00603"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a95516c8eac47786193b7172bed4a3ef7">  603</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a95516c8eac47786193b7172bed4a3ef7">_memory_span_release_count_large</a>;</div>
<div class="line"><a name="l00605"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">  605</a></span>&#160;<span class="keyword">static</span> <a class="code" href="structsize__class__t.html">size_class_t</a> <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[<a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00607"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">  607</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>;</div>
<div class="line"><a name="l00609"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">  609</a></span>&#160;<span class="keyword">static</span> atomic32_t <a class="code" href="rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">_memory_heap_id</a>;</div>
<div class="line"><a name="l00611"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">  611</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a>;</div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="keyword">static</span> <a class="code" href="structglobal__cache__t.html">global_cache_t</a> <a class="code" href="rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[<a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>];</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="keyword">static</span> <a class="code" href="structheap__t.html">heap_t</a>* <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[<a class="code" href="rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>];</div>
<div class="line"><a name="l00619"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">  619</a></span>&#160;<span class="keyword">static</span> atomic32_t <a class="code" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a>;</div>
<div class="line"><a name="l00621"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">  621</a></span>&#160;<span class="keyword">static</span> <a class="code" href="structheap__t.html">heap_t</a>* <a class="code" href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>;</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="keyword">static</span> <a class="code" href="structheap__t.html">heap_t</a>* _memory_first_class_orphan_heaps;</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="keyword">static</span> atomic32_t _memory_active_heaps;</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="keyword">static</span> atomic32_t _mapped_pages;</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;<span class="keyword">static</span> int32_t _mapped_pages_peak;</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;<span class="keyword">static</span> atomic32_t _master_spans;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;<span class="keyword">static</span> atomic32_t _reserved_spans;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="keyword">static</span> atomic32_t _mapped_total;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="keyword">static</span> atomic32_t _unmapped_total;</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;<span class="keyword">static</span> atomic32_t _mapped_pages_os;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;<span class="keyword">static</span> atomic32_t _huge_pages_current;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="keyword">static</span> int32_t _huge_pages_peak;</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160; </div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160; </div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;<span class="preprocessor">#if (defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;<span class="keyword">static</span> pthread_key_t _memory_thread_heap;</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="preprocessor">#  ifdef _MSC_VER</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;<span class="preprocessor">#    define _Thread_local __declspec(thread)</span></div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;<span class="preprocessor">#    define TLS_MODEL</span></div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="preprocessor">#  else</span></div>
<div class="line"><a name="l00663"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a3cf2ef5bd78a81c297328a5534f0ddf4">  663</a></span>&#160;<span class="preprocessor">#    define TLS_MODEL __attribute__((tls_model(&quot;initial-exec&quot;)))</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;<span class="preprocessor">#    if !defined(__clang__) &amp;&amp; defined(__GNUC__)</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="preprocessor">#      define _Thread_local __thread</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="preprocessor">#    endif</span></div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00668"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae1964ae1d59012d78e56e6eedb86c58c">  668</a></span>&#160;<span class="keyword">static</span> _Thread_local <a class="code" href="structheap__t.html">heap_t</a>* _memory_thread_heap <a class="code" href="rpmalloc_8c.html#a3cf2ef5bd78a81c297328a5534f0ddf4">TLS_MODEL</a>;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160; </div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structheap__t.html">heap_t</a>*</div>
<div class="line"><a name="l00672"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">  672</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;<span class="preprocessor">#if (defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    <span class="keywordflow">return</span> pthread_getspecific(_memory_thread_heap);</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    <span class="keywordflow">return</span> _memory_thread_heap;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;}</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="structheap__t.html">heap_t</a>*</div>
<div class="line"><a name="l00682"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">  682</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;<span class="preprocessor">#if ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(heap != 0))</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;        <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    <a class="code" href="rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5">rpmalloc_initialize</a>();</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;}</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160; </div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;<span class="keyword">static</span> <span class="keyword">inline</span> uintptr_t </div>
<div class="line"><a name="l00696"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">  696</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="preprocessor">#if defined(_WIN32)</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="keywordflow">return</span> (uintptr_t)((<span class="keywordtype">void</span>*)NtCurrentTeb());</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;<span class="preprocessor">#elif defined(__GNUC__) || defined(__clang__)</span></div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    uintptr_t tid;</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;<span class="preprocessor">#  if defined(__i386__)</span></div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;    __asm__(<span class="stringliteral">&quot;movl %%gs:0, %0&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span> (tid) : : );</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;<span class="preprocessor">#  elif defined(__MACH__) &amp;&amp; !TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;    __asm__(<span class="stringliteral">&quot;movq %%gs:0, %0&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span> (tid) : : );</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;<span class="preprocessor">#  elif defined(__x86_64__)</span></div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    __asm__(<span class="stringliteral">&quot;movq %%fs:0, %0&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span> (tid) : : );</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;<span class="preprocessor">#  elif defined(__arm__)</span></div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;    __asm__ <span class="keyword">volatile</span> (<span class="stringliteral">&quot;mrc p15, 0, %0, c13, c0, 3&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span> (tid));</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;<span class="preprocessor">#  elif defined(__aarch64__)</span></div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;    __asm__ <span class="keyword">volatile</span> (<span class="stringliteral">&quot;mrs %0, tpidr_el0&quot;</span> : <span class="stringliteral">&quot;=r&quot;</span> (tid));</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="preprocessor">#  else</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;    tid = (uintptr_t)((<span class="keywordtype">void</span>*)<a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>());</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;    <span class="keywordflow">return</span> tid;</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;    <span class="keywordflow">return</span> (uintptr_t)((<span class="keywordtype">void</span>*)<a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>());</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;}</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160; </div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00722"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">  722</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap) {</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="preprocessor">#if (defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD</span></div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;    pthread_setspecific(_memory_thread_heap, heap);</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    _memory_thread_heap = heap;</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> = <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>();</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;}</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160; </div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;<span class="comment">//  size is number of bytes to map</span></div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="comment">//  offset receives the offset in bytes from start of mapped region</span></div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment">//  returns address to start of mapped region to use</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l00743"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">  743</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(<span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span>* offset) {</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!(size % <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>));</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(size &gt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <a class="code" href="rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;_mapped_pages, (size &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>), _mapped_pages_peak);</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_mapped_total, (size &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">memory_map</a>(size, offset);</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;}</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160; </div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="comment">//  address is the memory address to unmap, as returned from _memory_map</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">//  size is the number of bytes to unmap, which might be less than full region for a partial unmap</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;<span class="comment">//  offset is the offset in bytes to the actual mapped region, as set by _memory_map</span></div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;<span class="comment">//  release is set to 0 for partial unmap, or size of entire range for a full unmap</span></div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00757"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">  757</a></span>&#160;<a class="code" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(<span class="keywordtype">void</span>* address, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> offset, <span class="keywordtype">size_t</span> release) {</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!release || (release &gt;= size));</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!release || (release &gt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>));</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    <span class="keywordflow">if</span> (release) {</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!(release % <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>));</div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;        <a class="code" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_mapped_pages, (release &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;        <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_unmapped_total, (release &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    }</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">memory_unmap</a>(address, size, offset, release);</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;}</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l00770"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">  770</a></span>&#160;<a class="code" href="rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a>(<span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span>* offset) {</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    <span class="comment">//Either size is a heap (a single page) or a (multiple) span - we only need to align spans, and only if larger than map granularity</span></div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    <span class="keywordtype">size_t</span> padding = ((size &gt;= <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) &amp;&amp; (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> &gt; <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>)) ? <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> : 0;</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(size &gt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;    <span class="comment">//Ok to MEM_COMMIT - according to MSDN, &quot;actual physical pages are not allocated unless/until the virtual addresses are actually accessed&quot;</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordtype">void</span>* ptr = VirtualAlloc(0, size + padding, (<a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> ? MEM_LARGE_PAGES : 0) | MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;    <span class="keywordflow">if</span> (!ptr) {</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(ptr &amp;&amp; <span class="stringliteral">&quot;Failed to map virtual memory block&quot;</span>);</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;    }</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    <span class="keywordtype">int</span> flags = MAP_PRIVATE | MAP_ANONYMOUS | <a class="code" href="rpmalloc_8c.html#a14828817b96941a8a2ad71e2bb95143b">MAP_UNINITIALIZED</a>;</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">#  if defined(__APPLE__) &amp;&amp; !TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    <span class="keywordtype">int</span> fd = (int)VM_MAKE_TAG(240U);</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a>)</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;        fd |= VM_FLAGS_SUPERPAGE_SIZE_2MB;</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="keywordtype">void</span>* ptr = mmap(0, size + padding, PROT_READ | PROT_WRITE, flags, fd, 0);</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;<span class="preprocessor">#  elif defined(MAP_HUGETLB)</span></div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;    <span class="keywordtype">void</span>* ptr = mmap(0, size + padding, PROT_READ | PROT_WRITE, (<a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> ? MAP_HUGETLB : 0) | flags, -1, 0);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;<span class="preprocessor">#  elif defined(MAP_ALIGN)</span></div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    caddr_t base = (<a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> ? (caddr_t)(4 &lt;&lt; 20) : 0);</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="keywordtype">void</span>* ptr = mmap(base, size + padding, PROT_READ | PROT_WRITE, (<a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> ? MAP_ALIGN : 0) | flags, -1, 0);</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;<span class="preprocessor">#  else</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;    <span class="keywordtype">void</span>* ptr = mmap(0, size + padding, PROT_READ | PROT_WRITE, flags, -1, 0);</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;<span class="preprocessor">#  endif</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    <span class="keywordflow">if</span> ((ptr == MAP_FAILED) || !ptr) {</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<span class="stringliteral">&quot;Failed to map virtual memory block&quot;</span> == 0);</div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;    }</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_mapped_pages_os, (int32_t)((size + padding) &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>));</div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">if</span> (padding) {</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;        <span class="keywordtype">size_t</span> final_padding = padding - ((uintptr_t)ptr &amp; ~<a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(final_padding &lt;= <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(final_padding &lt;= padding);</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!(final_padding % 8));</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;        ptr = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(ptr, final_padding);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        *offset = final_padding &gt;&gt; 3;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    }</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((size &lt; <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) || !((uintptr_t)ptr &amp; ~<a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>));</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;}</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160; </div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00816"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">  816</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">_rpmalloc_unmap_os</a>(<span class="keywordtype">void</span>* address, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> offset, <span class="keywordtype">size_t</span> release) {</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(release || (offset == 0));</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!release || (release &gt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>));</div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(size &gt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;    <span class="keywordflow">if</span> (release &amp;&amp; offset) {</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;        offset &lt;&lt;= 3;</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;        address = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(address, -(int32_t)offset);</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;        <span class="keywordflow">if</span> ((release &gt;= <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) &amp;&amp; (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> &gt; <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>)) {</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;            <span class="comment">//Padding is always one span size</span></div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;            release += <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        }</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    }</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;<span class="preprocessor">#if !DISABLE_UNMAP</span></div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;    <span class="keywordflow">if</span> (!VirtualFree(address, release ? 0 : size, release ? MEM_RELEASE : MEM_DECOMMIT)) {</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(address &amp;&amp; <span class="stringliteral">&quot;Failed to unmap virtual memory block&quot;</span>);</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    }</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;    <span class="keywordflow">if</span> (release) {</div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;        <span class="keywordflow">if</span> (munmap(address, release)) {</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;            <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<span class="stringliteral">&quot;Failed to unmap virtual memory block&quot;</span> == 0);</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        }</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;    }</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;<span class="preprocessor">#if defined(POSIX_MADV_FREE)</span></div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        <span class="keywordflow">if</span> (posix_madvise(address, size, POSIX_MADV_FREE))</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        <span class="keywordflow">if</span> (posix_madvise(address, size, POSIX_MADV_DONTNEED)) {</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(<span class="stringliteral">&quot;Failed to madvise virtual memory block as free&quot;</span> == 0);</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        }</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    }</div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;    <span class="keywordflow">if</span> (release)</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;        <a class="code" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_mapped_pages_os, release &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>);</div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;}</div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160; </div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160; </div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160; </div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00862"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">  862</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(<a class="code" href="structspan__t.html">span_t</a>** head, <a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="keywordflow">if</span> (*head) {</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = *head;</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;        (*head)-&gt;<a class="code" href="structspan__t.html#a386f776cc556d33534161ece5083e4de">prev</a> = span;</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = 0;</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    }</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    *head = span;</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;}</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00874"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">  874</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">_rpmalloc_span_double_link_list_pop_head</a>(<a class="code" href="structspan__t.html">span_t</a>** head, <a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(*head == span);</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    span = *head;</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    *head = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;}</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160; </div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00882"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">  882</a></span>&#160;<a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(<a class="code" href="structspan__t.html">span_t</a>** head, <a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(*head);</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;    <span class="keywordflow">if</span> (*head == span) {</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;        *head = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* next_span = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* prev_span = span-&gt;<a class="code" href="structspan__t.html#a386f776cc556d33534161ece5083e4de">prev</a>;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        prev_span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = next_span;</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(next_span != 0)) {</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;            next_span-&gt;<a class="code" href="structspan__t.html#a386f776cc556d33534161ece5083e4de">prev</a> = prev_span;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;        }</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;    }</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;}</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160; </div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160; </div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160; </div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;<a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* span);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160; </div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;<a class="code" href="rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap);</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160; </div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;<a class="code" href="rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* master, <a class="code" href="structspan__t.html">span_t</a>* reserve, <span class="keywordtype">size_t</span> reserve_span_count);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160; </div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00914"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">  914</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(<a class="code" href="structspan__t.html">span_t</a>* master, <a class="code" href="structspan__t.html">span_t</a>* subspan, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((subspan != master) || (subspan-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>));</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    <span class="keywordflow">if</span> (subspan != master) {</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        subspan-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> = <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>;</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;        subspan-&gt;<a class="code" href="structspan__t.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)((uintptr_t)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(subspan, master) &gt;&gt; <a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a>);</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        subspan-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = 0;</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    }</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;    subspan-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;}</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160; </div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l00926"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">  926</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">_rpmalloc_span_map_from_reserve</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="comment">//Update the heap span reserve</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = heap-&gt;<a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>;</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a> = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, span_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> -= (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160; </div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;    <a class="code" href="rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(heap-&gt;<a class="code" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a>, span, span_count);</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    <span class="keywordflow">if</span> (span_count &lt;= <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>)</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_reserved);</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160; </div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;}</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160; </div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l00941"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">  941</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">_rpmalloc_span_align_count</a>(<span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    <span class="keywordtype">size_t</span> request_count = (span_count &gt; <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>) ? span_count : <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) &amp;&amp; ((request_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) % <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>))</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        request_count += <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> - (request_count % <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>); </div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    <span class="keywordflow">return</span> request_count;</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;}</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160; </div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00950"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">  950</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a>(<a class="code" href="structspan__t.html">span_t</a>* span, <span class="keywordtype">size_t</span> total_span_count, <span class="keywordtype">size_t</span> span_count, <span class="keywordtype">size_t</span> align_offset) {</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)total_span_count;</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count;</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)align_offset;</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> = <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>;</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>, (int32_t)total_span_count);</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;}</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160; </div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l00960"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">  960</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">_rpmalloc_span_map_aligned_count</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    <span class="comment">//If we already have some, but not enough, reserved spans, release those to heap cache and map a new</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="comment">//full set of spans. Otherwise we would waste memory if page size &gt; span size (huge pages)</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;    <span class="keywordtype">size_t</span> aligned_span_count = <a class="code" href="rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">_rpmalloc_span_align_count</a>(span_count);</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    <span class="keywordtype">size_t</span> align_offset = 0;</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(aligned_span_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>, &amp;align_offset);</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;    <a class="code" href="rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a>(span, aligned_span_count, span_count, align_offset);</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;_reserved_spans, aligned_span_count);</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_master_spans);</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;    <span class="keywordflow">if</span> (span_count &lt;= <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>)</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_map_calls);</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    <span class="keywordflow">if</span> (aligned_span_count &gt; span_count) {</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* reserved_spans = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, span_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        <span class="keywordtype">size_t</span> reserved_count = aligned_span_count - span_count;</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>) {</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;            <a class="code" href="rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a>(heap-&gt;<a class="code" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a>, heap-&gt;<a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>, heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>);</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;            <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, heap-&gt;<a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a>);</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        }</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        <a class="code" href="rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(heap, span, reserved_spans, reserved_count);</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;    }</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;}</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160; </div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l00987"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">  987</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;    <span class="keywordflow">if</span> (span_count &lt;= heap-&gt;spans_reserved)</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">_rpmalloc_span_map_from_reserve</a>(heap, span_count);</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">_rpmalloc_span_map_aligned_count</a>(heap, span_count);</div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;}</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160; </div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l00995"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">  995</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(<a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || (span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>));</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!(span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || !(span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>));</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160; </div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    <span class="keywordtype">int</span> is_master = !!(span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>);</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* master = is_master ? span : ((<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, -(intptr_t)((uintptr_t)span-&gt;<a class="code" href="structspan__t.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>)));</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(is_master || (span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>));</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(master-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>);</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160; </div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    <span class="keywordtype">size_t</span> span_count = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">if</span> (!is_master) {</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;        <span class="comment">//Directly unmap subspans (unless huge pages, in which case we defer and unmap entire page range with master)</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> == 0);</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> &gt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) {</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;            <a class="code" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(span, span_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>, 0, 0);</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;            <a class="code" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_reserved_spans, span_count);</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        }</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;        <span class="comment">//Special double flag to denote an unmapped master</span></div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;        <span class="comment">//It must be kept in memory since span header must be used</span></div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> |= <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a> | <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>;</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    }</div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160; </div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a>(&amp;master-&gt;<a class="code" href="structspan__t.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>, -(int32_t)span_count) &lt;= 0) {</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <span class="comment">//Everything unmapped, unmap the master span with release flag to unmap the entire range of the super span</span></div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!!(master-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) &amp;&amp; !!(master-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>));</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;        <span class="keywordtype">size_t</span> unmap_count = master-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> &lt; <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;            unmap_count = master-&gt;<a class="code" href="structspan__t.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a>;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;        <a class="code" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_reserved_spans, unmap_count);</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        <a class="code" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_master_spans, 1);</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        <a class="code" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(master, unmap_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>, master-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a>, (<span class="keywordtype">size_t</span>)master-&gt;<a class="code" href="structspan__t.html#af32dc4254a995d8ba3ab99376c9ad4d0">total_spans</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;    }</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;}</div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160; </div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01032"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947"> 1032</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947">_rpmalloc_span_release_to_cache</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap == span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>);</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>);</div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;heap-&gt;span_use[0].current);</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;    <a class="code" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;size_class_use[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].spans_current);</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;    <span class="keywordflow">if</span> (!heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>) {</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[0].spans_to_cache);</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].spans_to_cache);</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>)</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;            <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>);</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a> = span;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    }</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;}</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160; </div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="keyword">static</span> <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div>
<div class="line"><a name="l01053"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816"> 1053</a></span>&#160;<a class="code" href="rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a>(<span class="keywordtype">void</span>** list, <span class="keywordtype">void</span>** first_block, <span class="keywordtype">void</span>* page_start, <span class="keywordtype">void</span>* block_start,</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;                       <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_count, <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_size) {</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(block_count);</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;    *first_block = block_start;</div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">if</span> (block_count &gt; 1) {</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;        <span class="keywordtype">void</span>* free_block = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(block_start, block_size);</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;        <span class="keywordtype">void</span>* block_end = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(block_start, (<span class="keywordtype">size_t</span>)block_size * block_count);</div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;        <span class="comment">//If block size is less than half a memory page, bound init to next memory page boundary</span></div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;        <span class="keywordflow">if</span> (block_size &lt; (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt;&gt; 1)) {</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;            <span class="keywordtype">void</span>* page_end = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(page_start, <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;            <span class="keywordflow">if</span> (page_end &lt; block_end)</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;                block_end = page_end;</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;        }</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;        *list = free_block;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;        block_count = 2;</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;        <span class="keywordtype">void</span>* next_block = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(free_block, block_size);</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;        <span class="keywordflow">while</span> (next_block &lt; block_end) {</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;            *((<span class="keywordtype">void</span>**)free_block) = next_block;</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;            free_block = next_block;</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;            ++block_count;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;            next_block = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(next_block, block_size);</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;        }</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;        *((<span class="keywordtype">void</span>**)free_block) = 0;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;        *list = 0;</div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    }</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;    <span class="keywordflow">return</span> block_count;</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;}</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160; </div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01084"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ab6bd4a5eb2a9f92ae4b0042a31d215ed"> 1084</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ab6bd4a5eb2a9f92ae4b0042a31d215ed">_rpmalloc_span_initialize_new</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* span, <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx) {</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> == 1);</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;    <a class="code" href="structsize__class__t.html">size_class_t</a>* size_class = <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + class_idx;</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = class_idx;</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp;= ~<a class="code" href="rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a>;</div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> = size_class-&gt;<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a> = size_class-&gt;<a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>;</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = 0;</div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> = 0;</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;    <a class="code" href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, 0);</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160; </div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;    <span class="comment">//Setup free list. Only initialize one system page worth of free blocks in list</span></div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;    <span class="keywordtype">void</span>* block;</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> = <a class="code" href="rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>, &amp;block, </div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;        span, <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>), size_class-&gt;<a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>, size_class-&gt;<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>);</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;    <span class="comment">//Link span as partial if there remains blocks to be initialized as free list, or full if fully initialized</span></div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt; span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>) {</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;full_span[class_idx], span);</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;        ++heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>;</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;    }</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;}</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160; </div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01115"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e"> 1115</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e">_rpmalloc_span_extract_free_list_deferred</a>(<a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    <span class="comment">// We need acquire semantics on the CAS operation since we are interested in the list size</span></div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="comment">// Refer to _rpmalloc_deallocate_defer_small_or_medium for further comments on this dependency</span></div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;    <span class="keywordflow">do</span> {</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = <a class="code" href="rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, <a class="code" href="rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    } <span class="keywordflow">while</span> (span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> == <a class="code" href="rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> -= span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> = 0;</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    <a class="code" href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, 0);</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;}</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160; </div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l01127"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b"> 1127</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(<a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt;= span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>);</div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;    <span class="keywordflow">return</span> !span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> &amp;&amp; (span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &gt;= span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>);</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;}</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160; </div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l01133"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4"> 1133</a></span>&#160;<a class="code" href="rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> iclass, <a class="code" href="structspan__t.html">span_t</a>* span, <a class="code" href="structspan__t.html">span_t</a>** list_head) {</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;    <span class="keywordtype">void</span>* free_list = heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>;</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* class_span = (<a class="code" href="structspan__t.html">span_t</a>*)((uintptr_t)free_list &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;    <span class="keywordflow">if</span> (span == class_span) {</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;        <span class="comment">// Adopt the heap class free list back into the span free list</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;        <span class="keywordtype">void</span>* block = span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;        <span class="keywordtype">void</span>* last_block = 0;</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;        <span class="keywordflow">while</span> (block) {</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;            last_block = block;</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;            block = *((<span class="keywordtype">void</span>**)block);</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;        }</div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;        <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> free_count = 0;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;        block = free_list;</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;        <span class="keywordflow">while</span> (block) {</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;            ++free_count;</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;            block = *((<span class="keywordtype">void</span>**)block);</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;        }</div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;        <span class="keywordflow">if</span> (last_block) {</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;            *((<span class="keywordtype">void</span>**)last_block) = free_list;</div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;            span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = free_list;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        }</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> = 0;</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> -= free_count;</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;    }</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;    <span class="comment">//If this assert triggers you have memory leaks</span></div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> == span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>);</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a> == span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>) {</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;        <a class="code" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[0].current);</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;        <a class="code" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;size_class_use[iclass].spans_current);</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;        <span class="comment">// This function only used for spans in double linked lists</span></div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;        <span class="keywordflow">if</span> (list_head)</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;            <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(list_head, span);</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;        <span class="keywordflow">return</span> 1;</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;    }</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;}</div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160; </div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160; </div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160; </div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160; </div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01183"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe"> 1183</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe">_rpmalloc_global_cache_finalize</a>(<a class="code" href="structglobal__cache__t.html">global_cache_t</a>* cache) {</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;        <span class="comment">/* Spin */</span>;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160; </div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>; ++ispan)</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(cache-&gt;<a class="code" href="structglobal__cache__t.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a>[ispan]);</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;    cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> = 0;</div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160; </div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;<span class="preprocessor">#if ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;    <span class="keywordflow">while</span> (cache-&gt;overflow) {</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* span = cache-&gt;overflow;</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;        cache-&gt;overflow = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;    }</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160; </div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;}</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160; </div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01203"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca"> 1203</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(<a class="code" href="structspan__t.html">span_t</a>** span, <span class="keywordtype">size_t</span> span_count, <span class="keywordtype">size_t</span> count) {</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">size_t</span> cache_limit = (span_count == 1) ? </div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;        <a class="code" href="rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a> * <a class="code" href="rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a> :</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;        <a class="code" href="rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a> * (<a class="code" href="rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a> - (span_count &gt;&gt; 1));</div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160; </div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    <a class="code" href="structglobal__cache__t.html">global_cache_t</a>* cache = &amp;<a class="code" href="rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[span_count - 1];</div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160; </div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;    <span class="keywordtype">size_t</span> insert_count = count;</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;        <span class="comment">/* Spin */</span>;</div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160; </div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    <span class="keywordflow">if</span> ((cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> + insert_count) &gt; cache_limit)</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;        insert_count = cache_limit - cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>;</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160; </div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    memcpy(cache-&gt;<a class="code" href="structglobal__cache__t.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a> + cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>, span, <span class="keyword">sizeof</span>(<a class="code" href="structspan__t.html">span_t</a>*) * insert_count);</div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> += (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)insert_count;</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160; </div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;<span class="preprocessor">#if ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;    <span class="keywordflow">while</span> (insert_count &lt; count) {</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* current_span = span[insert_count++];</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;        current_span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a> = cache-&gt;overflow;</div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;        cache-&gt;overflow = current_span;</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    }</div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = insert_count; ispan &lt; count; ++ispan)</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span[ispan]);</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;}</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160; </div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l01235"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7"> 1235</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a>(<a class="code" href="structspan__t.html">span_t</a>** span, <span class="keywordtype">size_t</span> span_count, <span class="keywordtype">size_t</span> count) {</div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    <a class="code" href="structglobal__cache__t.html">global_cache_t</a>* cache = &amp;<a class="code" href="rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[span_count - 1];</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160; </div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    <span class="keywordtype">size_t</span> extract_count = count;</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 1, 0))</div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;        <span class="comment">/* Spin */</span>;</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160; </div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    <span class="keywordflow">if</span> (extract_count &gt; cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>)</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;        extract_count = cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a>;</div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160; </div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    memcpy(span, cache-&gt;<a class="code" href="structglobal__cache__t.html#a9d6636075b348ce9cbd7e59e45d097c7">span</a> + (cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> - extract_count), <span class="keyword">sizeof</span>(<a class="code" href="structspan__t.html">span_t</a>*) * extract_count);</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    cache-&gt;<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> -= (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)extract_count;</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="preprocessor">#if ENABLE_UNLIMITED_CACHE</span></div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    <span class="keywordflow">while</span> ((extract_count &lt; count) &amp;&amp; cache-&gt;overflow) {</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* current_span = cache-&gt;overflow;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;        span[extract_count++] = current_span;</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;        cache-&gt;overflow = current_span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    }</div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;cache-&gt;<a class="code" href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">lock</a>, 0);</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160; </div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    <span class="keywordflow">return</span> extract_count;</div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;}</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160; </div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160; </div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160; </div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46">_rpmalloc_deallocate_huge</a>(<a class="code" href="structspan__t.html">span_t</a>*);</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160; </div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01271"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7"> 1271</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* master, <a class="code" href="structspan__t.html">span_t</a>* reserve, <span class="keywordtype">size_t</span> reserve_span_count) {</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a> = master;</div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a> = reserve;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)reserve_span_count;</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;}</div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160; </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01279"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f"> 1279</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>** single_span) {</div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>);</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>, 0, span))</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;        span = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>);</div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;    <span class="keywordflow">while</span> (span) {</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* next_span = (<a class="code" href="structspan__t.html">span_t</a>*)span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> == heap);</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>)) {</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>);</div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            --heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;            <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;full_span[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>], span);</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;            <span class="keywordflow">if</span> (single_span &amp;&amp; !*single_span) {</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                *single_span = span;</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;                <a class="code" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[0].current);</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;                <a class="code" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;size_class_use[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].spans_current);</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;                <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;            }</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;            <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>) {</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;                <a class="code" href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46">_rpmalloc_deallocate_huge</a>(span);</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;                <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>);</div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;                <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>);</div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;                --heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;                <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;                <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> idx = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> - 1;</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;                <span class="keywordflow">if</span> (!idx &amp;&amp; single_span &amp;&amp; !*single_span) {</div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;                    *single_span = span;</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;                } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;                    <a class="code" href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a>(&amp;heap-&gt;span_use[idx].current);</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160;                    <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160;                }</div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;            }</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;        }</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;        span = next_span;</div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;    }</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;}</div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160; </div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01325"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf"> 1325</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap) {</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keywordflow">if</span> (!heap-&gt;<a class="code" href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>) {</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;        <span class="keywordflow">if</span> ((heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> &gt; 1) &amp;&amp; !atomic_load32(&amp;heap-&gt;<a class="code" href="structheap__t.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>)) {</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;            <span class="keywordtype">size_t</span> heap_size = <span class="keyword">sizeof</span>(<a class="code" href="rpmalloc_8c.html#a75c19bcef00dee4542c1ddab212e29a8">heap_t</a>);</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;            <span class="keywordtype">size_t</span> block_size = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> * ((heap_size + <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1) &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>);</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;            <a class="code" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(heap, block_size, heap-&gt;<a class="code" href="structheap__t.html#ac4c9ca5afe45b09eb1ed79a98d308316">align_offset</a>, block_size);</div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;        }</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>-&gt;<a class="code" href="structheap__t.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>) == 0) {</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;            <a class="code" href="rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a>(heap-&gt;<a class="code" href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a>);</div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;        }</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    }</div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;}</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160; </div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01340"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57"> 1340</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap) {</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>++ &gt; 1) {</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;        --heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    }</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160; </div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a>(heap);</div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160; </div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;        <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;            span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;            <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;    }</div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160; </div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>) {</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;        --heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;    }</div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160; </div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> || heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>) {</div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;            --heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>;</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;            <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;        }</div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;    }</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;    <span class="comment">//Heap is now completely free, unmap and remove from heap list</span></div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;    <span class="keywordtype">size_t</span> list_idx = heap-&gt;<a class="code" href="structheap__t.html#a2342224142317f85fca91614fc973131">id</a> % <a class="code" href="rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>;</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* list_heap = <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;    <span class="keywordflow">if</span> (list_heap == heap) {</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx] = heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;        <span class="keywordflow">while</span> (list_heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a> != heap)</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;            list_heap = list_heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        list_heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a> = heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;    }</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160; </div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;    <a class="code" href="rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a>(heap);</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;}</div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160; </div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01388"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610"> 1388</a></span>&#160;<a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> != 0)) {</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;        <a class="code" href="rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a>(heap);</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;    }</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;    <span class="keywordtype">size_t</span> span_count = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;    <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_to_cache);</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;    <span class="keywordflow">if</span> (span_count == 1) {</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;        <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;        span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>++] = span;</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;        <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> == <a class="code" href="rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a>) {</div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> remain_count = <a class="code" href="rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a> - <a class="code" href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>;</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;            <a class="code" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, <a class="code" href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;            <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_to_global, <a class="code" href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>);</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;            <a class="code" href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a> + remain_count, span_count, <a class="code" href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>);</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; <a class="code" href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>; ++ispan)</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[remain_count + ispan]);</div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;            span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> = remain_count;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;        }</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;        <span class="keywordtype">size_t</span> cache_idx = span_count - 2;</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;        <a class="code" href="structspan__large__cache__t.html">span_large_cache_t</a>* span_cache = heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + cache_idx;</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;        span_cache-&gt;<a class="code" href="structspan__large__cache__t.html#a77eff1faca249ec6ae27881769f7d979">span</a>[span_cache-&gt;<a class="code" href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a>++] = span;</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">size_t</span> cache_limit = (<a class="code" href="rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a> - (span_count &gt;&gt; 1));</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;        <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a> == cache_limit) {</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> transfer_limit = 2 + (cache_limit &gt;&gt; 2);</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> transfer_count = (<a class="code" href="rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a> &lt;= transfer_limit ? <a class="code" href="rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a> : transfer_limit);</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">size_t</span> remain_count = cache_limit - transfer_count;</div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;            <a class="code" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, transfer_count * span_count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;            <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_to_global, transfer_count);</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;            <a class="code" href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="structspan__large__cache__t.html#a77eff1faca249ec6ae27881769f7d979">span</a> + remain_count, span_count, transfer_count);</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; transfer_count; ++ispan)</div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;                <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__large__cache__t.html#a77eff1faca249ec6ae27881769f7d979">span</a>[remain_count + ispan]);</div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;            span_cache-&gt;<a class="code" href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a> = remain_count;</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;        }</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;    }</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;}</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160; </div>
<div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l01440"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622"> 1440</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = 0;</div>
<div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;    <span class="keywordflow">if</span> (span_count == 1) {</div>
<div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;        <a class="code" href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, &amp;span);</div>
<div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;        <span class="keywordflow">if</span> (span)</div>
<div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;            <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;    }</div>
<div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;    <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;    <span class="keywordflow">if</span> (span_count == 1)</div>
<div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;        span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;        span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (span_count - 2));</div>
<div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>) {</div>
<div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_cache);</div>
<div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;        <span class="keywordflow">return</span> span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[--span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>];</div>
<div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;    }</div>
<div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;}</div>
<div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160; </div>
<div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l01462"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf"> 1462</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf">_rpmalloc_heap_reserved_extract</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> &gt;= span_count)</div>
<div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(heap, span_count);</div>
<div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;}</div>
<div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160; </div>
<div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l01470"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7"> 1470</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7">_rpmalloc_heap_global_cache_extract</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count) {</div>
<div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;    <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;    <span class="keywordtype">size_t</span> wanted_count;</div>
<div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;    <span class="keywordflow">if</span> (span_count == 1) {</div>
<div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;        span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;        wanted_count = <a class="code" href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a>;</div>
<div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;        span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (span_count - 2));</div>
<div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;        wanted_count = <a class="code" href="rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a>;</div>
<div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;    }</div>
<div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;    span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> = <a class="code" href="rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>, span_count, wanted_count);</div>
<div class="line"><a name="l01483"></a><span class="lineno"> 1483</span>&#160;    <span class="keywordflow">if</span> (span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>) {</div>
<div class="line"><a name="l01484"></a><span class="lineno"> 1484</span>&#160;        <a class="code" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;global_to_thread, span_count * span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l01485"></a><span class="lineno"> 1485</span>&#160;        <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_global, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l01486"></a><span class="lineno"> 1486</span>&#160;        <span class="keywordflow">return</span> span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[--span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>];</div>
<div class="line"><a name="l01487"></a><span class="lineno"> 1487</span>&#160;    }</div>
<div class="line"><a name="l01488"></a><span class="lineno"> 1488</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01489"></a><span class="lineno"> 1489</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = 0;</div>
<div class="line"><a name="l01490"></a><span class="lineno"> 1490</span>&#160;    <span class="keywordtype">size_t</span> count = <a class="code" href="rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a>(&amp;span, span_count, 1);</div>
<div class="line"><a name="l01491"></a><span class="lineno"> 1491</span>&#160;    <span class="keywordflow">if</span> (count) {</div>
<div class="line"><a name="l01492"></a><span class="lineno"> 1492</span>&#160;        <a class="code" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;global_to_thread, span_count * count * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l01493"></a><span class="lineno"> 1493</span>&#160;        <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[span_count - 1].spans_from_global, count);</div>
<div class="line"><a name="l01494"></a><span class="lineno"> 1494</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01495"></a><span class="lineno"> 1495</span>&#160;    }</div>
<div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01497"></a><span class="lineno"> 1497</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;    (void)<span class="keyword">sizeof</span>(span_count);</div>
<div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;}</div>
<div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160; </div>
<div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;<span class="keyword">static</span> <a class="code" href="structspan__t.html">span_t</a>*</div>
<div class="line"><a name="l01505"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ad50f153ecceb184b179138a3965954b6"> 1505</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ad50f153ecceb184b179138a3965954b6">_rpmalloc_heap_extract_new_span</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> span_count, <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx) {</div>
<div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span;</div>
<div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> idx = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)span_count - 1;</div>
<div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> current_count = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(&amp;heap-&gt;span_use[idx].current);</div>
<div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;    <span class="keywordflow">if</span> (current_count &gt; (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)atomic_load32(&amp;heap-&gt;span_use[idx].high))</div>
<div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;        <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;span_use[idx].high, (int32_t)current_count);</div>
<div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;    <a class="code" href="rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;heap-&gt;size_class_use[class_idx].spans_current, 1, heap-&gt;size_class_use[class_idx].spans_peak);</div>
<div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;    <span class="keywordflow">if</span> (class_idx &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>) {</div>
<div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>) {</div>
<div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;            span = heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>;</div>
<div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;            <a class="code" href="structspan__t.html">span_t</a>* new_cache = 0;</div>
<div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;            <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;                new_cache = heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[--heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>];</div>
<div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;            heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a> = new_cache;</div>
<div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;            <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;        }</div>
<div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;    }</div>
<div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;    (void)<span class="keyword">sizeof</span>(class_idx);</div>
<div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;    span = <a class="code" href="rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0)) {</div>
<div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_cache);</div>
<div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;    }</div>
<div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;    span = <a class="code" href="rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf">_rpmalloc_heap_reserved_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0)) {</div>
<div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_reserved);</div>
<div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    }</div>
<div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    span = <a class="code" href="rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7">_rpmalloc_heap_global_cache_extract</a>(heap, span_count);</div>
<div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0)) {</div>
<div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_from_cache);</div>
<div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;    }</div>
<div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;    <span class="comment">//Final fallback, map in more virtual memory</span></div>
<div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;    span = <a class="code" href="rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(heap, span_count);</div>
<div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;    <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;size_class_use[class_idx].spans_map_calls);</div>
<div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;    <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;}</div>
<div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160; </div>
<div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01550"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772"> 1550</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap) {</div>
<div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;    <span class="comment">//Get a new heap ID</span></div>
<div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a2342224142317f85fca91614fc973131">id</a> = 1 + <a class="code" href="rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a>(&amp;<a class="code" href="rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">_memory_heap_id</a>);</div>
<div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160; </div>
<div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    <span class="comment">//Link in heap in heap ID map</span></div>
<div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    <span class="keywordtype">size_t</span> list_idx = heap-&gt;<a class="code" href="structheap__t.html#a2342224142317f85fca91614fc973131">id</a> % <a class="code" href="rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>;</div>
<div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a> = <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;    <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx] = heap;</div>
<div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;}</div>
<div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160; </div>
<div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01561"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f"> 1561</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">int</span> first_class) {</div>
<div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> = (uintptr_t)-1;</div>
<div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>** heap_list = (first_class ? &amp;_memory_first_class_orphan_heaps : &amp;<a class="code" href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>);</div>
<div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    (void)<span class="keyword">sizeof</span>(first_class);</div>
<div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>** heap_list = &amp;<a class="code" href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>;</div>
<div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a87e83453c93d1e6de70f6a45044e510d">next_orphan</a> = *heap_list;</div>
<div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;    *heap_list = heap;</div>
<div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;}</div>
<div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160; </div>
<div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;<span class="keyword">static</span> <a class="code" href="structheap__t.html">heap_t</a>*</div>
<div class="line"><a name="l01575"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35"> 1575</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35">_rpmalloc_heap_allocate_new</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;    <span class="comment">//Map in pages for a new heap</span></div>
<div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;    <span class="keywordtype">size_t</span> align_offset = 0;</div>
<div class="line"><a name="l01578"></a><span class="lineno"> 1578</span>&#160;    <span class="keywordtype">size_t</span> heap_size = <span class="keyword">sizeof</span>(<a class="code" href="rpmalloc_8c.html#a75c19bcef00dee4542c1ddab212e29a8">heap_t</a>);</div>
<div class="line"><a name="l01579"></a><span class="lineno"> 1579</span>&#160;    <span class="keywordtype">size_t</span> aligned_heap_size = 64 * ((heap_size + 63) / 64);</div>
<div class="line"><a name="l01580"></a><span class="lineno"> 1580</span>&#160;    <span class="keywordtype">size_t</span> block_size = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> * ((aligned_heap_size + <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1) &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>);</div>
<div class="line"><a name="l01581"></a><span class="lineno"> 1581</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = (<a class="code" href="structheap__t.html">heap_t</a>*)<a class="code" href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(block_size, &amp;align_offset);</div>
<div class="line"><a name="l01582"></a><span class="lineno"> 1582</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l01583"></a><span class="lineno"> 1583</span>&#160;        <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01584"></a><span class="lineno"> 1584</span>&#160; </div>
<div class="line"><a name="l01585"></a><span class="lineno"> 1585</span>&#160;    <a class="code" href="rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a>(heap);</div>
<div class="line"><a name="l01586"></a><span class="lineno"> 1586</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#ac4c9ca5afe45b09eb1ed79a98d308316">align_offset</a> = align_offset;</div>
<div class="line"><a name="l01587"></a><span class="lineno"> 1587</span>&#160; </div>
<div class="line"><a name="l01588"></a><span class="lineno"> 1588</span>&#160;    <span class="comment">//Put extra heaps as orphans, aligning to make sure ABA protection bits fit in pointer low bits</span></div>
<div class="line"><a name="l01589"></a><span class="lineno"> 1589</span>&#160;    <span class="keywordtype">size_t</span> num_heaps = block_size / aligned_heap_size;</div>
<div class="line"><a name="l01590"></a><span class="lineno"> 1590</span>&#160;    <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a59fb66e831ef1e0d56d826b1851576eb">child_count</a>, (int32_t)num_heaps - 1);</div>
<div class="line"><a name="l01591"></a><span class="lineno"> 1591</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* extra_heap = (<a class="code" href="structheap__t.html">heap_t</a>*)<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(heap, aligned_heap_size);</div>
<div class="line"><a name="l01592"></a><span class="lineno"> 1592</span>&#160;    <span class="keywordflow">while</span> (num_heaps &gt; 1) {</div>
<div class="line"><a name="l01593"></a><span class="lineno"> 1593</span>&#160;        <a class="code" href="rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a>(extra_heap);</div>
<div class="line"><a name="l01594"></a><span class="lineno"> 1594</span>&#160;        extra_heap-&gt;<a class="code" href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">master_heap</a> = heap;</div>
<div class="line"><a name="l01595"></a><span class="lineno"> 1595</span>&#160;        <a class="code" href="rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a>(extra_heap, 1);</div>
<div class="line"><a name="l01596"></a><span class="lineno"> 1596</span>&#160;        extra_heap = (<a class="code" href="structheap__t.html">heap_t</a>*)<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(extra_heap, aligned_heap_size);</div>
<div class="line"><a name="l01597"></a><span class="lineno"> 1597</span>&#160;        --num_heaps;</div>
<div class="line"><a name="l01598"></a><span class="lineno"> 1598</span>&#160;    }</div>
<div class="line"><a name="l01599"></a><span class="lineno"> 1599</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01600"></a><span class="lineno"> 1600</span>&#160;}</div>
<div class="line"><a name="l01601"></a><span class="lineno"> 1601</span>&#160; </div>
<div class="line"><a name="l01602"></a><span class="lineno"> 1602</span>&#160;<span class="keyword">static</span> <a class="code" href="structheap__t.html">heap_t</a>*</div>
<div class="line"><a name="l01603"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04"> 1603</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a>(<a class="code" href="structheap__t.html">heap_t</a>** heap_list) {</div>
<div class="line"><a name="l01604"></a><span class="lineno"> 1604</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = *heap_list;</div>
<div class="line"><a name="l01605"></a><span class="lineno"> 1605</span>&#160;    *heap_list = (heap ? heap-&gt;<a class="code" href="structheap__t.html#a87e83453c93d1e6de70f6a45044e510d">next_orphan</a> : 0);</div>
<div class="line"><a name="l01606"></a><span class="lineno"> 1606</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01607"></a><span class="lineno"> 1607</span>&#160;}</div>
<div class="line"><a name="l01608"></a><span class="lineno"> 1608</span>&#160; </div>
<div class="line"><a name="l01610"></a><span class="lineno"> 1610</span>&#160;<span class="keyword">static</span> <a class="code" href="structheap__t.html">heap_t</a>*</div>
<div class="line"><a name="l01611"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845"> 1611</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a>(<span class="keywordtype">int</span> first_class) {</div>
<div class="line"><a name="l01612"></a><span class="lineno"> 1612</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = 0;</div>
<div class="line"><a name="l01613"></a><span class="lineno"> 1613</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;<a class="code" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a>, 1, 0))</div>
<div class="line"><a name="l01614"></a><span class="lineno"> 1614</span>&#160;        <span class="comment">/* Spin */</span>;</div>
<div class="line"><a name="l01615"></a><span class="lineno"> 1615</span>&#160;    <span class="keywordflow">if</span> (first_class == 0)</div>
<div class="line"><a name="l01616"></a><span class="lineno"> 1616</span>&#160;        heap = <a class="code" href="rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a>(&amp;<a class="code" href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a>);</div>
<div class="line"><a name="l01617"></a><span class="lineno"> 1617</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01618"></a><span class="lineno"> 1618</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l01619"></a><span class="lineno"> 1619</span>&#160;        heap = <a class="code" href="rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a>(&amp;_memory_first_class_orphan_heaps);</div>
<div class="line"><a name="l01620"></a><span class="lineno"> 1620</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01621"></a><span class="lineno"> 1621</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l01622"></a><span class="lineno"> 1622</span>&#160;        heap = <a class="code" href="rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35">_rpmalloc_heap_allocate_new</a>();</div>
<div class="line"><a name="l01623"></a><span class="lineno"> 1623</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a>, 0);</div>
<div class="line"><a name="l01624"></a><span class="lineno"> 1624</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l01625"></a><span class="lineno"> 1625</span>&#160;}</div>
<div class="line"><a name="l01626"></a><span class="lineno"> 1626</span>&#160; </div>
<div class="line"><a name="l01627"></a><span class="lineno"> 1627</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01628"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#aa8eb0af2c0aa626bb527878b3401ac96"> 1628</a></span>&#160;<a class="code" href="rpmalloc_8c.html#aa8eb0af2c0aa626bb527878b3401ac96">_rpmalloc_heap_release</a>(<span class="keywordtype">void</span>* heapptr, <span class="keywordtype">int</span> first_class) {</div>
<div class="line"><a name="l01629"></a><span class="lineno"> 1629</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = (<a class="code" href="structheap__t.html">heap_t</a>*)heapptr;</div>
<div class="line"><a name="l01630"></a><span class="lineno"> 1630</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l01631"></a><span class="lineno"> 1631</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l01632"></a><span class="lineno"> 1632</span>&#160;    <span class="comment">//Release thread cache spans back to global cache</span></div>
<div class="line"><a name="l01633"></a><span class="lineno"> 1633</span>&#160;    <a class="code" href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l01634"></a><span class="lineno"> 1634</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01635"></a><span class="lineno"> 1635</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l01636"></a><span class="lineno"> 1636</span>&#160;        <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l01637"></a><span class="lineno"> 1637</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l01638"></a><span class="lineno"> 1638</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01639"></a><span class="lineno"> 1639</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01640"></a><span class="lineno"> 1640</span>&#160;            span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l01641"></a><span class="lineno"> 1641</span>&#160;        <span class="keywordflow">if</span> (!span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l01642"></a><span class="lineno"> 1642</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l01643"></a><span class="lineno"> 1643</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>) {</div>
<div class="line"><a name="l01644"></a><span class="lineno"> 1644</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l01645"></a><span class="lineno"> 1645</span>&#160;                <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l01646"></a><span class="lineno"> 1646</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01647"></a><span class="lineno"> 1647</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l01648"></a><span class="lineno"> 1648</span>&#160;            <a class="code" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l01649"></a><span class="lineno"> 1649</span>&#160;            <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[iclass].spans_to_global, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l01650"></a><span class="lineno"> 1650</span>&#160;            <a class="code" href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>, iclass + 1, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l01651"></a><span class="lineno"> 1651</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01652"></a><span class="lineno"> 1652</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l01653"></a><span class="lineno"> 1653</span>&#160;                <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l01654"></a><span class="lineno"> 1654</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01655"></a><span class="lineno"> 1655</span>&#160;        }</div>
<div class="line"><a name="l01656"></a><span class="lineno"> 1656</span>&#160;        span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l01657"></a><span class="lineno"> 1657</span>&#160;    }</div>
<div class="line"><a name="l01658"></a><span class="lineno"> 1658</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01659"></a><span class="lineno"> 1659</span>&#160; </div>
<div class="line"><a name="l01660"></a><span class="lineno"> 1660</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>() == heap)</div>
<div class="line"><a name="l01661"></a><span class="lineno"> 1661</span>&#160;        <a class="code" href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(0);</div>
<div class="line"><a name="l01662"></a><span class="lineno"> 1662</span>&#160; </div>
<div class="line"><a name="l01663"></a><span class="lineno"> 1663</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l01664"></a><span class="lineno"> 1664</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;_memory_active_heaps);</div>
<div class="line"><a name="l01665"></a><span class="lineno"> 1665</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(atomic_load32(&amp;_memory_active_heaps) &gt;= 0);</div>
<div class="line"><a name="l01666"></a><span class="lineno"> 1666</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01667"></a><span class="lineno"> 1667</span>&#160; </div>
<div class="line"><a name="l01668"></a><span class="lineno"> 1668</span>&#160;    <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a>(&amp;<a class="code" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a>, 1, 0))</div>
<div class="line"><a name="l01669"></a><span class="lineno"> 1669</span>&#160;        <span class="comment">/* Spin */</span>;</div>
<div class="line"><a name="l01670"></a><span class="lineno"> 1670</span>&#160;    <a class="code" href="rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a>(heap, first_class);</div>
<div class="line"><a name="l01671"></a><span class="lineno"> 1671</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a>, 0);</div>
<div class="line"><a name="l01672"></a><span class="lineno"> 1672</span>&#160;}</div>
<div class="line"><a name="l01673"></a><span class="lineno"> 1673</span>&#160; </div>
<div class="line"><a name="l01674"></a><span class="lineno"> 1674</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01675"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a71ab817e272e211aed203f0416a622a6"> 1675</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a71ab817e272e211aed203f0416a622a6">_rpmalloc_heap_release_raw</a>(<span class="keywordtype">void</span>* heapptr) {</div>
<div class="line"><a name="l01676"></a><span class="lineno"> 1676</span>&#160;    <a class="code" href="rpmalloc_8c.html#aa8eb0af2c0aa626bb527878b3401ac96">_rpmalloc_heap_release</a>(heapptr, 0);</div>
<div class="line"><a name="l01677"></a><span class="lineno"> 1677</span>&#160;}</div>
<div class="line"><a name="l01678"></a><span class="lineno"> 1678</span>&#160; </div>
<div class="line"><a name="l01679"></a><span class="lineno"> 1679</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l01680"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906"> 1680</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap) {</div>
<div class="line"><a name="l01681"></a><span class="lineno"> 1681</span>&#160;    <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>) {</div>
<div class="line"><a name="l01682"></a><span class="lineno"> 1682</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* span = <a class="code" href="rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a>(heap, heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>);</div>
<div class="line"><a name="l01683"></a><span class="lineno"> 1683</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span);</div>
<div class="line"><a name="l01684"></a><span class="lineno"> 1684</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> = 0;</div>
<div class="line"><a name="l01685"></a><span class="lineno"> 1685</span>&#160;    }</div>
<div class="line"><a name="l01686"></a><span class="lineno"> 1686</span>&#160; </div>
<div class="line"><a name="l01687"></a><span class="lineno"> 1687</span>&#160;    <a class="code" href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l01688"></a><span class="lineno"> 1688</span>&#160; </div>
<div class="line"><a name="l01689"></a><span class="lineno"> 1689</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l01690"></a><span class="lineno"> 1690</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>)</div>
<div class="line"><a name="l01691"></a><span class="lineno"> 1691</span>&#160;            <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a>);</div>
<div class="line"><a name="l01692"></a><span class="lineno"> 1692</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">cache</a> = 0;</div>
<div class="line"><a name="l01693"></a><span class="lineno"> 1693</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* span = heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l01694"></a><span class="lineno"> 1694</span>&#160;        <span class="keywordflow">while</span> (span) {</div>
<div class="line"><a name="l01695"></a><span class="lineno"> 1695</span>&#160;            <a class="code" href="structspan__t.html">span_t</a>* next = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l01696"></a><span class="lineno"> 1696</span>&#160;            <a class="code" href="rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a>(heap, iclass, span, &amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>);</div>
<div class="line"><a name="l01697"></a><span class="lineno"> 1697</span>&#160;            span = next;</div>
<div class="line"><a name="l01698"></a><span class="lineno"> 1698</span>&#160;        }</div>
<div class="line"><a name="l01699"></a><span class="lineno"> 1699</span>&#160;        <span class="comment">// If class still has a free list it must be a full span</span></div>
<div class="line"><a name="l01700"></a><span class="lineno"> 1700</span>&#160;        <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>) {</div>
<div class="line"><a name="l01701"></a><span class="lineno"> 1701</span>&#160;            <a class="code" href="structspan__t.html">span_t</a>* class_span = (<a class="code" href="structspan__t.html">span_t</a>*)((uintptr_t)heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l01702"></a><span class="lineno"> 1702</span>&#160;            <a class="code" href="structspan__t.html">span_t</a>** list = 0;</div>
<div class="line"><a name="l01703"></a><span class="lineno"> 1703</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01704"></a><span class="lineno"> 1704</span>&#160;            list = &amp;heap-&gt;full_span[iclass];</div>
<div class="line"><a name="l01705"></a><span class="lineno"> 1705</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01706"></a><span class="lineno"> 1706</span>&#160;            --heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01707"></a><span class="lineno"> 1707</span>&#160;            <span class="keywordflow">if</span> (!<a class="code" href="rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a>(heap, iclass, class_span, list)) {</div>
<div class="line"><a name="l01708"></a><span class="lineno"> 1708</span>&#160;                <span class="keywordflow">if</span> (list)</div>
<div class="line"><a name="l01709"></a><span class="lineno"> 1709</span>&#160;                    <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(list, class_span);</div>
<div class="line"><a name="l01710"></a><span class="lineno"> 1710</span>&#160;                <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, class_span);</div>
<div class="line"><a name="l01711"></a><span class="lineno"> 1711</span>&#160;            }</div>
<div class="line"><a name="l01712"></a><span class="lineno"> 1712</span>&#160;        }</div>
<div class="line"><a name="l01713"></a><span class="lineno"> 1713</span>&#160;    }</div>
<div class="line"><a name="l01714"></a><span class="lineno"> 1714</span>&#160; </div>
<div class="line"><a name="l01715"></a><span class="lineno"> 1715</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l01716"></a><span class="lineno"> 1716</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l01717"></a><span class="lineno"> 1717</span>&#160;        <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l01718"></a><span class="lineno"> 1718</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l01719"></a><span class="lineno"> 1719</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l01720"></a><span class="lineno"> 1720</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l01721"></a><span class="lineno"> 1721</span>&#160;            span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l01722"></a><span class="lineno"> 1722</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l01723"></a><span class="lineno"> 1723</span>&#160;            <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l01724"></a><span class="lineno"> 1724</span>&#160;        span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l01725"></a><span class="lineno"> 1725</span>&#160;    }</div>
<div class="line"><a name="l01726"></a><span class="lineno"> 1726</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01727"></a><span class="lineno"> 1727</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!<a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>));</div>
<div class="line"><a name="l01728"></a><span class="lineno"> 1728</span>&#160;}</div>
<div class="line"><a name="l01729"></a><span class="lineno"> 1729</span>&#160; </div>
<div class="line"><a name="l01730"></a><span class="lineno"> 1730</span>&#160; </div>
<div class="line"><a name="l01736"></a><span class="lineno"> 1736</span>&#160; </div>
<div class="line"><a name="l01738"></a><span class="lineno"> 1738</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01739"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8"> 1739</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(<span class="keywordtype">void</span>** list) {</div>
<div class="line"><a name="l01740"></a><span class="lineno"> 1740</span>&#160;    <span class="keywordtype">void</span>* block = *list;</div>
<div class="line"><a name="l01741"></a><span class="lineno"> 1741</span>&#160;    *list = *((<span class="keywordtype">void</span>**)block);</div>
<div class="line"><a name="l01742"></a><span class="lineno"> 1742</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l01743"></a><span class="lineno"> 1743</span>&#160;}</div>
<div class="line"><a name="l01744"></a><span class="lineno"> 1744</span>&#160; </div>
<div class="line"><a name="l01746"></a><span class="lineno"> 1746</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01747"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a391da97cc59f31607c1453ccd6951a15"> 1747</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a391da97cc59f31607c1453ccd6951a15">_rpmalloc_allocate_from_heap_fallback</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx) {</div>
<div class="line"><a name="l01748"></a><span class="lineno"> 1748</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l01749"></a><span class="lineno"> 1749</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0)) {</div>
<div class="line"><a name="l01750"></a><span class="lineno"> 1750</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a> == <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>);</div>
<div class="line"><a name="l01751"></a><span class="lineno"> 1751</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!<a class="code" href="rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(span));</div>
<div class="line"><a name="l01752"></a><span class="lineno"> 1752</span>&#160;        <span class="keywordtype">void</span>* block;</div>
<div class="line"><a name="l01753"></a><span class="lineno"> 1753</span>&#160;        <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>) {</div>
<div class="line"><a name="l01754"></a><span class="lineno"> 1754</span>&#160;            <span class="comment">//Swap in free list if not empty</span></div>
<div class="line"><a name="l01755"></a><span class="lineno"> 1755</span>&#160;            heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> = span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l01756"></a><span class="lineno"> 1756</span>&#160;            span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = 0;</div>
<div class="line"><a name="l01757"></a><span class="lineno"> 1757</span>&#160;            block = <a class="code" href="rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>);</div>
<div class="line"><a name="l01758"></a><span class="lineno"> 1758</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l01759"></a><span class="lineno"> 1759</span>&#160;            <span class="comment">//If the span did not fully initialize free list, link up another page worth of blocks          </span></div>
<div class="line"><a name="l01760"></a><span class="lineno"> 1760</span>&#160;            <span class="keywordtype">void</span>* block_start = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> + ((<span class="keywordtype">size_t</span>)span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> * span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>));</div>
<div class="line"><a name="l01761"></a><span class="lineno"> 1761</span>&#160;            span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> += <a class="code" href="rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>, &amp;block,</div>
<div class="line"><a name="l01762"></a><span class="lineno"> 1762</span>&#160;                (<span class="keywordtype">void</span>*)((uintptr_t)block_start &amp; ~(<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1)), block_start,</div>
<div class="line"><a name="l01763"></a><span class="lineno"> 1763</span>&#160;                span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a> - span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>, span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>);</div>
<div class="line"><a name="l01764"></a><span class="lineno"> 1764</span>&#160;        }</div>
<div class="line"><a name="l01765"></a><span class="lineno"> 1765</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt;= span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>);</div>
<div class="line"><a name="l01766"></a><span class="lineno"> 1766</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l01767"></a><span class="lineno"> 1767</span>&#160; </div>
<div class="line"><a name="l01768"></a><span class="lineno"> 1768</span>&#160;        <span class="comment">//Swap in deferred free list if present</span></div>
<div class="line"><a name="l01769"></a><span class="lineno"> 1769</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>))</div>
<div class="line"><a name="l01770"></a><span class="lineno"> 1770</span>&#160;            <a class="code" href="rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e">_rpmalloc_span_extract_free_list_deferred</a>(span);</div>
<div class="line"><a name="l01771"></a><span class="lineno"> 1771</span>&#160; </div>
<div class="line"><a name="l01772"></a><span class="lineno"> 1772</span>&#160;        <span class="comment">//If span is still not fully utilized keep it in partial list and early return block</span></div>
<div class="line"><a name="l01773"></a><span class="lineno"> 1773</span>&#160;        <span class="keywordflow">if</span> (!<a class="code" href="rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(span))</div>
<div class="line"><a name="l01774"></a><span class="lineno"> 1774</span>&#160;            <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l01775"></a><span class="lineno"> 1775</span>&#160; </div>
<div class="line"><a name="l01776"></a><span class="lineno"> 1776</span>&#160;        <span class="comment">//The span is fully utilized, unlink from partial list and add to fully utilized list</span></div>
<div class="line"><a name="l01777"></a><span class="lineno"> 1777</span>&#160;        <a class="code" href="rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">_rpmalloc_span_double_link_list_pop_head</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l01778"></a><span class="lineno"> 1778</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01779"></a><span class="lineno"> 1779</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;full_span[class_idx], span);</div>
<div class="line"><a name="l01780"></a><span class="lineno"> 1780</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01781"></a><span class="lineno"> 1781</span>&#160;        ++heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01782"></a><span class="lineno"> 1782</span>&#160;        <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l01783"></a><span class="lineno"> 1783</span>&#160;    }</div>
<div class="line"><a name="l01784"></a><span class="lineno"> 1784</span>&#160; </div>
<div class="line"><a name="l01785"></a><span class="lineno"> 1785</span>&#160;    <span class="comment">//Find a span in one of the cache levels</span></div>
<div class="line"><a name="l01786"></a><span class="lineno"> 1786</span>&#160;    span = <a class="code" href="rpmalloc_8c.html#ad50f153ecceb184b179138a3965954b6">_rpmalloc_heap_extract_new_span</a>(heap, 1, class_idx);</div>
<div class="line"><a name="l01787"></a><span class="lineno"> 1787</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span != 0)) {</div>
<div class="line"><a name="l01788"></a><span class="lineno"> 1788</span>&#160;        <span class="comment">//Mark span as owned by this heap and set base data, return first block</span></div>
<div class="line"><a name="l01789"></a><span class="lineno"> 1789</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#ab6bd4a5eb2a9f92ae4b0042a31d215ed">_rpmalloc_span_initialize_new</a>(heap, span, class_idx);</div>
<div class="line"><a name="l01790"></a><span class="lineno"> 1790</span>&#160;    }</div>
<div class="line"><a name="l01791"></a><span class="lineno"> 1791</span>&#160; </div>
<div class="line"><a name="l01792"></a><span class="lineno"> 1792</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01793"></a><span class="lineno"> 1793</span>&#160;}</div>
<div class="line"><a name="l01794"></a><span class="lineno"> 1794</span>&#160; </div>
<div class="line"><a name="l01796"></a><span class="lineno"> 1796</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01797"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701"> 1797</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701">_rpmalloc_allocate_small</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l01798"></a><span class="lineno"> 1798</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap);</div>
<div class="line"><a name="l01799"></a><span class="lineno"> 1799</span>&#160;    <span class="comment">//Small sizes have unique size classes</span></div>
<div class="line"><a name="l01800"></a><span class="lineno"> 1800</span>&#160;    <span class="keyword">const</span> <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)((size + (<a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a> - 1)) &gt;&gt; <a class="code" href="rpmalloc_8c.html#a66893939b9053e9bf8a97a5f50bc773a">SMALL_GRANULARITY_SHIFT</a>);</div>
<div class="line"><a name="l01801"></a><span class="lineno"> 1801</span>&#160;    <a class="code" href="rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">_rpmalloc_stat_inc_alloc</a>(heap, class_idx);</div>
<div class="line"><a name="l01802"></a><span class="lineno"> 1802</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> != 0))</div>
<div class="line"><a name="l01803"></a><span class="lineno"> 1803</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>);</div>
<div class="line"><a name="l01804"></a><span class="lineno"> 1804</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a391da97cc59f31607c1453ccd6951a15">_rpmalloc_allocate_from_heap_fallback</a>(heap, class_idx);</div>
<div class="line"><a name="l01805"></a><span class="lineno"> 1805</span>&#160;}</div>
<div class="line"><a name="l01806"></a><span class="lineno"> 1806</span>&#160; </div>
<div class="line"><a name="l01808"></a><span class="lineno"> 1808</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01809"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b"> 1809</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b">_rpmalloc_allocate_medium</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l01810"></a><span class="lineno"> 1810</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap);</div>
<div class="line"><a name="l01811"></a><span class="lineno"> 1811</span>&#160;    <span class="comment">//Calculate the size class index and do a dependent lookup of the final class index (in case of merged classes)</span></div>
<div class="line"><a name="l01812"></a><span class="lineno"> 1812</span>&#160;    <span class="keyword">const</span> <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> base_idx = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)(<a class="code" href="rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a> + ((size - (<a class="code" href="rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a> + 1)) &gt;&gt; <a class="code" href="rpmalloc_8c.html#a95449a66565995789e144cfc3f538261">MEDIUM_GRANULARITY_SHIFT</a>));</div>
<div class="line"><a name="l01813"></a><span class="lineno"> 1813</span>&#160;    <span class="keyword">const</span> <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> class_idx = <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[base_idx].<a class="code" href="structsize__class__t.html#a7524fc81b83a0b54ef5ec3fb4563b69d">class_idx</a>;</div>
<div class="line"><a name="l01814"></a><span class="lineno"> 1814</span>&#160;    <a class="code" href="rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">_rpmalloc_stat_inc_alloc</a>(heap, class_idx);</div>
<div class="line"><a name="l01815"></a><span class="lineno"> 1815</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a> != 0))</div>
<div class="line"><a name="l01816"></a><span class="lineno"> 1816</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[class_idx].<a class="code" href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">free_list</a>);</div>
<div class="line"><a name="l01817"></a><span class="lineno"> 1817</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a391da97cc59f31607c1453ccd6951a15">_rpmalloc_allocate_from_heap_fallback</a>(heap, class_idx);</div>
<div class="line"><a name="l01818"></a><span class="lineno"> 1818</span>&#160;}</div>
<div class="line"><a name="l01819"></a><span class="lineno"> 1819</span>&#160; </div>
<div class="line"><a name="l01821"></a><span class="lineno"> 1821</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01822"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70"> 1822</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70">_rpmalloc_allocate_large</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l01823"></a><span class="lineno"> 1823</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap);</div>
<div class="line"><a name="l01824"></a><span class="lineno"> 1824</span>&#160;    <span class="comment">//Calculate number of needed max sized spans (including header)</span></div>
<div class="line"><a name="l01825"></a><span class="lineno"> 1825</span>&#160;    <span class="comment">//Since this function is never called if size &gt; LARGE_SIZE_LIMIT</span></div>
<div class="line"><a name="l01826"></a><span class="lineno"> 1826</span>&#160;    <span class="comment">//the span_count is guaranteed to be &lt;= LARGE_CLASS_COUNT</span></div>
<div class="line"><a name="l01827"></a><span class="lineno"> 1827</span>&#160;    size += <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l01828"></a><span class="lineno"> 1828</span>&#160;    <span class="keywordtype">size_t</span> span_count = size &gt;&gt; <a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l01829"></a><span class="lineno"> 1829</span>&#160;    <span class="keywordflow">if</span> (size &amp; (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> - 1))</div>
<div class="line"><a name="l01830"></a><span class="lineno"> 1830</span>&#160;        ++span_count;</div>
<div class="line"><a name="l01831"></a><span class="lineno"> 1831</span>&#160; </div>
<div class="line"><a name="l01832"></a><span class="lineno"> 1832</span>&#160;    <span class="comment">//Find a span in one of the cache levels</span></div>
<div class="line"><a name="l01833"></a><span class="lineno"> 1833</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = <a class="code" href="rpmalloc_8c.html#ad50f153ecceb184b179138a3965954b6">_rpmalloc_heap_extract_new_span</a>(heap, span_count, <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>);</div>
<div class="line"><a name="l01834"></a><span class="lineno"> 1834</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01835"></a><span class="lineno"> 1835</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01836"></a><span class="lineno"> 1836</span>&#160; </div>
<div class="line"><a name="l01837"></a><span class="lineno"> 1837</span>&#160;    <span class="comment">//Mark span as owned by this heap and set base data</span></div>
<div class="line"><a name="l01838"></a><span class="lineno"> 1838</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> == span_count);</div>
<div class="line"><a name="l01839"></a><span class="lineno"> 1839</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>;</div>
<div class="line"><a name="l01840"></a><span class="lineno"> 1840</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l01841"></a><span class="lineno"> 1841</span>&#160; </div>
<div class="line"><a name="l01842"></a><span class="lineno"> 1842</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01843"></a><span class="lineno"> 1843</span>&#160;    <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l01844"></a><span class="lineno"> 1844</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01845"></a><span class="lineno"> 1845</span>&#160;    ++heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01846"></a><span class="lineno"> 1846</span>&#160; </div>
<div class="line"><a name="l01847"></a><span class="lineno"> 1847</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l01848"></a><span class="lineno"> 1848</span>&#160;}</div>
<div class="line"><a name="l01849"></a><span class="lineno"> 1849</span>&#160; </div>
<div class="line"><a name="l01851"></a><span class="lineno"> 1851</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01852"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595"> 1852</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595">_rpmalloc_allocate_huge</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l01853"></a><span class="lineno"> 1853</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap);</div>
<div class="line"><a name="l01854"></a><span class="lineno"> 1854</span>&#160;    size += <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l01855"></a><span class="lineno"> 1855</span>&#160;    <span class="keywordtype">size_t</span> num_pages = size &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l01856"></a><span class="lineno"> 1856</span>&#160;    <span class="keywordflow">if</span> (size &amp; (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1))</div>
<div class="line"><a name="l01857"></a><span class="lineno"> 1857</span>&#160;        ++num_pages;</div>
<div class="line"><a name="l01858"></a><span class="lineno"> 1858</span>&#160;    <span class="keywordtype">size_t</span> align_offset = 0;</div>
<div class="line"><a name="l01859"></a><span class="lineno"> 1859</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(num_pages * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, &amp;align_offset);</div>
<div class="line"><a name="l01860"></a><span class="lineno"> 1860</span>&#160;    <span class="keywordflow">if</span> (!span)</div>
<div class="line"><a name="l01861"></a><span class="lineno"> 1861</span>&#160;        <span class="keywordflow">return</span> span;</div>
<div class="line"><a name="l01862"></a><span class="lineno"> 1862</span>&#160; </div>
<div class="line"><a name="l01863"></a><span class="lineno"> 1863</span>&#160;    <span class="comment">//Store page count in span_count</span></div>
<div class="line"><a name="l01864"></a><span class="lineno"> 1864</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = <a class="code" href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>;</div>
<div class="line"><a name="l01865"></a><span class="lineno"> 1865</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)num_pages;</div>
<div class="line"><a name="l01866"></a><span class="lineno"> 1866</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)align_offset;</div>
<div class="line"><a name="l01867"></a><span class="lineno"> 1867</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l01868"></a><span class="lineno"> 1868</span>&#160;    <a class="code" href="rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;_huge_pages_current, num_pages, _huge_pages_peak);</div>
<div class="line"><a name="l01869"></a><span class="lineno"> 1869</span>&#160; </div>
<div class="line"><a name="l01870"></a><span class="lineno"> 1870</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01871"></a><span class="lineno"> 1871</span>&#160;    <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l01872"></a><span class="lineno"> 1872</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01873"></a><span class="lineno"> 1873</span>&#160;    ++heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l01874"></a><span class="lineno"> 1874</span>&#160; </div>
<div class="line"><a name="l01875"></a><span class="lineno"> 1875</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l01876"></a><span class="lineno"> 1876</span>&#160;}</div>
<div class="line"><a name="l01877"></a><span class="lineno"> 1877</span>&#160; </div>
<div class="line"><a name="l01879"></a><span class="lineno"> 1879</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01880"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd"> 1880</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l01881"></a><span class="lineno"> 1881</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(size &lt;= <a class="code" href="rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a>))</div>
<div class="line"><a name="l01882"></a><span class="lineno"> 1882</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701">_rpmalloc_allocate_small</a>(heap, size);</div>
<div class="line"><a name="l01883"></a><span class="lineno"> 1883</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size &lt;= <a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>)</div>
<div class="line"><a name="l01884"></a><span class="lineno"> 1884</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b">_rpmalloc_allocate_medium</a>(heap, size);</div>
<div class="line"><a name="l01885"></a><span class="lineno"> 1885</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size &lt;= <a class="code" href="rpmalloc_8c.html#a6866e2b7c1e8f60d6c74ea8fba6be44d">LARGE_SIZE_LIMIT</a>)</div>
<div class="line"><a name="l01886"></a><span class="lineno"> 1886</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70">_rpmalloc_allocate_large</a>(heap, size);</div>
<div class="line"><a name="l01887"></a><span class="lineno"> 1887</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595">_rpmalloc_allocate_huge</a>(heap, size);</div>
<div class="line"><a name="l01888"></a><span class="lineno"> 1888</span>&#160;}</div>
<div class="line"><a name="l01889"></a><span class="lineno"> 1889</span>&#160; </div>
<div class="line"><a name="l01890"></a><span class="lineno"> 1890</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l01891"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36"> 1891</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l01892"></a><span class="lineno"> 1892</span>&#160;    <span class="keywordflow">if</span> (alignment &lt;= <a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>)</div>
<div class="line"><a name="l01893"></a><span class="lineno"> 1893</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, size);</div>
<div class="line"><a name="l01894"></a><span class="lineno"> 1894</span>&#160; </div>
<div class="line"><a name="l01895"></a><span class="lineno"> 1895</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l01896"></a><span class="lineno"> 1896</span>&#160;    <span class="keywordflow">if</span> ((size + alignment) &lt; size) {</div>
<div class="line"><a name="l01897"></a><span class="lineno"> 1897</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l01898"></a><span class="lineno"> 1898</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01899"></a><span class="lineno"> 1899</span>&#160;    }</div>
<div class="line"><a name="l01900"></a><span class="lineno"> 1900</span>&#160;    <span class="keywordflow">if</span> (alignment &amp; (alignment - 1)) {</div>
<div class="line"><a name="l01901"></a><span class="lineno"> 1901</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l01902"></a><span class="lineno"> 1902</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01903"></a><span class="lineno"> 1903</span>&#160;    }</div>
<div class="line"><a name="l01904"></a><span class="lineno"> 1904</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01905"></a><span class="lineno"> 1905</span>&#160; </div>
<div class="line"><a name="l01906"></a><span class="lineno"> 1906</span>&#160;    <span class="keywordflow">if</span> ((alignment &lt;= <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>) &amp;&amp; (size &lt; <a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>)) {</div>
<div class="line"><a name="l01907"></a><span class="lineno"> 1907</span>&#160;        <span class="comment">// If alignment is less or equal to span header size (which is power of two),</span></div>
<div class="line"><a name="l01908"></a><span class="lineno"> 1908</span>&#160;        <span class="comment">// and size aligned to span header size multiples is less than size + alignment,</span></div>
<div class="line"><a name="l01909"></a><span class="lineno"> 1909</span>&#160;        <span class="comment">// then use natural alignment of blocks to provide alignment</span></div>
<div class="line"><a name="l01910"></a><span class="lineno"> 1910</span>&#160;        <span class="keywordtype">size_t</span> multiple_size = size ? (size + (<a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> - 1)) &amp; ~(uintptr_t)(<a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a> - 1) : <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l01911"></a><span class="lineno"> 1911</span>&#160;        <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!(multiple_size % <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>));</div>
<div class="line"><a name="l01912"></a><span class="lineno"> 1912</span>&#160;        <span class="keywordflow">if</span> (multiple_size &lt;= (size + alignment))</div>
<div class="line"><a name="l01913"></a><span class="lineno"> 1913</span>&#160;            <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, multiple_size);</div>
<div class="line"><a name="l01914"></a><span class="lineno"> 1914</span>&#160;    }</div>
<div class="line"><a name="l01915"></a><span class="lineno"> 1915</span>&#160; </div>
<div class="line"><a name="l01916"></a><span class="lineno"> 1916</span>&#160;    <span class="keywordtype">void</span>* ptr = 0;</div>
<div class="line"><a name="l01917"></a><span class="lineno"> 1917</span>&#160;    <span class="keywordtype">size_t</span> align_mask = alignment - 1;</div>
<div class="line"><a name="l01918"></a><span class="lineno"> 1918</span>&#160;    <span class="keywordflow">if</span> (alignment &lt;= <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) {</div>
<div class="line"><a name="l01919"></a><span class="lineno"> 1919</span>&#160;        ptr = <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, size + alignment);</div>
<div class="line"><a name="l01920"></a><span class="lineno"> 1920</span>&#160;        <span class="keywordflow">if</span> ((uintptr_t)ptr &amp; align_mask) {</div>
<div class="line"><a name="l01921"></a><span class="lineno"> 1921</span>&#160;            ptr = (<span class="keywordtype">void</span>*)(((uintptr_t)ptr &amp; ~(uintptr_t)align_mask) + alignment);</div>
<div class="line"><a name="l01922"></a><span class="lineno"> 1922</span>&#160;            <span class="comment">//Mark as having aligned blocks</span></div>
<div class="line"><a name="l01923"></a><span class="lineno"> 1923</span>&#160;            <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)((uintptr_t)ptr &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l01924"></a><span class="lineno"> 1924</span>&#160;            span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> |= <a class="code" href="rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a>;</div>
<div class="line"><a name="l01925"></a><span class="lineno"> 1925</span>&#160;        }</div>
<div class="line"><a name="l01926"></a><span class="lineno"> 1926</span>&#160;        <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l01927"></a><span class="lineno"> 1927</span>&#160;    }</div>
<div class="line"><a name="l01928"></a><span class="lineno"> 1928</span>&#160; </div>
<div class="line"><a name="l01929"></a><span class="lineno"> 1929</span>&#160;    <span class="comment">// Fallback to mapping new pages for this request. Since pointers passed</span></div>
<div class="line"><a name="l01930"></a><span class="lineno"> 1930</span>&#160;    <span class="comment">// to rpfree must be able to reach the start of the span by bitmasking of</span></div>
<div class="line"><a name="l01931"></a><span class="lineno"> 1931</span>&#160;    <span class="comment">// the address with the span size, the returned aligned pointer from this</span></div>
<div class="line"><a name="l01932"></a><span class="lineno"> 1932</span>&#160;    <span class="comment">// function must be with a span size of the start of the mapped area.</span></div>
<div class="line"><a name="l01933"></a><span class="lineno"> 1933</span>&#160;    <span class="comment">// In worst case this requires us to loop and map pages until we get a</span></div>
<div class="line"><a name="l01934"></a><span class="lineno"> 1934</span>&#160;    <span class="comment">// suitable memory address. It also means we can never align to span size</span></div>
<div class="line"><a name="l01935"></a><span class="lineno"> 1935</span>&#160;    <span class="comment">// or greater, since the span header will push alignment more than one</span></div>
<div class="line"><a name="l01936"></a><span class="lineno"> 1936</span>&#160;    <span class="comment">// span size away from span start (thus causing pointer mask to give us</span></div>
<div class="line"><a name="l01937"></a><span class="lineno"> 1937</span>&#160;    <span class="comment">// an invalid span start on free)</span></div>
<div class="line"><a name="l01938"></a><span class="lineno"> 1938</span>&#160;    <span class="keywordflow">if</span> (alignment &amp; align_mask) {</div>
<div class="line"><a name="l01939"></a><span class="lineno"> 1939</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l01940"></a><span class="lineno"> 1940</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01941"></a><span class="lineno"> 1941</span>&#160;    }</div>
<div class="line"><a name="l01942"></a><span class="lineno"> 1942</span>&#160;    <span class="keywordflow">if</span> (alignment &gt;= <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) {</div>
<div class="line"><a name="l01943"></a><span class="lineno"> 1943</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l01944"></a><span class="lineno"> 1944</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01945"></a><span class="lineno"> 1945</span>&#160;    }</div>
<div class="line"><a name="l01946"></a><span class="lineno"> 1946</span>&#160; </div>
<div class="line"><a name="l01947"></a><span class="lineno"> 1947</span>&#160;    <span class="keywordtype">size_t</span> extra_pages = alignment / <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l01948"></a><span class="lineno"> 1948</span>&#160; </div>
<div class="line"><a name="l01949"></a><span class="lineno"> 1949</span>&#160;    <span class="comment">// Since each span has a header, we will at least need one extra memory page</span></div>
<div class="line"><a name="l01950"></a><span class="lineno"> 1950</span>&#160;    <span class="keywordtype">size_t</span> num_pages = 1 + (size / <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l01951"></a><span class="lineno"> 1951</span>&#160;    <span class="keywordflow">if</span> (size &amp; (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1))</div>
<div class="line"><a name="l01952"></a><span class="lineno"> 1952</span>&#160;        ++num_pages;</div>
<div class="line"><a name="l01953"></a><span class="lineno"> 1953</span>&#160; </div>
<div class="line"><a name="l01954"></a><span class="lineno"> 1954</span>&#160;    <span class="keywordflow">if</span> (extra_pages &gt; num_pages)</div>
<div class="line"><a name="l01955"></a><span class="lineno"> 1955</span>&#160;        num_pages = 1 + extra_pages;</div>
<div class="line"><a name="l01956"></a><span class="lineno"> 1956</span>&#160; </div>
<div class="line"><a name="l01957"></a><span class="lineno"> 1957</span>&#160;    <span class="keywordtype">size_t</span> original_pages = num_pages;</div>
<div class="line"><a name="l01958"></a><span class="lineno"> 1958</span>&#160;    <span class="keywordtype">size_t</span> limit_pages = (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> / <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) * 2;</div>
<div class="line"><a name="l01959"></a><span class="lineno"> 1959</span>&#160;    <span class="keywordflow">if</span> (limit_pages &lt; (original_pages * 2))</div>
<div class="line"><a name="l01960"></a><span class="lineno"> 1960</span>&#160;        limit_pages = original_pages * 2;</div>
<div class="line"><a name="l01961"></a><span class="lineno"> 1961</span>&#160; </div>
<div class="line"><a name="l01962"></a><span class="lineno"> 1962</span>&#160;    <span class="keywordtype">size_t</span> mapped_size, align_offset;</div>
<div class="line"><a name="l01963"></a><span class="lineno"> 1963</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span;</div>
<div class="line"><a name="l01964"></a><span class="lineno"> 1964</span>&#160; </div>
<div class="line"><a name="l01965"></a><span class="lineno"> 1965</span>&#160;retry:</div>
<div class="line"><a name="l01966"></a><span class="lineno"> 1966</span>&#160;    align_offset = 0;</div>
<div class="line"><a name="l01967"></a><span class="lineno"> 1967</span>&#160;    mapped_size = num_pages * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l01968"></a><span class="lineno"> 1968</span>&#160; </div>
<div class="line"><a name="l01969"></a><span class="lineno"> 1969</span>&#160;    span = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a>(mapped_size, &amp;align_offset);</div>
<div class="line"><a name="l01970"></a><span class="lineno"> 1970</span>&#160;    <span class="keywordflow">if</span> (!span) {</div>
<div class="line"><a name="l01971"></a><span class="lineno"> 1971</span>&#160;        errno = ENOMEM;</div>
<div class="line"><a name="l01972"></a><span class="lineno"> 1972</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01973"></a><span class="lineno"> 1973</span>&#160;    }</div>
<div class="line"><a name="l01974"></a><span class="lineno"> 1974</span>&#160;    ptr = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l01975"></a><span class="lineno"> 1975</span>&#160; </div>
<div class="line"><a name="l01976"></a><span class="lineno"> 1976</span>&#160;    <span class="keywordflow">if</span> ((uintptr_t)ptr &amp; align_mask)</div>
<div class="line"><a name="l01977"></a><span class="lineno"> 1977</span>&#160;        ptr = (<span class="keywordtype">void</span>*)(((uintptr_t)ptr &amp; ~(uintptr_t)align_mask) + alignment);</div>
<div class="line"><a name="l01978"></a><span class="lineno"> 1978</span>&#160; </div>
<div class="line"><a name="l01979"></a><span class="lineno"> 1979</span>&#160;    <span class="keywordflow">if</span> (((<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(ptr, span) &gt;= <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) ||</div>
<div class="line"><a name="l01980"></a><span class="lineno"> 1980</span>&#160;        (<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(ptr, size) &gt; <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, mapped_size)) ||</div>
<div class="line"><a name="l01981"></a><span class="lineno"> 1981</span>&#160;        (((uintptr_t)ptr &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>) != (uintptr_t)span)) {</div>
<div class="line"><a name="l01982"></a><span class="lineno"> 1982</span>&#160;        <a class="code" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(span, mapped_size, align_offset, mapped_size);</div>
<div class="line"><a name="l01983"></a><span class="lineno"> 1983</span>&#160;        ++num_pages;</div>
<div class="line"><a name="l01984"></a><span class="lineno"> 1984</span>&#160;        <span class="keywordflow">if</span> (num_pages &gt; limit_pages) {</div>
<div class="line"><a name="l01985"></a><span class="lineno"> 1985</span>&#160;            errno = EINVAL;</div>
<div class="line"><a name="l01986"></a><span class="lineno"> 1986</span>&#160;            <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01987"></a><span class="lineno"> 1987</span>&#160;        }</div>
<div class="line"><a name="l01988"></a><span class="lineno"> 1988</span>&#160;        <span class="keywordflow">goto</span> retry;</div>
<div class="line"><a name="l01989"></a><span class="lineno"> 1989</span>&#160;    }</div>
<div class="line"><a name="l01990"></a><span class="lineno"> 1990</span>&#160; </div>
<div class="line"><a name="l01991"></a><span class="lineno"> 1991</span>&#160;    <span class="comment">//Store page count in span_count</span></div>
<div class="line"><a name="l01992"></a><span class="lineno"> 1992</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> = <a class="code" href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>;</div>
<div class="line"><a name="l01993"></a><span class="lineno"> 1993</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)num_pages;</div>
<div class="line"><a name="l01994"></a><span class="lineno"> 1994</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)align_offset;</div>
<div class="line"><a name="l01995"></a><span class="lineno"> 1995</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l01996"></a><span class="lineno"> 1996</span>&#160;    <a class="code" href="rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a>(&amp;_huge_pages_current, num_pages, _huge_pages_peak);</div>
<div class="line"><a name="l01997"></a><span class="lineno"> 1997</span>&#160; </div>
<div class="line"><a name="l01998"></a><span class="lineno"> 1998</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l01999"></a><span class="lineno"> 1999</span>&#160;    <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02000"></a><span class="lineno"> 2000</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02001"></a><span class="lineno"> 2001</span>&#160;    ++heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02002"></a><span class="lineno"> 2002</span>&#160; </div>
<div class="line"><a name="l02003"></a><span class="lineno"> 2003</span>&#160;    <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02004"></a><span class="lineno"> 2004</span>&#160;}</div>
<div class="line"><a name="l02005"></a><span class="lineno"> 2005</span>&#160; </div>
<div class="line"><a name="l02006"></a><span class="lineno"> 2006</span>&#160; </div>
<div class="line"><a name="l02012"></a><span class="lineno"> 2012</span>&#160; </div>
<div class="line"><a name="l02014"></a><span class="lineno"> 2014</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02015"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e"> 2015</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e">_rpmalloc_deallocate_direct_small_or_medium</a>(<a class="code" href="structspan__t.html">span_t</a>* span, <span class="keywordtype">void</span>* block) {</div>
<div class="line"><a name="l02016"></a><span class="lineno"> 2016</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>;</div>
<div class="line"><a name="l02017"></a><span class="lineno"> 2017</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> == <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>() || !heap-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> || heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02018"></a><span class="lineno"> 2018</span>&#160;    <span class="comment">//Add block to free list</span></div>
<div class="line"><a name="l02019"></a><span class="lineno"> 2019</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(<a class="code" href="rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a>(span))) {</div>
<div class="line"><a name="l02020"></a><span class="lineno"> 2020</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> = span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>;</div>
<div class="line"><a name="l02021"></a><span class="lineno"> 2021</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02022"></a><span class="lineno"> 2022</span>&#160;        <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;full_span[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>], span);</div>
<div class="line"><a name="l02023"></a><span class="lineno"> 2023</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02024"></a><span class="lineno"> 2024</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l02025"></a><span class="lineno"> 2025</span>&#160;        --heap-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02026"></a><span class="lineno"> 2026</span>&#160;    }</div>
<div class="line"><a name="l02027"></a><span class="lineno"> 2027</span>&#160;    --span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>;</div>
<div class="line"><a name="l02028"></a><span class="lineno"> 2028</span>&#160;    *((<span class="keywordtype">void</span>**)block) = span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l02029"></a><span class="lineno"> 2029</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = block;</div>
<div class="line"><a name="l02030"></a><span class="lineno"> 2030</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a> == span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>)) {</div>
<div class="line"><a name="l02031"></a><span class="lineno"> 2031</span>&#160;        <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>, span);</div>
<div class="line"><a name="l02032"></a><span class="lineno"> 2032</span>&#160;        <a class="code" href="rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947">_rpmalloc_span_release_to_cache</a>(heap, span);</div>
<div class="line"><a name="l02033"></a><span class="lineno"> 2033</span>&#160;    }</div>
<div class="line"><a name="l02034"></a><span class="lineno"> 2034</span>&#160;}</div>
<div class="line"><a name="l02035"></a><span class="lineno"> 2035</span>&#160; </div>
<div class="line"><a name="l02036"></a><span class="lineno"> 2036</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02037"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947"> 2037</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l02038"></a><span class="lineno"> 2038</span>&#160;    <span class="comment">//This list does not need ABA protection, no mutable side state</span></div>
<div class="line"><a name="l02039"></a><span class="lineno"> 2039</span>&#160;    <span class="keywordflow">do</span> {</div>
<div class="line"><a name="l02040"></a><span class="lineno"> 2040</span>&#160;        span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a> = <a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>);</div>
<div class="line"><a name="l02041"></a><span class="lineno"> 2041</span>&#160;    } <span class="keywordflow">while</span> (!<a class="code" href="rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>, span, span-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>));</div>
<div class="line"><a name="l02042"></a><span class="lineno"> 2042</span>&#160;}</div>
<div class="line"><a name="l02043"></a><span class="lineno"> 2043</span>&#160; </div>
<div class="line"><a name="l02045"></a><span class="lineno"> 2045</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02046"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801"> 2046</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801">_rpmalloc_deallocate_defer_small_or_medium</a>(<a class="code" href="structspan__t.html">span_t</a>* span, <span class="keywordtype">void</span>* block) {</div>
<div class="line"><a name="l02047"></a><span class="lineno"> 2047</span>&#160;    <span class="comment">// The memory ordering here is a bit tricky, to avoid having to ABA protect</span></div>
<div class="line"><a name="l02048"></a><span class="lineno"> 2048</span>&#160;    <span class="comment">// the deferred free list to avoid desynchronization of list and list size</span></div>
<div class="line"><a name="l02049"></a><span class="lineno"> 2049</span>&#160;    <span class="comment">// we need to have acquire semantics on successful CAS of the pointer to</span></div>
<div class="line"><a name="l02050"></a><span class="lineno"> 2050</span>&#160;    <span class="comment">// guarantee the list_size variable validity + release semantics on pointer store</span></div>
<div class="line"><a name="l02051"></a><span class="lineno"> 2051</span>&#160;    <span class="keywordtype">void</span>* free_list;</div>
<div class="line"><a name="l02052"></a><span class="lineno"> 2052</span>&#160;    <span class="keywordflow">do</span> {</div>
<div class="line"><a name="l02053"></a><span class="lineno"> 2053</span>&#160;        free_list = <a class="code" href="rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, <a class="code" href="rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l02054"></a><span class="lineno"> 2054</span>&#160;    } <span class="keywordflow">while</span> (free_list == <a class="code" href="rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a>);</div>
<div class="line"><a name="l02055"></a><span class="lineno"> 2055</span>&#160;    *((<span class="keywordtype">void</span>**)block) = free_list;</div>
<div class="line"><a name="l02056"></a><span class="lineno"> 2056</span>&#160;    <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> free_count = ++span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l02057"></a><span class="lineno"> 2057</span>&#160;    <a class="code" href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">free_list_deferred</a>, block);</div>
<div class="line"><a name="l02058"></a><span class="lineno"> 2058</span>&#160;    <span class="keywordflow">if</span> (free_count == span-&gt;<a class="code" href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">block_count</a>) {</div>
<div class="line"><a name="l02059"></a><span class="lineno"> 2059</span>&#160;        <span class="comment">// Span was completely freed by this block. Due to the INVALID_POINTER spin lock</span></div>
<div class="line"><a name="l02060"></a><span class="lineno"> 2060</span>&#160;        <span class="comment">// no other thread can reach this state simultaneously on this span.</span></div>
<div class="line"><a name="l02061"></a><span class="lineno"> 2061</span>&#160;        <span class="comment">// Safe to move to owner heap deferred cache</span></div>
<div class="line"><a name="l02062"></a><span class="lineno"> 2062</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span);</div>
<div class="line"><a name="l02063"></a><span class="lineno"> 2063</span>&#160;    }</div>
<div class="line"><a name="l02064"></a><span class="lineno"> 2064</span>&#160;}</div>
<div class="line"><a name="l02065"></a><span class="lineno"> 2065</span>&#160; </div>
<div class="line"><a name="l02066"></a><span class="lineno"> 2066</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02067"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e"> 2067</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e">_rpmalloc_deallocate_small_or_medium</a>(<a class="code" href="structspan__t.html">span_t</a>* span, <span class="keywordtype">void</span>* p) {</div>
<div class="line"><a name="l02068"></a><span class="lineno"> 2068</span>&#160;    <a class="code" href="rpmalloc_8c.html#ab3168e56cb172bc471c410e9daaf7ca1">_rpmalloc_stat_inc_free</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>);</div>
<div class="line"><a name="l02069"></a><span class="lineno"> 2069</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a>) {</div>
<div class="line"><a name="l02070"></a><span class="lineno"> 2070</span>&#160;        <span class="comment">//Realign pointer to block start</span></div>
<div class="line"><a name="l02071"></a><span class="lineno"> 2071</span>&#160;        <span class="keywordtype">void</span>* blocks_start = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02072"></a><span class="lineno"> 2072</span>&#160;        <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_offset = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, blocks_start);</div>
<div class="line"><a name="l02073"></a><span class="lineno"> 2073</span>&#160;        p = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(p, -(int32_t)(block_offset % span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>));</div>
<div class="line"><a name="l02074"></a><span class="lineno"> 2074</span>&#160;    }</div>
<div class="line"><a name="l02075"></a><span class="lineno"> 2075</span>&#160;    <span class="comment">//Check if block belongs to this heap or if deallocation should be deferred</span></div>
<div class="line"><a name="l02076"></a><span class="lineno"> 2076</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02077"></a><span class="lineno"> 2077</span>&#160;    <span class="keywordtype">int</span> defer = (span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> &amp;&amp; (span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02078"></a><span class="lineno"> 2078</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02079"></a><span class="lineno"> 2079</span>&#160;    <span class="keywordtype">int</span> defer = ((span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02080"></a><span class="lineno"> 2080</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02081"></a><span class="lineno"> 2081</span>&#160;    <span class="keywordflow">if</span> (!defer)</div>
<div class="line"><a name="l02082"></a><span class="lineno"> 2082</span>&#160;        <a class="code" href="rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e">_rpmalloc_deallocate_direct_small_or_medium</a>(span, p);</div>
<div class="line"><a name="l02083"></a><span class="lineno"> 2083</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02084"></a><span class="lineno"> 2084</span>&#160;        <a class="code" href="rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801">_rpmalloc_deallocate_defer_small_or_medium</a>(span, p);</div>
<div class="line"><a name="l02085"></a><span class="lineno"> 2085</span>&#160;}</div>
<div class="line"><a name="l02086"></a><span class="lineno"> 2086</span>&#160; </div>
<div class="line"><a name="l02088"></a><span class="lineno"> 2088</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02089"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f"> 2089</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f">_rpmalloc_deallocate_large</a>(<a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l02090"></a><span class="lineno"> 2090</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>);</div>
<div class="line"><a name="l02091"></a><span class="lineno"> 2091</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!(span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || !(span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>));</div>
<div class="line"><a name="l02092"></a><span class="lineno"> 2092</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>((span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) || (span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a>));</div>
<div class="line"><a name="l02093"></a><span class="lineno"> 2093</span>&#160;    <span class="comment">//We must always defer (unless finalizing) if from another heap since we cannot touch the list or counters of another heap</span></div>
<div class="line"><a name="l02094"></a><span class="lineno"> 2094</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02095"></a><span class="lineno"> 2095</span>&#160;    <span class="keywordtype">int</span> defer = (span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> &amp;&amp; (span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02096"></a><span class="lineno"> 2096</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02097"></a><span class="lineno"> 2097</span>&#160;    <span class="keywordtype">int</span> defer = ((span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02098"></a><span class="lineno"> 2098</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02099"></a><span class="lineno"> 2099</span>&#160;    <span class="keywordflow">if</span> (defer) {</div>
<div class="line"><a name="l02100"></a><span class="lineno"> 2100</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span);</div>
<div class="line"><a name="l02101"></a><span class="lineno"> 2101</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02102"></a><span class="lineno"> 2102</span>&#160;    }</div>
<div class="line"><a name="l02103"></a><span class="lineno"> 2103</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>);</div>
<div class="line"><a name="l02104"></a><span class="lineno"> 2104</span>&#160;    --span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02105"></a><span class="lineno"> 2105</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02106"></a><span class="lineno"> 2106</span>&#160;    <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02107"></a><span class="lineno"> 2107</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02108"></a><span class="lineno"> 2108</span>&#160;<span class="preprocessor">#if ENABLE_ADAPTIVE_THREAD_CACHE || ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02109"></a><span class="lineno"> 2109</span>&#160;    <span class="comment">//Decrease counter</span></div>
<div class="line"><a name="l02110"></a><span class="lineno"> 2110</span>&#160;    <span class="keywordtype">size_t</span> idx = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> - 1;</div>
<div class="line"><a name="l02111"></a><span class="lineno"> 2111</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;span_use[idx].current);</div>
<div class="line"><a name="l02112"></a><span class="lineno"> 2112</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02113"></a><span class="lineno"> 2113</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l02114"></a><span class="lineno"> 2114</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(heap);</div>
<div class="line"><a name="l02115"></a><span class="lineno"> 2115</span>&#160;    span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a> = heap;</div>
<div class="line"><a name="l02116"></a><span class="lineno"> 2116</span>&#160;    <span class="keywordflow">if</span> ((span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> &gt; 1) &amp;&amp; !heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> &amp;&amp; !heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a>) {</div>
<div class="line"><a name="l02117"></a><span class="lineno"> 2117</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">span_reserve</a> = span;</div>
<div class="line"><a name="l02118"></a><span class="lineno"> 2118</span>&#160;        heap-&gt;<a class="code" href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">spans_reserved</a> = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02119"></a><span class="lineno"> 2119</span>&#160;        <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>) {</div>
<div class="line"><a name="l02120"></a><span class="lineno"> 2120</span>&#160;            heap-&gt;<a class="code" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a> = span;</div>
<div class="line"><a name="l02121"></a><span class="lineno"> 2121</span>&#160;        } <span class="keywordflow">else</span> { <span class="comment">//SPAN_FLAG_SUBSPAN</span></div>
<div class="line"><a name="l02122"></a><span class="lineno"> 2122</span>&#160;            <a class="code" href="structspan__t.html">span_t</a>* master = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, -(intptr_t)((size_t)span-&gt;<a class="code" href="structspan__t.html#a07d2ba73260e7e5dbe98c76436888c5f">offset_from_master</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>));</div>
<div class="line"><a name="l02123"></a><span class="lineno"> 2123</span>&#160;            heap-&gt;<a class="code" href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">span_reserve_master</a> = master;</div>
<div class="line"><a name="l02124"></a><span class="lineno"> 2124</span>&#160;            <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(master-&gt;<a class="code" href="structspan__t.html#a4de89d484559557bb639a2703c750b17">flags</a> &amp; <a class="code" href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a>);</div>
<div class="line"><a name="l02125"></a><span class="lineno"> 2125</span>&#160;            <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(atomic_load32(&amp;master-&gt;<a class="code" href="structspan__t.html#a4aecbd1cbb36425fddd53125ea1a84c7">remaining_spans</a>) &gt;= (int32_t)span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>);</div>
<div class="line"><a name="l02126"></a><span class="lineno"> 2126</span>&#160;        }</div>
<div class="line"><a name="l02127"></a><span class="lineno"> 2127</span>&#160;        <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;heap-&gt;span_use[idx].spans_to_reserved);</div>
<div class="line"><a name="l02128"></a><span class="lineno"> 2128</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02129"></a><span class="lineno"> 2129</span>&#160;        <span class="comment">//Insert into cache list</span></div>
<div class="line"><a name="l02130"></a><span class="lineno"> 2130</span>&#160;        <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l02131"></a><span class="lineno"> 2131</span>&#160;    }</div>
<div class="line"><a name="l02132"></a><span class="lineno"> 2132</span>&#160;}</div>
<div class="line"><a name="l02133"></a><span class="lineno"> 2133</span>&#160; </div>
<div class="line"><a name="l02135"></a><span class="lineno"> 2135</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02136"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46"> 2136</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46">_rpmalloc_deallocate_huge</a>(<a class="code" href="structspan__t.html">span_t</a>* span) {</div>
<div class="line"><a name="l02137"></a><span class="lineno"> 2137</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>);</div>
<div class="line"><a name="l02138"></a><span class="lineno"> 2138</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02139"></a><span class="lineno"> 2139</span>&#160;    <span class="keywordtype">int</span> defer = (span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> &amp;&amp; (span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02140"></a><span class="lineno"> 2140</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02141"></a><span class="lineno"> 2141</span>&#160;    <span class="keywordtype">int</span> defer = ((span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> != <a class="code" href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a>()) &amp;&amp; !span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a>);</div>
<div class="line"><a name="l02142"></a><span class="lineno"> 2142</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02143"></a><span class="lineno"> 2143</span>&#160;    <span class="keywordflow">if</span> (defer) {</div>
<div class="line"><a name="l02144"></a><span class="lineno"> 2144</span>&#160;        <a class="code" href="rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>, span);</div>
<div class="line"><a name="l02145"></a><span class="lineno"> 2145</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02146"></a><span class="lineno"> 2146</span>&#160;    }</div>
<div class="line"><a name="l02147"></a><span class="lineno"> 2147</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>);</div>
<div class="line"><a name="l02148"></a><span class="lineno"> 2148</span>&#160;    --span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;<a class="code" href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">full_span_count</a>;</div>
<div class="line"><a name="l02149"></a><span class="lineno"> 2149</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02150"></a><span class="lineno"> 2150</span>&#160;    <a class="code" href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a>(&amp;span-&gt;<a class="code" href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">heap</a>-&gt;large_huge_span, span);</div>
<div class="line"><a name="l02151"></a><span class="lineno"> 2151</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02152"></a><span class="lineno"> 2152</span>&#160; </div>
<div class="line"><a name="l02153"></a><span class="lineno"> 2153</span>&#160;    <span class="comment">//Oversized allocation, page count is stored in span_count</span></div>
<div class="line"><a name="l02154"></a><span class="lineno"> 2154</span>&#160;    <span class="keywordtype">size_t</span> num_pages = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02155"></a><span class="lineno"> 2155</span>&#160;    <a class="code" href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a>(span, num_pages * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>, span-&gt;<a class="code" href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">align_offset</a>, num_pages * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>);</div>
<div class="line"><a name="l02156"></a><span class="lineno"> 2156</span>&#160;    <a class="code" href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a>(&amp;_huge_pages_current, num_pages);</div>
<div class="line"><a name="l02157"></a><span class="lineno"> 2157</span>&#160;}</div>
<div class="line"><a name="l02158"></a><span class="lineno"> 2158</span>&#160; </div>
<div class="line"><a name="l02160"></a><span class="lineno"> 2160</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02161"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800"> 2161</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(<span class="keywordtype">void</span>* p) {</div>
<div class="line"><a name="l02162"></a><span class="lineno"> 2162</span>&#160;    <span class="comment">//Grab the span (always at start of span, using span alignment)</span></div>
<div class="line"><a name="l02163"></a><span class="lineno"> 2163</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)((uintptr_t)p &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l02164"></a><span class="lineno"> 2164</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(!span))</div>
<div class="line"><a name="l02165"></a><span class="lineno"> 2165</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02166"></a><span class="lineno"> 2166</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>))</div>
<div class="line"><a name="l02167"></a><span class="lineno"> 2167</span>&#160;        <a class="code" href="rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e">_rpmalloc_deallocate_small_or_medium</a>(span, p);</div>
<div class="line"><a name="l02168"></a><span class="lineno"> 2168</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>)</div>
<div class="line"><a name="l02169"></a><span class="lineno"> 2169</span>&#160;        <a class="code" href="rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f">_rpmalloc_deallocate_large</a>(span);</div>
<div class="line"><a name="l02170"></a><span class="lineno"> 2170</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02171"></a><span class="lineno"> 2171</span>&#160;        <a class="code" href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46">_rpmalloc_deallocate_huge</a>(span);</div>
<div class="line"><a name="l02172"></a><span class="lineno"> 2172</span>&#160;}</div>
<div class="line"><a name="l02173"></a><span class="lineno"> 2173</span>&#160; </div>
<div class="line"><a name="l02174"></a><span class="lineno"> 2174</span>&#160; </div>
<div class="line"><a name="l02180"></a><span class="lineno"> 2180</span>&#160; </div>
<div class="line"><a name="l02181"></a><span class="lineno"> 2181</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l02182"></a><span class="lineno"> 2182</span>&#160;<a class="code" href="rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(<span class="keywordtype">void</span>* p);</div>
<div class="line"><a name="l02183"></a><span class="lineno"> 2183</span>&#160; </div>
<div class="line"><a name="l02185"></a><span class="lineno"> 2185</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02186"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62"> 2186</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">void</span>* p, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> oldsize, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags) {</div>
<div class="line"><a name="l02187"></a><span class="lineno"> 2187</span>&#160;    <span class="keywordflow">if</span> (p) {</div>
<div class="line"><a name="l02188"></a><span class="lineno"> 2188</span>&#160;        <span class="comment">//Grab the span using guaranteed span alignment</span></div>
<div class="line"><a name="l02189"></a><span class="lineno"> 2189</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)((uintptr_t)p &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l02190"></a><span class="lineno"> 2190</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>)) {</div>
<div class="line"><a name="l02191"></a><span class="lineno"> 2191</span>&#160;            <span class="comment">//Small/medium sized block</span></div>
<div class="line"><a name="l02192"></a><span class="lineno"> 2192</span>&#160;            <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> == 1);</div>
<div class="line"><a name="l02193"></a><span class="lineno"> 2193</span>&#160;            <span class="keywordtype">void</span>* blocks_start = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02194"></a><span class="lineno"> 2194</span>&#160;            <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_offset = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, blocks_start);</div>
<div class="line"><a name="l02195"></a><span class="lineno"> 2195</span>&#160;            <a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> block_idx = block_offset / span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>;</div>
<div class="line"><a name="l02196"></a><span class="lineno"> 2196</span>&#160;            <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(blocks_start, (<span class="keywordtype">size_t</span>)block_idx * span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>);</div>
<div class="line"><a name="l02197"></a><span class="lineno"> 2197</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02198"></a><span class="lineno"> 2198</span>&#160;                oldsize = (size_t)((ptrdiff_t)span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> - <a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, block));</div>
<div class="line"><a name="l02199"></a><span class="lineno"> 2199</span>&#160;            <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> &gt;= size) {</div>
<div class="line"><a name="l02200"></a><span class="lineno"> 2200</span>&#160;                <span class="comment">//Still fits in block, never mind trying to save memory, but preserve data if alignment changed</span></div>
<div class="line"><a name="l02201"></a><span class="lineno"> 2201</span>&#160;                <span class="keywordflow">if</span> ((p != block) &amp;&amp; !(flags &amp; <a class="code" href="rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02202"></a><span class="lineno"> 2202</span>&#160;                    memmove(block, p, oldsize);</div>
<div class="line"><a name="l02203"></a><span class="lineno"> 2203</span>&#160;                <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02204"></a><span class="lineno"> 2204</span>&#160;            }</div>
<div class="line"><a name="l02205"></a><span class="lineno"> 2205</span>&#160;        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>) {</div>
<div class="line"><a name="l02206"></a><span class="lineno"> 2206</span>&#160;            <span class="comment">//Large block</span></div>
<div class="line"><a name="l02207"></a><span class="lineno"> 2207</span>&#160;            <span class="keywordtype">size_t</span> total_size = size + <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02208"></a><span class="lineno"> 2208</span>&#160;            <span class="keywordtype">size_t</span> num_spans = total_size &gt;&gt; <a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l02209"></a><span class="lineno"> 2209</span>&#160;            <span class="keywordflow">if</span> (total_size &amp; (<a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a> - 1))</div>
<div class="line"><a name="l02210"></a><span class="lineno"> 2210</span>&#160;                ++num_spans;</div>
<div class="line"><a name="l02211"></a><span class="lineno"> 2211</span>&#160;            <span class="keywordtype">size_t</span> current_spans = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02212"></a><span class="lineno"> 2212</span>&#160;            <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02213"></a><span class="lineno"> 2213</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02214"></a><span class="lineno"> 2214</span>&#160;                oldsize = (current_spans * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) - (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, block) - <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02215"></a><span class="lineno"> 2215</span>&#160;            <span class="keywordflow">if</span> ((current_spans &gt;= num_spans) &amp;&amp; (total_size &gt;= (oldsize / 2))) {</div>
<div class="line"><a name="l02216"></a><span class="lineno"> 2216</span>&#160;                <span class="comment">//Still fits in block, never mind trying to save memory, but preserve data if alignment changed</span></div>
<div class="line"><a name="l02217"></a><span class="lineno"> 2217</span>&#160;                <span class="keywordflow">if</span> ((p != block) &amp;&amp; !(flags &amp; <a class="code" href="rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02218"></a><span class="lineno"> 2218</span>&#160;                    memmove(block, p, oldsize);</div>
<div class="line"><a name="l02219"></a><span class="lineno"> 2219</span>&#160;                <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02220"></a><span class="lineno"> 2220</span>&#160;            }</div>
<div class="line"><a name="l02221"></a><span class="lineno"> 2221</span>&#160;        } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02222"></a><span class="lineno"> 2222</span>&#160;            <span class="comment">//Oversized block</span></div>
<div class="line"><a name="l02223"></a><span class="lineno"> 2223</span>&#160;            <span class="keywordtype">size_t</span> total_size = size + <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02224"></a><span class="lineno"> 2224</span>&#160;            <span class="keywordtype">size_t</span> num_pages = total_size &gt;&gt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l02225"></a><span class="lineno"> 2225</span>&#160;            <span class="keywordflow">if</span> (total_size &amp; (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> - 1))</div>
<div class="line"><a name="l02226"></a><span class="lineno"> 2226</span>&#160;                ++num_pages;</div>
<div class="line"><a name="l02227"></a><span class="lineno"> 2227</span>&#160;            <span class="comment">//Page count is stored in span_count</span></div>
<div class="line"><a name="l02228"></a><span class="lineno"> 2228</span>&#160;            <span class="keywordtype">size_t</span> current_pages = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02229"></a><span class="lineno"> 2229</span>&#160;            <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02230"></a><span class="lineno"> 2230</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02231"></a><span class="lineno"> 2231</span>&#160;                oldsize = (current_pages * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) - (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, block) - <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>;</div>
<div class="line"><a name="l02232"></a><span class="lineno"> 2232</span>&#160;            <span class="keywordflow">if</span> ((current_pages &gt;= num_pages) &amp;&amp; (num_pages &gt;= (current_pages / 2))) {</div>
<div class="line"><a name="l02233"></a><span class="lineno"> 2233</span>&#160;                <span class="comment">//Still fits in block, never mind trying to save memory, but preserve data if alignment changed</span></div>
<div class="line"><a name="l02234"></a><span class="lineno"> 2234</span>&#160;                <span class="keywordflow">if</span> ((p != block) &amp;&amp; !(flags &amp; <a class="code" href="rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02235"></a><span class="lineno"> 2235</span>&#160;                    memmove(block, p, oldsize);</div>
<div class="line"><a name="l02236"></a><span class="lineno"> 2236</span>&#160;                <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02237"></a><span class="lineno"> 2237</span>&#160;            }</div>
<div class="line"><a name="l02238"></a><span class="lineno"> 2238</span>&#160;        }</div>
<div class="line"><a name="l02239"></a><span class="lineno"> 2239</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02240"></a><span class="lineno"> 2240</span>&#160;        oldsize = 0;</div>
<div class="line"><a name="l02241"></a><span class="lineno"> 2241</span>&#160;    }</div>
<div class="line"><a name="l02242"></a><span class="lineno"> 2242</span>&#160; </div>
<div class="line"><a name="l02243"></a><span class="lineno"> 2243</span>&#160;    <span class="keywordflow">if</span> (!!(flags &amp; <a class="code" href="rpmalloc_8h.html#ab3774a093749aeca1d4e387b11e79395">RPMALLOC_GROW_OR_FAIL</a>))</div>
<div class="line"><a name="l02244"></a><span class="lineno"> 2244</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02245"></a><span class="lineno"> 2245</span>&#160; </div>
<div class="line"><a name="l02246"></a><span class="lineno"> 2246</span>&#160;    <span class="comment">//Size is greater than block size, need to allocate a new block and deallocate the old</span></div>
<div class="line"><a name="l02247"></a><span class="lineno"> 2247</span>&#160;    <span class="comment">//Avoid hysteresis by overallocating if increase is small (below 37%)</span></div>
<div class="line"><a name="l02248"></a><span class="lineno"> 2248</span>&#160;    <span class="keywordtype">size_t</span> lower_bound = oldsize + (oldsize &gt;&gt; 2) + (oldsize &gt;&gt; 3);</div>
<div class="line"><a name="l02249"></a><span class="lineno"> 2249</span>&#160;    <span class="keywordtype">size_t</span> new_size = (size &gt; lower_bound) ? size : ((size &gt; oldsize) ? lower_bound : size);</div>
<div class="line"><a name="l02250"></a><span class="lineno"> 2250</span>&#160;    <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, new_size);</div>
<div class="line"><a name="l02251"></a><span class="lineno"> 2251</span>&#160;    <span class="keywordflow">if</span> (p &amp;&amp; block) {</div>
<div class="line"><a name="l02252"></a><span class="lineno"> 2252</span>&#160;        <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>))</div>
<div class="line"><a name="l02253"></a><span class="lineno"> 2253</span>&#160;            memcpy(block, p, oldsize &lt; new_size ? oldsize : new_size);</div>
<div class="line"><a name="l02254"></a><span class="lineno"> 2254</span>&#160;        <a class="code" href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(p);</div>
<div class="line"><a name="l02255"></a><span class="lineno"> 2255</span>&#160;    }</div>
<div class="line"><a name="l02256"></a><span class="lineno"> 2256</span>&#160; </div>
<div class="line"><a name="l02257"></a><span class="lineno"> 2257</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02258"></a><span class="lineno"> 2258</span>&#160;}</div>
<div class="line"><a name="l02259"></a><span class="lineno"> 2259</span>&#160; </div>
<div class="line"><a name="l02260"></a><span class="lineno"> 2260</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02261"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c"> 2261</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a>(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">void</span>* ptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> oldsize,</div>
<div class="line"><a name="l02262"></a><span class="lineno"> 2262</span>&#160;                           <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags) {</div>
<div class="line"><a name="l02263"></a><span class="lineno"> 2263</span>&#160;    <span class="keywordflow">if</span> (alignment &lt;= <a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>)</div>
<div class="line"><a name="l02264"></a><span class="lineno"> 2264</span>&#160;        <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(heap, ptr, size, oldsize, flags);</div>
<div class="line"><a name="l02265"></a><span class="lineno"> 2265</span>&#160; </div>
<div class="line"><a name="l02266"></a><span class="lineno"> 2266</span>&#160;    <span class="keywordtype">int</span> no_alloc = !!(flags &amp; <a class="code" href="rpmalloc_8h.html#ab3774a093749aeca1d4e387b11e79395">RPMALLOC_GROW_OR_FAIL</a>);</div>
<div class="line"><a name="l02267"></a><span class="lineno"> 2267</span>&#160;    <span class="keywordtype">size_t</span> usablesize = (ptr ? <a class="code" href="rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(ptr) : 0);</div>
<div class="line"><a name="l02268"></a><span class="lineno"> 2268</span>&#160;    <span class="keywordflow">if</span> ((usablesize &gt;= size) &amp;&amp; !((uintptr_t)ptr &amp; (alignment - 1))) {</div>
<div class="line"><a name="l02269"></a><span class="lineno"> 2269</span>&#160;        <span class="keywordflow">if</span> (no_alloc || (size &gt;= (usablesize / 2)))</div>
<div class="line"><a name="l02270"></a><span class="lineno"> 2270</span>&#160;            <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02271"></a><span class="lineno"> 2271</span>&#160;    }</div>
<div class="line"><a name="l02272"></a><span class="lineno"> 2272</span>&#160;    <span class="comment">// Aligned alloc marks span as having aligned blocks</span></div>
<div class="line"><a name="l02273"></a><span class="lineno"> 2273</span>&#160;    <span class="keywordtype">void</span>* block = (!no_alloc ? <a class="code" href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, size) : 0);</div>
<div class="line"><a name="l02274"></a><span class="lineno"> 2274</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a>(block != 0)) {</div>
<div class="line"><a name="l02275"></a><span class="lineno"> 2275</span>&#160;        <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a>) &amp;&amp; ptr) {</div>
<div class="line"><a name="l02276"></a><span class="lineno"> 2276</span>&#160;            <span class="keywordflow">if</span> (!oldsize)</div>
<div class="line"><a name="l02277"></a><span class="lineno"> 2277</span>&#160;                oldsize = usablesize;</div>
<div class="line"><a name="l02278"></a><span class="lineno"> 2278</span>&#160;            memcpy(block, ptr, oldsize &lt; size ? oldsize : size);</div>
<div class="line"><a name="l02279"></a><span class="lineno"> 2279</span>&#160;        }</div>
<div class="line"><a name="l02280"></a><span class="lineno"> 2280</span>&#160;        <a class="code" href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(ptr);</div>
<div class="line"><a name="l02281"></a><span class="lineno"> 2281</span>&#160;    }</div>
<div class="line"><a name="l02282"></a><span class="lineno"> 2282</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02283"></a><span class="lineno"> 2283</span>&#160;}</div>
<div class="line"><a name="l02284"></a><span class="lineno"> 2284</span>&#160; </div>
<div class="line"><a name="l02285"></a><span class="lineno"> 2285</span>&#160; </div>
<div class="line"><a name="l02291"></a><span class="lineno"> 2291</span>&#160; </div>
<div class="line"><a name="l02293"></a><span class="lineno"> 2293</span>&#160;<span class="keyword">static</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l02294"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208"> 2294</a></span>&#160;<a class="code" href="rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(<span class="keywordtype">void</span>* p) {</div>
<div class="line"><a name="l02295"></a><span class="lineno"> 2295</span>&#160;    <span class="comment">//Grab the span using guaranteed span alignment</span></div>
<div class="line"><a name="l02296"></a><span class="lineno"> 2296</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span = (<a class="code" href="structspan__t.html">span_t</a>*)((uintptr_t)p &amp; <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a>);</div>
<div class="line"><a name="l02297"></a><span class="lineno"> 2297</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>) {</div>
<div class="line"><a name="l02298"></a><span class="lineno"> 2298</span>&#160;        <span class="comment">//Small/medium block</span></div>
<div class="line"><a name="l02299"></a><span class="lineno"> 2299</span>&#160;        <span class="keywordtype">void</span>* blocks_start = <a class="code" href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a>(span, <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>);</div>
<div class="line"><a name="l02300"></a><span class="lineno"> 2300</span>&#160;        <span class="keywordflow">return</span> span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a> - ((size_t)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, blocks_start) % span-&gt;<a class="code" href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">block_size</a>);</div>
<div class="line"><a name="l02301"></a><span class="lineno"> 2301</span>&#160;    }</div>
<div class="line"><a name="l02302"></a><span class="lineno"> 2302</span>&#160;    <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a>) {</div>
<div class="line"><a name="l02303"></a><span class="lineno"> 2303</span>&#160;        <span class="comment">//Large block</span></div>
<div class="line"><a name="l02304"></a><span class="lineno"> 2304</span>&#160;        <span class="keywordtype">size_t</span> current_spans = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02305"></a><span class="lineno"> 2305</span>&#160;        <span class="keywordflow">return</span> (current_spans * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) - (size_t)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, span);</div>
<div class="line"><a name="l02306"></a><span class="lineno"> 2306</span>&#160;    }</div>
<div class="line"><a name="l02307"></a><span class="lineno"> 2307</span>&#160;    <span class="comment">//Oversized block, page count is stored in span_count</span></div>
<div class="line"><a name="l02308"></a><span class="lineno"> 2308</span>&#160;    <span class="keywordtype">size_t</span> current_pages = span-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a>;</div>
<div class="line"><a name="l02309"></a><span class="lineno"> 2309</span>&#160;    <span class="keywordflow">return</span> (current_pages * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) - (size_t)<a class="code" href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a>(p, span);</div>
<div class="line"><a name="l02310"></a><span class="lineno"> 2310</span>&#160;}</div>
<div class="line"><a name="l02311"></a><span class="lineno"> 2311</span>&#160; </div>
<div class="line"><a name="l02313"></a><span class="lineno"> 2313</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02314"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9"> 2314</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(<span class="keywordtype">size_t</span> iclass) {</div>
<div class="line"><a name="l02315"></a><span class="lineno"> 2315</span>&#160;    <span class="keywordtype">size_t</span> block_size = <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l02316"></a><span class="lineno"> 2316</span>&#160;    <span class="keywordtype">size_t</span> block_count = (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> - <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>) / block_size;</div>
<div class="line"><a name="l02317"></a><span class="lineno"> 2317</span>&#160; </div>
<div class="line"><a name="l02318"></a><span class="lineno"> 2318</span>&#160;    <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a> = (uint16_t)block_count;</div>
<div class="line"><a name="l02319"></a><span class="lineno"> 2319</span>&#160;    <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#a7524fc81b83a0b54ef5ec3fb4563b69d">class_idx</a> = (uint16_t)iclass;</div>
<div class="line"><a name="l02320"></a><span class="lineno"> 2320</span>&#160; </div>
<div class="line"><a name="l02321"></a><span class="lineno"> 2321</span>&#160;    <span class="comment">//Check if previous size classes can be merged</span></div>
<div class="line"><a name="l02322"></a><span class="lineno"> 2322</span>&#160;    <span class="keywordflow">if</span> (iclass &gt;= <a class="code" href="rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a>) {</div>
<div class="line"><a name="l02323"></a><span class="lineno"> 2323</span>&#160;        <span class="keywordtype">size_t</span> prevclass = iclass;</div>
<div class="line"><a name="l02324"></a><span class="lineno"> 2324</span>&#160;        <span class="keywordflow">while</span> (prevclass &gt; 0) {</div>
<div class="line"><a name="l02325"></a><span class="lineno"> 2325</span>&#160;            --prevclass;</div>
<div class="line"><a name="l02326"></a><span class="lineno"> 2326</span>&#160;            <span class="comment">//A class can be merged if number of pages and number of blocks are equal</span></div>
<div class="line"><a name="l02327"></a><span class="lineno"> 2327</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[prevclass].block_count == <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].block_count)</div>
<div class="line"><a name="l02328"></a><span class="lineno"> 2328</span>&#160;                memcpy(<a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + prevclass, <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + iclass, <span class="keyword">sizeof</span>(<a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass]));</div>
<div class="line"><a name="l02329"></a><span class="lineno"> 2329</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l02330"></a><span class="lineno"> 2330</span>&#160;                <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02331"></a><span class="lineno"> 2331</span>&#160;        }</div>
<div class="line"><a name="l02332"></a><span class="lineno"> 2332</span>&#160;    }</div>
<div class="line"><a name="l02333"></a><span class="lineno"> 2333</span>&#160;}</div>
<div class="line"><a name="l02334"></a><span class="lineno"> 2334</span>&#160; </div>
<div class="line"><a name="l02336"></a><span class="lineno"> 2336</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l02337"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a24bbaa4b2e6a5524d4ba62a6c9c939df"> 2337</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5">rpmalloc_initialize</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02338"></a><span class="lineno"> 2338</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a>) {</div>
<div class="line"><a name="l02339"></a><span class="lineno"> 2339</span>&#160;        <a class="code" href="rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>();</div>
<div class="line"><a name="l02340"></a><span class="lineno"> 2340</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02341"></a><span class="lineno"> 2341</span>&#160;    }</div>
<div class="line"><a name="l02342"></a><span class="lineno"> 2342</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05">rpmalloc_initialize_config</a>(0);</div>
<div class="line"><a name="l02343"></a><span class="lineno"> 2343</span>&#160;}</div>
<div class="line"><a name="l02344"></a><span class="lineno"> 2344</span>&#160; </div>
<div class="line"><a name="l02345"></a><span class="lineno"> 2345</span>&#160;<span class="keywordtype">int</span></div>
<div class="line"><a name="l02346"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a2159e8de05a62e3697024fd2aec1a8c2"> 2346</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05">rpmalloc_initialize_config</a>(<span class="keyword">const</span> <a class="code" href="structrpmalloc__config__t.html">rpmalloc_config_t</a>* config) {</div>
<div class="line"><a name="l02347"></a><span class="lineno"> 2347</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a>) {</div>
<div class="line"><a name="l02348"></a><span class="lineno"> 2348</span>&#160;        <a class="code" href="rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>();</div>
<div class="line"><a name="l02349"></a><span class="lineno"> 2349</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02350"></a><span class="lineno"> 2350</span>&#160;    }</div>
<div class="line"><a name="l02351"></a><span class="lineno"> 2351</span>&#160;    <a class="code" href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a> = 1;</div>
<div class="line"><a name="l02352"></a><span class="lineno"> 2352</span>&#160; </div>
<div class="line"><a name="l02353"></a><span class="lineno"> 2353</span>&#160;    <span class="keywordflow">if</span> (config)</div>
<div class="line"><a name="l02354"></a><span class="lineno"> 2354</span>&#160;        memcpy(&amp;<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>, config, <span class="keyword">sizeof</span>(<a class="code" href="structrpmalloc__config__t.html">rpmalloc_config_t</a>));</div>
<div class="line"><a name="l02355"></a><span class="lineno"> 2355</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02356"></a><span class="lineno"> 2356</span>&#160;        memset(&amp;<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structrpmalloc__config__t.html">rpmalloc_config_t</a>));</div>
<div class="line"><a name="l02357"></a><span class="lineno"> 2357</span>&#160; </div>
<div class="line"><a name="l02358"></a><span class="lineno"> 2358</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">memory_map</a> || !<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">memory_unmap</a>) {</div>
<div class="line"><a name="l02359"></a><span class="lineno"> 2359</span>&#160;        <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">memory_map</a> = <a class="code" href="rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a>;</div>
<div class="line"><a name="l02360"></a><span class="lineno"> 2360</span>&#160;        <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">memory_unmap</a> = <a class="code" href="rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">_rpmalloc_unmap_os</a>;</div>
<div class="line"><a name="l02361"></a><span class="lineno"> 2361</span>&#160;    }</div>
<div class="line"><a name="l02362"></a><span class="lineno"> 2362</span>&#160; </div>
<div class="line"><a name="l02363"></a><span class="lineno"> 2363</span>&#160;<span class="preprocessor">#if RPMALLOC_CONFIGURABLE</span></div>
<div class="line"><a name="l02364"></a><span class="lineno"> 2364</span>&#160;    <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#adcf8dfc992b8b4a4e6cd72e213bf1035">page_size</a>;</div>
<div class="line"><a name="l02365"></a><span class="lineno"> 2365</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02366"></a><span class="lineno"> 2366</span>&#160;    <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = 0;</div>
<div class="line"><a name="l02367"></a><span class="lineno"> 2367</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02368"></a><span class="lineno"> 2368</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 0;</div>
<div class="line"><a name="l02369"></a><span class="lineno"> 2369</span>&#160;    <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02370"></a><span class="lineno"> 2370</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>) {</div>
<div class="line"><a name="l02371"></a><span class="lineno"> 2371</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l02372"></a><span class="lineno"> 2372</span>&#160;        SYSTEM_INFO system_info;</div>
<div class="line"><a name="l02373"></a><span class="lineno"> 2373</span>&#160;        memset(&amp;system_info, 0, <span class="keyword">sizeof</span>(system_info));</div>
<div class="line"><a name="l02374"></a><span class="lineno"> 2374</span>&#160;        GetSystemInfo(&amp;system_info);</div>
<div class="line"><a name="l02375"></a><span class="lineno"> 2375</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = system_info.dwPageSize;</div>
<div class="line"><a name="l02376"></a><span class="lineno"> 2376</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = system_info.dwAllocationGranularity;</div>
<div class="line"><a name="l02377"></a><span class="lineno"> 2377</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02378"></a><span class="lineno"> 2378</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = (size_t)sysconf(_SC_PAGESIZE);</div>
<div class="line"><a name="l02379"></a><span class="lineno"> 2379</span>&#160;        <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02380"></a><span class="lineno"> 2380</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a>) {</div>
<div class="line"><a name="l02381"></a><span class="lineno"> 2381</span>&#160;<span class="preprocessor">#if defined(__linux__)</span></div>
<div class="line"><a name="l02382"></a><span class="lineno"> 2382</span>&#160;            <span class="keywordtype">size_t</span> huge_page_size = 0;</div>
<div class="line"><a name="l02383"></a><span class="lineno"> 2383</span>&#160;            FILE* meminfo = fopen(<span class="stringliteral">&quot;/proc/meminfo&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line"><a name="l02384"></a><span class="lineno"> 2384</span>&#160;            <span class="keywordflow">if</span> (meminfo) {</div>
<div class="line"><a name="l02385"></a><span class="lineno"> 2385</span>&#160;                <span class="keywordtype">char</span> line[128];</div>
<div class="line"><a name="l02386"></a><span class="lineno"> 2386</span>&#160;                <span class="keywordflow">while</span> (!huge_page_size &amp;&amp; fgets(line, <span class="keyword">sizeof</span>(line) - 1, meminfo)) {</div>
<div class="line"><a name="l02387"></a><span class="lineno"> 2387</span>&#160;                    line[<span class="keyword">sizeof</span>(line) - 1] = 0;</div>
<div class="line"><a name="l02388"></a><span class="lineno"> 2388</span>&#160;                    <span class="keywordflow">if</span> (strstr(line, <span class="stringliteral">&quot;Hugepagesize:&quot;</span>))</div>
<div class="line"><a name="l02389"></a><span class="lineno"> 2389</span>&#160;                        huge_page_size = (<span class="keywordtype">size_t</span>)strtol(line + 13, 0, 10) * 1024;</div>
<div class="line"><a name="l02390"></a><span class="lineno"> 2390</span>&#160;                }</div>
<div class="line"><a name="l02391"></a><span class="lineno"> 2391</span>&#160;                fclose(meminfo);</div>
<div class="line"><a name="l02392"></a><span class="lineno"> 2392</span>&#160;            }</div>
<div class="line"><a name="l02393"></a><span class="lineno"> 2393</span>&#160;            <span class="keywordflow">if</span> (huge_page_size) {</div>
<div class="line"><a name="l02394"></a><span class="lineno"> 2394</span>&#160;                <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02395"></a><span class="lineno"> 2395</span>&#160;                <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = huge_page_size;</div>
<div class="line"><a name="l02396"></a><span class="lineno"> 2396</span>&#160;                <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = huge_page_size;</div>
<div class="line"><a name="l02397"></a><span class="lineno"> 2397</span>&#160;            }</div>
<div class="line"><a name="l02398"></a><span class="lineno"> 2398</span>&#160;<span class="preprocessor">#elif defined(__FreeBSD__)</span></div>
<div class="line"><a name="l02399"></a><span class="lineno"> 2399</span>&#160;            <span class="keywordtype">int</span> rc;</div>
<div class="line"><a name="l02400"></a><span class="lineno"> 2400</span>&#160;            <span class="keywordtype">size_t</span> sz = <span class="keyword">sizeof</span>(rc);</div>
<div class="line"><a name="l02401"></a><span class="lineno"> 2401</span>&#160; </div>
<div class="line"><a name="l02402"></a><span class="lineno"> 2402</span>&#160;            <span class="keywordflow">if</span> (sysctlbyname(<span class="stringliteral">&quot;vm.pmap.pg_ps_enabled&quot;</span>, &amp;rc, &amp;sz, NULL, 0) == 0 &amp;&amp; rc == 1) {</div>
<div class="line"><a name="l02403"></a><span class="lineno"> 2403</span>&#160;                <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02404"></a><span class="lineno"> 2404</span>&#160;                <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = 2 * 1024 * 1024;</div>
<div class="line"><a name="l02405"></a><span class="lineno"> 2405</span>&#160;                <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02406"></a><span class="lineno"> 2406</span>&#160;            }</div>
<div class="line"><a name="l02407"></a><span class="lineno"> 2407</span>&#160;<span class="preprocessor">#elif defined(__APPLE__)</span></div>
<div class="line"><a name="l02408"></a><span class="lineno"> 2408</span>&#160;            <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02409"></a><span class="lineno"> 2409</span>&#160;            <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = 2 * 1024 * 1024;</div>
<div class="line"><a name="l02410"></a><span class="lineno"> 2410</span>&#160;            <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02411"></a><span class="lineno"> 2411</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02412"></a><span class="lineno"> 2412</span>&#160;        }</div>
<div class="line"><a name="l02413"></a><span class="lineno"> 2413</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02414"></a><span class="lineno"> 2414</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02415"></a><span class="lineno"> 2415</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a>)</div>
<div class="line"><a name="l02416"></a><span class="lineno"> 2416</span>&#160;            <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02417"></a><span class="lineno"> 2417</span>&#160;    }</div>
<div class="line"><a name="l02418"></a><span class="lineno"> 2418</span>&#160; </div>
<div class="line"><a name="l02419"></a><span class="lineno"> 2419</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l02420"></a><span class="lineno"> 2420</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a>) {</div>
<div class="line"><a name="l02421"></a><span class="lineno"> 2421</span>&#160;        HANDLE token = 0;</div>
<div class="line"><a name="l02422"></a><span class="lineno"> 2422</span>&#160;        <span class="keywordtype">size_t</span> large_page_minimum = GetLargePageMinimum();</div>
<div class="line"><a name="l02423"></a><span class="lineno"> 2423</span>&#160;        <span class="keywordflow">if</span> (large_page_minimum)</div>
<div class="line"><a name="l02424"></a><span class="lineno"> 2424</span>&#160;            OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;token);</div>
<div class="line"><a name="l02425"></a><span class="lineno"> 2425</span>&#160;        <span class="keywordflow">if</span> (token) {</div>
<div class="line"><a name="l02426"></a><span class="lineno"> 2426</span>&#160;            LUID luid;</div>
<div class="line"><a name="l02427"></a><span class="lineno"> 2427</span>&#160;            <span class="keywordflow">if</span> (LookupPrivilegeValue(0, SE_LOCK_MEMORY_NAME, &amp;luid)) {</div>
<div class="line"><a name="l02428"></a><span class="lineno"> 2428</span>&#160;                TOKEN_PRIVILEGES token_privileges;</div>
<div class="line"><a name="l02429"></a><span class="lineno"> 2429</span>&#160;                memset(&amp;token_privileges, 0, <span class="keyword">sizeof</span>(token_privileges));</div>
<div class="line"><a name="l02430"></a><span class="lineno"> 2430</span>&#160;                token_privileges.PrivilegeCount = 1;</div>
<div class="line"><a name="l02431"></a><span class="lineno"> 2431</span>&#160;                token_privileges.Privileges[0].Luid = luid;</div>
<div class="line"><a name="l02432"></a><span class="lineno"> 2432</span>&#160;                token_privileges.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;</div>
<div class="line"><a name="l02433"></a><span class="lineno"> 2433</span>&#160;                <span class="keywordflow">if</span> (AdjustTokenPrivileges(token, FALSE, &amp;token_privileges, 0, 0, 0)) {</div>
<div class="line"><a name="l02434"></a><span class="lineno"> 2434</span>&#160;                    DWORD err = GetLastError();</div>
<div class="line"><a name="l02435"></a><span class="lineno"> 2435</span>&#160;                    <span class="keywordflow">if</span> (err == ERROR_SUCCESS) {</div>
<div class="line"><a name="l02436"></a><span class="lineno"> 2436</span>&#160;                        <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a> = 1;</div>
<div class="line"><a name="l02437"></a><span class="lineno"> 2437</span>&#160;                        <span class="keywordflow">if</span> (large_page_minimum &gt; <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l02438"></a><span class="lineno"> 2438</span>&#160;                            <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = large_page_minimum;</div>
<div class="line"><a name="l02439"></a><span class="lineno"> 2439</span>&#160;                        <span class="keywordflow">if</span> (large_page_minimum &gt; <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a>)</div>
<div class="line"><a name="l02440"></a><span class="lineno"> 2440</span>&#160;                            <a class="code" href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a> = large_page_minimum;</div>
<div class="line"><a name="l02441"></a><span class="lineno"> 2441</span>&#160;                    }</div>
<div class="line"><a name="l02442"></a><span class="lineno"> 2442</span>&#160;                }</div>
<div class="line"><a name="l02443"></a><span class="lineno"> 2443</span>&#160;            }</div>
<div class="line"><a name="l02444"></a><span class="lineno"> 2444</span>&#160;            CloseHandle(token);</div>
<div class="line"><a name="l02445"></a><span class="lineno"> 2445</span>&#160;        }</div>
<div class="line"><a name="l02446"></a><span class="lineno"> 2446</span>&#160;    }</div>
<div class="line"><a name="l02447"></a><span class="lineno"> 2447</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02448"></a><span class="lineno"> 2448</span>&#160; </div>
<div class="line"><a name="l02449"></a><span class="lineno"> 2449</span>&#160;    <span class="keywordtype">size_t</span> min_span_size = 256;</div>
<div class="line"><a name="l02450"></a><span class="lineno"> 2450</span>&#160;    <span class="keywordtype">size_t</span> max_page_size;</div>
<div class="line"><a name="l02451"></a><span class="lineno"> 2451</span>&#160;<span class="preprocessor">#if UINTPTR_MAX &gt; 0xFFFFFFFF</span></div>
<div class="line"><a name="l02452"></a><span class="lineno"> 2452</span>&#160;    max_page_size = 4096ULL * 1024ULL * 1024ULL;</div>
<div class="line"><a name="l02453"></a><span class="lineno"> 2453</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02454"></a><span class="lineno"> 2454</span>&#160;    max_page_size = 4 * 1024 * 1024;</div>
<div class="line"><a name="l02455"></a><span class="lineno"> 2455</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02456"></a><span class="lineno"> 2456</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &lt; min_span_size)</div>
<div class="line"><a name="l02457"></a><span class="lineno"> 2457</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = min_span_size;</div>
<div class="line"><a name="l02458"></a><span class="lineno"> 2458</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt; max_page_size)</div>
<div class="line"><a name="l02459"></a><span class="lineno"> 2459</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = max_page_size;</div>
<div class="line"><a name="l02460"></a><span class="lineno"> 2460</span>&#160;    <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a> = 0;</div>
<div class="line"><a name="l02461"></a><span class="lineno"> 2461</span>&#160;    <span class="keywordtype">size_t</span> page_size_bit = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02462"></a><span class="lineno"> 2462</span>&#160;    <span class="keywordflow">while</span> (page_size_bit != 1) {</div>
<div class="line"><a name="l02463"></a><span class="lineno"> 2463</span>&#160;        ++<a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>;</div>
<div class="line"><a name="l02464"></a><span class="lineno"> 2464</span>&#160;        page_size_bit &gt;&gt;= 1;</div>
<div class="line"><a name="l02465"></a><span class="lineno"> 2465</span>&#160;    }</div>
<div class="line"><a name="l02466"></a><span class="lineno"> 2466</span>&#160;    <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> = ((size_t)1 &lt;&lt; <a class="code" href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a>);</div>
<div class="line"><a name="l02467"></a><span class="lineno"> 2467</span>&#160; </div>
<div class="line"><a name="l02468"></a><span class="lineno"> 2468</span>&#160;<span class="preprocessor">#if RPMALLOC_CONFIGURABLE</span></div>
<div class="line"><a name="l02469"></a><span class="lineno"> 2469</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">span_size</a>) {</div>
<div class="line"><a name="l02470"></a><span class="lineno"> 2470</span>&#160;        <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> = <a class="code" href="rpmalloc_8c.html#a04a025a8c2529bc60cb95c78d3948c52">_memory_default_span_size</a>;</div>
<div class="line"><a name="l02471"></a><span class="lineno"> 2471</span>&#160;        <a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a> = <a class="code" href="rpmalloc_8c.html#a3dedf1d71cda4a8f3d1f372934ddad30">_memory_default_span_size_shift</a>;</div>
<div class="line"><a name="l02472"></a><span class="lineno"> 2472</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a> = <a class="code" href="rpmalloc_8c.html#ada0a343b3498bb882ebd7e0c3caa0935">_memory_default_span_mask</a>;</div>
<div class="line"><a name="l02473"></a><span class="lineno"> 2473</span>&#160;    } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l02474"></a><span class="lineno"> 2474</span>&#160;        <span class="keywordtype">size_t</span> span_size = <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">span_size</a>;</div>
<div class="line"><a name="l02475"></a><span class="lineno"> 2475</span>&#160;        <span class="keywordflow">if</span> (span_size &gt; (256 * 1024))</div>
<div class="line"><a name="l02476"></a><span class="lineno"> 2476</span>&#160;            span_size = (256 * 1024);</div>
<div class="line"><a name="l02477"></a><span class="lineno"> 2477</span>&#160;        <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> = 4096;</div>
<div class="line"><a name="l02478"></a><span class="lineno"> 2478</span>&#160;        <a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a> = 12;</div>
<div class="line"><a name="l02479"></a><span class="lineno"> 2479</span>&#160;        <span class="keywordflow">while</span> (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> &lt; span_size) {</div>
<div class="line"><a name="l02480"></a><span class="lineno"> 2480</span>&#160;            <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> &lt;&lt;= 1;</div>
<div class="line"><a name="l02481"></a><span class="lineno"> 2481</span>&#160;            ++<a class="code" href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a>;</div>
<div class="line"><a name="l02482"></a><span class="lineno"> 2482</span>&#160;        }</div>
<div class="line"><a name="l02483"></a><span class="lineno"> 2483</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a> = ~(uintptr_t)(<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> - 1);</div>
<div class="line"><a name="l02484"></a><span class="lineno"> 2484</span>&#160;    }</div>
<div class="line"><a name="l02485"></a><span class="lineno"> 2485</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02486"></a><span class="lineno"> 2486</span>&#160; </div>
<div class="line"><a name="l02487"></a><span class="lineno"> 2487</span>&#160;    <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> = ( <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">span_map_count</a> ? <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">span_map_count</a> : <a class="code" href="rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">DEFAULT_SPAN_MAP_COUNT</a>);</div>
<div class="line"><a name="l02488"></a><span class="lineno"> 2488</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> * <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>) &lt; <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)</div>
<div class="line"><a name="l02489"></a><span class="lineno"> 2489</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> = (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> / <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l02490"></a><span class="lineno"> 2490</span>&#160;    <span class="keywordflow">if</span> ((<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> &gt;= <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) &amp;&amp; ((<a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) % <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>))</div>
<div class="line"><a name="l02491"></a><span class="lineno"> 2491</span>&#160;        <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> = (<a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a> / <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l02492"></a><span class="lineno"> 2492</span>&#160; </div>
<div class="line"><a name="l02493"></a><span class="lineno"> 2493</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#adcf8dfc992b8b4a4e6cd72e213bf1035">page_size</a> = <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02494"></a><span class="lineno"> 2494</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">span_size</a> = <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l02495"></a><span class="lineno"> 2495</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">span_map_count</a> = <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a>;</div>
<div class="line"><a name="l02496"></a><span class="lineno"> 2496</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>.<a class="code" href="structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">enable_huge_pages</a> = <a class="code" href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a>;</div>
<div class="line"><a name="l02497"></a><span class="lineno"> 2497</span>&#160; </div>
<div class="line"><a name="l02498"></a><span class="lineno"> 2498</span>&#160;    <a class="code" href="rpmalloc_8c.html#a03eedb1d5d48520b6ec939744051f9ee">_memory_span_release_count</a> = (<a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> &gt; 4 ? ((<a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> &lt; 64) ? <a class="code" href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a> : 64) : 4);</div>
<div class="line"><a name="l02499"></a><span class="lineno"> 2499</span>&#160;    <a class="code" href="rpmalloc_8c.html#a95516c8eac47786193b7172bed4a3ef7">_memory_span_release_count_large</a> = (<a class="code" href="rpmalloc_8c.html#a03eedb1d5d48520b6ec939744051f9ee">_memory_span_release_count</a> &gt; 8 ? (<a class="code" href="rpmalloc_8c.html#a03eedb1d5d48520b6ec939744051f9ee">_memory_span_release_count</a> / 4) : 2);</div>
<div class="line"><a name="l02500"></a><span class="lineno"> 2500</span>&#160; </div>
<div class="line"><a name="l02501"></a><span class="lineno"> 2501</span>&#160;<span class="preprocessor">#if (defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD</span></div>
<div class="line"><a name="l02502"></a><span class="lineno"> 2502</span>&#160;    <span class="keywordflow">if</span> (pthread_key_create(&amp;_memory_thread_heap, <a class="code" href="rpmalloc_8c.html#a71ab817e272e211aed203f0416a622a6">_rpmalloc_heap_release_raw</a>))</div>
<div class="line"><a name="l02503"></a><span class="lineno"> 2503</span>&#160;        <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l02504"></a><span class="lineno"> 2504</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02505"></a><span class="lineno"> 2505</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l02506"></a><span class="lineno"> 2506</span>&#160;    fls_key = FlsAlloc(&amp;_rpmalloc_thread_destructor);</div>
<div class="line"><a name="l02507"></a><span class="lineno"> 2507</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02508"></a><span class="lineno"> 2508</span>&#160; </div>
<div class="line"><a name="l02509"></a><span class="lineno"> 2509</span>&#160;    <span class="comment">//Setup all small and medium size classes</span></div>
<div class="line"><a name="l02510"></a><span class="lineno"> 2510</span>&#160;    <span class="keywordtype">size_t</span> iclass = 0;</div>
<div class="line"><a name="l02511"></a><span class="lineno"> 2511</span>&#160;    <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a> = <a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>;</div>
<div class="line"><a name="l02512"></a><span class="lineno"> 2512</span>&#160;    <a class="code" href="rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(iclass);</div>
<div class="line"><a name="l02513"></a><span class="lineno"> 2513</span>&#160;    <span class="keywordflow">for</span> (iclass = 1; iclass &lt; <a class="code" href="rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02514"></a><span class="lineno"> 2514</span>&#160;        <span class="keywordtype">size_t</span> size = iclass * <a class="code" href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a>;</div>
<div class="line"><a name="l02515"></a><span class="lineno"> 2515</span>&#160;        <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)size;</div>
<div class="line"><a name="l02516"></a><span class="lineno"> 2516</span>&#160;        <a class="code" href="rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(iclass);</div>
<div class="line"><a name="l02517"></a><span class="lineno"> 2517</span>&#160;    }</div>
<div class="line"><a name="l02518"></a><span class="lineno"> 2518</span>&#160;    <span class="comment">//At least two blocks per span, then fall back to large allocations</span></div>
<div class="line"><a name="l02519"></a><span class="lineno"> 2519</span>&#160;    <a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a> = (<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> - <a class="code" href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a>) &gt;&gt; 1;</div>
<div class="line"><a name="l02520"></a><span class="lineno"> 2520</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a> &gt; <a class="code" href="rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">MEDIUM_SIZE_LIMIT</a>)</div>
<div class="line"><a name="l02521"></a><span class="lineno"> 2521</span>&#160;        <a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a> = <a class="code" href="rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">MEDIUM_SIZE_LIMIT</a>;</div>
<div class="line"><a name="l02522"></a><span class="lineno"> 2522</span>&#160;    <span class="keywordflow">for</span> (iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a554df4bc024ffaa8328e6ef37cec5c77">MEDIUM_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02523"></a><span class="lineno"> 2523</span>&#160;        <span class="keywordtype">size_t</span> size = <a class="code" href="rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a> + ((iclass + 1) * <a class="code" href="rpmalloc_8c.html#a0cbe158c682e307dc9372ee5a0b5167a">MEDIUM_GRANULARITY</a>);</div>
<div class="line"><a name="l02524"></a><span class="lineno"> 2524</span>&#160;        <span class="keywordflow">if</span> (size &gt; <a class="code" href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a>)</div>
<div class="line"><a name="l02525"></a><span class="lineno"> 2525</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l02526"></a><span class="lineno"> 2526</span>&#160;        <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[<a class="code" href="rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a> + iclass].<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a> = (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)size;</div>
<div class="line"><a name="l02527"></a><span class="lineno"> 2527</span>&#160;        <a class="code" href="rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a>(<a class="code" href="rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a> + iclass);</div>
<div class="line"><a name="l02528"></a><span class="lineno"> 2528</span>&#160;    }</div>
<div class="line"><a name="l02529"></a><span class="lineno"> 2529</span>&#160; </div>
<div class="line"><a name="l02530"></a><span class="lineno"> 2530</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a> = 0;</div>
<div class="line"><a name="l02531"></a><span class="lineno"> 2531</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02532"></a><span class="lineno"> 2532</span>&#160;    _memory_first_class_orphan_heaps = 0;</div>
<div class="line"><a name="l02533"></a><span class="lineno"> 2533</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02534"></a><span class="lineno"> 2534</span>&#160;    memset(<a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>));</div>
<div class="line"><a name="l02535"></a><span class="lineno"> 2535</span>&#160;    <a class="code" href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a>(&amp;<a class="code" href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a>, 0);</div>
<div class="line"><a name="l02536"></a><span class="lineno"> 2536</span>&#160; </div>
<div class="line"><a name="l02537"></a><span class="lineno"> 2537</span>&#160;    <span class="comment">//Initialize this thread</span></div>
<div class="line"><a name="l02538"></a><span class="lineno"> 2538</span>&#160;    <a class="code" href="rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>();</div>
<div class="line"><a name="l02539"></a><span class="lineno"> 2539</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02540"></a><span class="lineno"> 2540</span>&#160;}</div>
<div class="line"><a name="l02541"></a><span class="lineno"> 2541</span>&#160; </div>
<div class="line"><a name="l02543"></a><span class="lineno"> 2543</span>&#160;<span class="keywordtype">void</span></div>
<div class="line"><a name="l02544"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a1c1ba6b797d81b14895f0a2114d78476"> 2544</a></span>&#160;<a class="code" href="rpmalloc_8c.html#aff58cf54f7ebc5d3d71a2ad80a0dab94">rpmalloc_finalize</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02545"></a><span class="lineno"> 2545</span>&#160;    <a class="code" href="rpmalloc_8c.html#a1138b9406eb249def65f0f30a4820553">rpmalloc_thread_finalize</a>();</div>
<div class="line"><a name="l02546"></a><span class="lineno"> 2546</span>&#160;    <span class="comment">//rpmalloc_dump_statistics(stdout);</span></div>
<div class="line"><a name="l02547"></a><span class="lineno"> 2547</span>&#160; </div>
<div class="line"><a name="l02548"></a><span class="lineno"> 2548</span>&#160;    <span class="comment">//Free all thread caches and fully free spans</span></div>
<div class="line"><a name="l02549"></a><span class="lineno"> 2549</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> list_idx = 0; list_idx &lt; <a class="code" href="rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>; ++list_idx) {</div>
<div class="line"><a name="l02550"></a><span class="lineno"> 2550</span>&#160;        <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l02551"></a><span class="lineno"> 2551</span>&#160;        <span class="keywordflow">while</span> (heap) {</div>
<div class="line"><a name="l02552"></a><span class="lineno"> 2552</span>&#160;            <a class="code" href="structheap__t.html">heap_t</a>* next_heap = heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l02553"></a><span class="lineno"> 2553</span>&#160;            heap-&gt;<a class="code" href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">finalize</a> = 1;</div>
<div class="line"><a name="l02554"></a><span class="lineno"> 2554</span>&#160;            <a class="code" href="rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a>(heap);</div>
<div class="line"><a name="l02555"></a><span class="lineno"> 2555</span>&#160;            heap = next_heap;</div>
<div class="line"><a name="l02556"></a><span class="lineno"> 2556</span>&#160;        }</div>
<div class="line"><a name="l02557"></a><span class="lineno"> 2557</span>&#160;    }</div>
<div class="line"><a name="l02558"></a><span class="lineno"> 2558</span>&#160; </div>
<div class="line"><a name="l02559"></a><span class="lineno"> 2559</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l02560"></a><span class="lineno"> 2560</span>&#160;    <span class="comment">//Free global caches</span></div>
<div class="line"><a name="l02561"></a><span class="lineno"> 2561</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02562"></a><span class="lineno"> 2562</span>&#160;        <a class="code" href="rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe">_rpmalloc_global_cache_finalize</a>(&amp;<a class="code" href="rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[iclass]);</div>
<div class="line"><a name="l02563"></a><span class="lineno"> 2563</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02564"></a><span class="lineno"> 2564</span>&#160; </div>
<div class="line"><a name="l02565"></a><span class="lineno"> 2565</span>&#160;<span class="preprocessor">#if (defined(__APPLE__) || defined(__HAIKU__)) &amp;&amp; ENABLE_PRELOAD</span></div>
<div class="line"><a name="l02566"></a><span class="lineno"> 2566</span>&#160;    pthread_key_delete(_memory_thread_heap);</div>
<div class="line"><a name="l02567"></a><span class="lineno"> 2567</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02568"></a><span class="lineno"> 2568</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l02569"></a><span class="lineno"> 2569</span>&#160;    FlsFree(fls_key);</div>
<div class="line"><a name="l02570"></a><span class="lineno"> 2570</span>&#160;    fls_key = 0;</div>
<div class="line"><a name="l02571"></a><span class="lineno"> 2571</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02572"></a><span class="lineno"> 2572</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02573"></a><span class="lineno"> 2573</span>&#160;    <span class="comment">//If you hit these asserts you probably have memory leaks (perhaps global scope data doing dynamic allocations) or double frees in your code</span></div>
<div class="line"><a name="l02574"></a><span class="lineno"> 2574</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!atomic_load32(&amp;_mapped_pages));</div>
<div class="line"><a name="l02575"></a><span class="lineno"> 2575</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!atomic_load32(&amp;_reserved_spans));</div>
<div class="line"><a name="l02576"></a><span class="lineno"> 2576</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!atomic_load32(&amp;_mapped_pages_os));</div>
<div class="line"><a name="l02577"></a><span class="lineno"> 2577</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02578"></a><span class="lineno"> 2578</span>&#160; </div>
<div class="line"><a name="l02579"></a><span class="lineno"> 2579</span>&#160;    <a class="code" href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a> = 0;</div>
<div class="line"><a name="l02580"></a><span class="lineno"> 2580</span>&#160;}</div>
<div class="line"><a name="l02581"></a><span class="lineno"> 2581</span>&#160; </div>
<div class="line"><a name="l02583"></a><span class="lineno"> 2583</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02584"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a4166a6bd4ba8707f381910f73a0d858e"> 2584</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02585"></a><span class="lineno"> 2585</span>&#160;    <span class="keywordflow">if</span> (!<a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>()) {</div>
<div class="line"><a name="l02586"></a><span class="lineno"> 2586</span>&#160;        <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a>(0);</div>
<div class="line"><a name="l02587"></a><span class="lineno"> 2587</span>&#160;        <span class="keywordflow">if</span> (heap) {</div>
<div class="line"><a name="l02588"></a><span class="lineno"> 2588</span>&#160;            <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_memory_active_heaps);</div>
<div class="line"><a name="l02589"></a><span class="lineno"> 2589</span>&#160;            <a class="code" href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(heap);</div>
<div class="line"><a name="l02590"></a><span class="lineno"> 2590</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l02591"></a><span class="lineno"> 2591</span>&#160;            FlsSetValue(fls_key, heap);</div>
<div class="line"><a name="l02592"></a><span class="lineno"> 2592</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02593"></a><span class="lineno"> 2593</span>&#160;        }</div>
<div class="line"><a name="l02594"></a><span class="lineno"> 2594</span>&#160;    }</div>
<div class="line"><a name="l02595"></a><span class="lineno"> 2595</span>&#160;}</div>
<div class="line"><a name="l02596"></a><span class="lineno"> 2596</span>&#160; </div>
<div class="line"><a name="l02598"></a><span class="lineno"> 2598</span>&#160;<span class="keywordtype">void</span></div>
<div class="line"><a name="l02599"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a335ba2ccc13aec99c744f3f3fff72804"> 2599</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a1138b9406eb249def65f0f30a4820553">rpmalloc_thread_finalize</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02600"></a><span class="lineno"> 2600</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l02601"></a><span class="lineno"> 2601</span>&#160;    <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l02602"></a><span class="lineno"> 2602</span>&#160;        <a class="code" href="rpmalloc_8c.html#a71ab817e272e211aed203f0416a622a6">_rpmalloc_heap_release_raw</a>(heap);</div>
<div class="line"><a name="l02603"></a><span class="lineno"> 2603</span>&#160;    <a class="code" href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(0);</div>
<div class="line"><a name="l02604"></a><span class="lineno"> 2604</span>&#160;<span class="preprocessor">#if defined(_WIN32) &amp;&amp; (!defined(BUILD_DYNAMIC_LINK) || !BUILD_DYNAMIC_LINK)</span></div>
<div class="line"><a name="l02605"></a><span class="lineno"> 2605</span>&#160;    FlsSetValue(fls_key, 0);</div>
<div class="line"><a name="l02606"></a><span class="lineno"> 2606</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02607"></a><span class="lineno"> 2607</span>&#160;}</div>
<div class="line"><a name="l02608"></a><span class="lineno"> 2608</span>&#160; </div>
<div class="line"><a name="l02609"></a><span class="lineno"> 2609</span>&#160;<span class="keywordtype">int</span></div>
<div class="line"><a name="l02610"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a651de9989dde0bba2f3eac7d4c09f97a"> 2610</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a6f18b8696daac522d93e448aadd7cd4b">rpmalloc_is_thread_initialized</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02611"></a><span class="lineno"> 2611</span>&#160;    <span class="keywordflow">return</span> (<a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>() != 0) ? 1 : 0;</div>
<div class="line"><a name="l02612"></a><span class="lineno"> 2612</span>&#160;}</div>
<div class="line"><a name="l02613"></a><span class="lineno"> 2613</span>&#160; </div>
<div class="line"><a name="l02614"></a><span class="lineno"> 2614</span>&#160;<span class="keyword">const</span> <a class="code" href="structrpmalloc__config__t.html">rpmalloc_config_t</a>*</div>
<div class="line"><a name="l02615"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a5d934c3d6b55bd8193cb8787f03598ff"> 2615</a></span>&#160;<a class="code" href="rpmalloc_8c.html#afed57ac88686e15e2d9cee4743e31857">rpmalloc_config</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02616"></a><span class="lineno"> 2616</span>&#160;    <span class="keywordflow">return</span> &amp;<a class="code" href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a>;</div>
<div class="line"><a name="l02617"></a><span class="lineno"> 2617</span>&#160;}</div>
<div class="line"><a name="l02618"></a><span class="lineno"> 2618</span>&#160; </div>
<div class="line"><a name="l02619"></a><span class="lineno"> 2619</span>&#160;<span class="comment">// Extern interface</span></div>
<div class="line"><a name="l02620"></a><span class="lineno"> 2620</span>&#160; </div>
<div class="line"><a name="l02621"></a><span class="lineno"> 2621</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02622"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a133b388f5ecf5412a1b6ad2aa066d520"> 2622</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af330a53810a7e9a1d2a151bc229a9dc4">rpmalloc</a>(<span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02623"></a><span class="lineno"> 2623</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02624"></a><span class="lineno"> 2624</span>&#160;    <span class="keywordflow">if</span> (size &gt;= MAX_ALLOC_SIZE) {</div>
<div class="line"><a name="l02625"></a><span class="lineno"> 2625</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02626"></a><span class="lineno"> 2626</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02627"></a><span class="lineno"> 2627</span>&#160;    }</div>
<div class="line"><a name="l02628"></a><span class="lineno"> 2628</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02629"></a><span class="lineno"> 2629</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l02630"></a><span class="lineno"> 2630</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, size);</div>
<div class="line"><a name="l02631"></a><span class="lineno"> 2631</span>&#160;}</div>
<div class="line"><a name="l02632"></a><span class="lineno"> 2632</span>&#160; </div>
<div class="line"><a name="l02633"></a><span class="lineno"> 2633</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02634"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a608a7c1ac37d930b1d82748d98009149"> 2634</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a19186eb24d08ef02b924951abb865b51">rpfree</a>(<span class="keywordtype">void</span>* ptr) {</div>
<div class="line"><a name="l02635"></a><span class="lineno"> 2635</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(ptr);</div>
<div class="line"><a name="l02636"></a><span class="lineno"> 2636</span>&#160;}</div>
<div class="line"><a name="l02637"></a><span class="lineno"> 2637</span>&#160; </div>
<div class="line"><a name="l02638"></a><span class="lineno"> 2638</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02639"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#a2aaa6595462b280c7c95e7804ab6f9fd"> 2639</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a2aaa6595462b280c7c95e7804ab6f9fd">rpcalloc</a>(<span class="keywordtype">size_t</span> num, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02640"></a><span class="lineno"> 2640</span>&#160;    <span class="keywordtype">size_t</span> total;</div>
<div class="line"><a name="l02641"></a><span class="lineno"> 2641</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02642"></a><span class="lineno"> 2642</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l02643"></a><span class="lineno"> 2643</span>&#160;    <span class="keywordtype">int</span> err = SizeTMult(num, size, &amp;total);</div>
<div class="line"><a name="l02644"></a><span class="lineno"> 2644</span>&#160;    <span class="keywordflow">if</span> ((err != S_OK) || (total &gt;= MAX_ALLOC_SIZE)) {</div>
<div class="line"><a name="l02645"></a><span class="lineno"> 2645</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02646"></a><span class="lineno"> 2646</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02647"></a><span class="lineno"> 2647</span>&#160;    }</div>
<div class="line"><a name="l02648"></a><span class="lineno"> 2648</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02649"></a><span class="lineno"> 2649</span>&#160;    <span class="keywordtype">int</span> err = __builtin_umull_overflow(num, size, &amp;total);</div>
<div class="line"><a name="l02650"></a><span class="lineno"> 2650</span>&#160;    <span class="keywordflow">if</span> (err || (total &gt;= MAX_ALLOC_SIZE)) {</div>
<div class="line"><a name="l02651"></a><span class="lineno"> 2651</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02652"></a><span class="lineno"> 2652</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02653"></a><span class="lineno"> 2653</span>&#160;    }</div>
<div class="line"><a name="l02654"></a><span class="lineno"> 2654</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02655"></a><span class="lineno"> 2655</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02656"></a><span class="lineno"> 2656</span>&#160;    total = num * size;</div>
<div class="line"><a name="l02657"></a><span class="lineno"> 2657</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02658"></a><span class="lineno"> 2658</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l02659"></a><span class="lineno"> 2659</span>&#160;    <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, total);</div>
<div class="line"><a name="l02660"></a><span class="lineno"> 2660</span>&#160;    <span class="keywordflow">if</span> (block)</div>
<div class="line"><a name="l02661"></a><span class="lineno"> 2661</span>&#160;        memset(block, 0, total);</div>
<div class="line"><a name="l02662"></a><span class="lineno"> 2662</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02663"></a><span class="lineno"> 2663</span>&#160;}</div>
<div class="line"><a name="l02664"></a><span class="lineno"> 2664</span>&#160; </div>
<div class="line"><a name="l02665"></a><span class="lineno"> 2665</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02666"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#ac52f702e04b8a41a925794512404375e"> 2666</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a240396bd63b0822a9ec0ade52cab44b2">rprealloc</a>(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02667"></a><span class="lineno"> 2667</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02668"></a><span class="lineno"> 2668</span>&#160;    <span class="keywordflow">if</span> (size &gt;= MAX_ALLOC_SIZE) {</div>
<div class="line"><a name="l02669"></a><span class="lineno"> 2669</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02670"></a><span class="lineno"> 2670</span>&#160;        <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02671"></a><span class="lineno"> 2671</span>&#160;    }</div>
<div class="line"><a name="l02672"></a><span class="lineno"> 2672</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02673"></a><span class="lineno"> 2673</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l02674"></a><span class="lineno"> 2674</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(heap, ptr, size, 0, 0);</div>
<div class="line"><a name="l02675"></a><span class="lineno"> 2675</span>&#160;}</div>
<div class="line"><a name="l02676"></a><span class="lineno"> 2676</span>&#160; </div>
<div class="line"><a name="l02677"></a><span class="lineno"> 2677</span>&#160;<span class="keyword">extern</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02678"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#af02d9e329d817c877a2cbe5b155cd9d3"> 2678</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a91e8ecc3f466b065c5d14e8506b47e3f">rpaligned_realloc</a>(<span class="keywordtype">void</span>* ptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> oldsize,</div>
<div class="line"><a name="l02679"></a><span class="lineno"> 2679</span>&#160;                  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags) {</div>
<div class="line"><a name="l02680"></a><span class="lineno"> 2680</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02681"></a><span class="lineno"> 2681</span>&#160;    <span class="keywordflow">if</span> ((size + alignment &lt; size) || (alignment &gt; <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)) {</div>
<div class="line"><a name="l02682"></a><span class="lineno"> 2682</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02683"></a><span class="lineno"> 2683</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02684"></a><span class="lineno"> 2684</span>&#160;    }</div>
<div class="line"><a name="l02685"></a><span class="lineno"> 2685</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02686"></a><span class="lineno"> 2686</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l02687"></a><span class="lineno"> 2687</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a>(heap, ptr, alignment, size, oldsize, flags);</div>
<div class="line"><a name="l02688"></a><span class="lineno"> 2688</span>&#160;}</div>
<div class="line"><a name="l02689"></a><span class="lineno"> 2689</span>&#160; </div>
<div class="line"><a name="l02690"></a><span class="lineno"> 2690</span>&#160;<span class="keyword">extern</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02691"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a657912db3072a6b4e9fa221f13c64c27"> 2691</a></span>&#160;<a class="code" href="rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(<span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02692"></a><span class="lineno"> 2692</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a>();</div>
<div class="line"><a name="l02693"></a><span class="lineno"> 2693</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, size);</div>
<div class="line"><a name="l02694"></a><span class="lineno"> 2694</span>&#160;}</div>
<div class="line"><a name="l02695"></a><span class="lineno"> 2695</span>&#160; </div>
<div class="line"><a name="l02696"></a><span class="lineno"> 2696</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02697"></a><span class="lineno"><a class="line" href="rpmalloc_8c.html#afa1244471261835d7a8a2fa23464834b"> 2697</a></span>&#160;<a class="code" href="rpmalloc_8c.html#afa1244471261835d7a8a2fa23464834b">rpaligned_calloc</a>(<span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> num, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02698"></a><span class="lineno"> 2698</span>&#160;    <span class="keywordtype">size_t</span> total;</div>
<div class="line"><a name="l02699"></a><span class="lineno"> 2699</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02700"></a><span class="lineno"> 2700</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l02701"></a><span class="lineno"> 2701</span>&#160;    <span class="keywordtype">int</span> err = SizeTMult(num, size, &amp;total);</div>
<div class="line"><a name="l02702"></a><span class="lineno"> 2702</span>&#160;    <span class="keywordflow">if</span> ((err != S_OK) || (total &gt;= MAX_ALLOC_SIZE)) {</div>
<div class="line"><a name="l02703"></a><span class="lineno"> 2703</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02704"></a><span class="lineno"> 2704</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02705"></a><span class="lineno"> 2705</span>&#160;    }</div>
<div class="line"><a name="l02706"></a><span class="lineno"> 2706</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02707"></a><span class="lineno"> 2707</span>&#160;    <span class="keywordtype">int</span> err = __builtin_umull_overflow(num, size, &amp;total);</div>
<div class="line"><a name="l02708"></a><span class="lineno"> 2708</span>&#160;    <span class="keywordflow">if</span> (err || (total &gt;= MAX_ALLOC_SIZE)) {</div>
<div class="line"><a name="l02709"></a><span class="lineno"> 2709</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02710"></a><span class="lineno"> 2710</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02711"></a><span class="lineno"> 2711</span>&#160;    }</div>
<div class="line"><a name="l02712"></a><span class="lineno"> 2712</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02713"></a><span class="lineno"> 2713</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02714"></a><span class="lineno"> 2714</span>&#160;    total = num * size;</div>
<div class="line"><a name="l02715"></a><span class="lineno"> 2715</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02716"></a><span class="lineno"> 2716</span>&#160;    <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(alignment, total);</div>
<div class="line"><a name="l02717"></a><span class="lineno"> 2717</span>&#160;    <span class="keywordflow">if</span> (block)</div>
<div class="line"><a name="l02718"></a><span class="lineno"> 2718</span>&#160;        memset(block, 0, total);</div>
<div class="line"><a name="l02719"></a><span class="lineno"> 2719</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l02720"></a><span class="lineno"> 2720</span>&#160;}</div>
<div class="line"><a name="l02721"></a><span class="lineno"> 2721</span>&#160; </div>
<div class="line"><a name="l02722"></a><span class="lineno"> 2722</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02723"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#aecd8ddbe73d43b6863725c693a7e9818"> 2723</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a7f0d32d7a842d13c6a15e4ddae3814eb">rpmemalign</a>(<span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02724"></a><span class="lineno"> 2724</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(alignment, size);</div>
<div class="line"><a name="l02725"></a><span class="lineno"> 2725</span>&#160;}</div>
<div class="line"><a name="l02726"></a><span class="lineno"> 2726</span>&#160; </div>
<div class="line"><a name="l02727"></a><span class="lineno"> 2727</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">int</span></div>
<div class="line"><a name="l02728"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a3f43fd4642bf70f3c43ed24694611bc3"> 2728</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ae6f35022f9384e2a22ed2b96c00995b2">rpposix_memalign</a>(<span class="keywordtype">void</span> **memptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02729"></a><span class="lineno"> 2729</span>&#160;    <span class="keywordflow">if</span> (memptr)</div>
<div class="line"><a name="l02730"></a><span class="lineno"> 2730</span>&#160;        *memptr = <a class="code" href="rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a>(alignment, size);</div>
<div class="line"><a name="l02731"></a><span class="lineno"> 2731</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l02732"></a><span class="lineno"> 2732</span>&#160;        <span class="keywordflow">return</span> EINVAL;</div>
<div class="line"><a name="l02733"></a><span class="lineno"> 2733</span>&#160;    <span class="keywordflow">return</span> *memptr ? 0 : ENOMEM;</div>
<div class="line"><a name="l02734"></a><span class="lineno"> 2734</span>&#160;}</div>
<div class="line"><a name="l02735"></a><span class="lineno"> 2735</span>&#160; </div>
<div class="line"><a name="l02736"></a><span class="lineno"> 2736</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span></div>
<div class="line"><a name="l02737"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a52b4c800cec1406d162b8a7787587a46"> 2737</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a7a9f597c853963de259b40e985d81113">rpmalloc_usable_size</a>(<span class="keywordtype">void</span>* ptr) {</div>
<div class="line"><a name="l02738"></a><span class="lineno"> 2738</span>&#160;    <span class="keywordflow">return</span> (ptr ? <a class="code" href="rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a>(ptr) : 0);</div>
<div class="line"><a name="l02739"></a><span class="lineno"> 2739</span>&#160;}</div>
<div class="line"><a name="l02740"></a><span class="lineno"> 2740</span>&#160; </div>
<div class="line"><a name="l02741"></a><span class="lineno"> 2741</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02742"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#afe32b20a0a8c471b85225975f22de7b0"> 2742</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a6db2d5852bc3af5ee8bbbfae2db30997">rpmalloc_thread_collect</a>(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02743"></a><span class="lineno"> 2743</span>&#160;}</div>
<div class="line"><a name="l02744"></a><span class="lineno"> 2744</span>&#160; </div>
<div class="line"><a name="l02745"></a><span class="lineno"> 2745</span>&#160;<span class="keywordtype">void</span></div>
<div class="line"><a name="l02746"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a29c086aa3f5d9fbc936fea87cfa62e2e"> 2746</a></span>&#160;<a class="code" href="rpmalloc_8c.html#acb3289e60a1c405dbb154dce3f3d6c7a">rpmalloc_thread_statistics</a>(<a class="code" href="structrpmalloc__thread__statistics__t.html">rpmalloc_thread_statistics_t</a>* stats) {</div>
<div class="line"><a name="l02747"></a><span class="lineno"> 2747</span>&#160;    memset(stats, 0, <span class="keyword">sizeof</span>(<a class="code" href="structrpmalloc__thread__statistics__t.html">rpmalloc_thread_statistics_t</a>));</div>
<div class="line"><a name="l02748"></a><span class="lineno"> 2748</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l02749"></a><span class="lineno"> 2749</span>&#160;    <span class="keywordflow">if</span> (!heap)</div>
<div class="line"><a name="l02750"></a><span class="lineno"> 2750</span>&#160;        <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l02751"></a><span class="lineno"> 2751</span>&#160; </div>
<div class="line"><a name="l02752"></a><span class="lineno"> 2752</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02753"></a><span class="lineno"> 2753</span>&#160;        <a class="code" href="structsize__class__t.html">size_class_t</a>* size_class = <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a> + iclass;</div>
<div class="line"><a name="l02754"></a><span class="lineno"> 2754</span>&#160;        <a class="code" href="structspan__t.html">span_t</a>* span = heap-&gt;<a class="code" href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">size_class</a>[iclass].<a class="code" href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">partial_span</a>;</div>
<div class="line"><a name="l02755"></a><span class="lineno"> 2755</span>&#160;        <span class="keywordflow">while</span> (span) {</div>
<div class="line"><a name="l02756"></a><span class="lineno"> 2756</span>&#160;            <span class="keywordtype">size_t</span> free_count = span-&gt;<a class="code" href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">list_size</a>;</div>
<div class="line"><a name="l02757"></a><span class="lineno"> 2757</span>&#160;            <span class="keywordtype">size_t</span> block_count = size_class-&gt;<a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>;</div>
<div class="line"><a name="l02758"></a><span class="lineno"> 2758</span>&#160;            <span class="keywordflow">if</span> (span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a> &lt; block_count)</div>
<div class="line"><a name="l02759"></a><span class="lineno"> 2759</span>&#160;                block_count = span-&gt;<a class="code" href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">free_list_limit</a>;</div>
<div class="line"><a name="l02760"></a><span class="lineno"> 2760</span>&#160;            free_count += (block_count - span-&gt;<a class="code" href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">used_count</a>);</div>
<div class="line"><a name="l02761"></a><span class="lineno"> 2761</span>&#160;            stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#ae1b16b8970cd1354befab4f0e4b993ac">sizecache</a> = free_count * size_class-&gt;<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>;</div>
<div class="line"><a name="l02762"></a><span class="lineno"> 2762</span>&#160;            span = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l02763"></a><span class="lineno"> 2763</span>&#160;        }</div>
<div class="line"><a name="l02764"></a><span class="lineno"> 2764</span>&#160;    }</div>
<div class="line"><a name="l02765"></a><span class="lineno"> 2765</span>&#160; </div>
<div class="line"><a name="l02766"></a><span class="lineno"> 2766</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l02767"></a><span class="lineno"> 2767</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02768"></a><span class="lineno"> 2768</span>&#160;        <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l02769"></a><span class="lineno"> 2769</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l02770"></a><span class="lineno"> 2770</span>&#160;            span_cache = &amp;heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>;</div>
<div class="line"><a name="l02771"></a><span class="lineno"> 2771</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l02772"></a><span class="lineno"> 2772</span>&#160;            span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a> + (iclass - 1));</div>
<div class="line"><a name="l02773"></a><span class="lineno"> 2773</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#af75f9eeddb63a098824a555506334c8a">spancache</a> = span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l02774"></a><span class="lineno"> 2774</span>&#160;    }</div>
<div class="line"><a name="l02775"></a><span class="lineno"> 2775</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02776"></a><span class="lineno"> 2776</span>&#160; </div>
<div class="line"><a name="l02777"></a><span class="lineno"> 2777</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* deferred = (<a class="code" href="structspan__t.html">span_t</a>*)<a class="code" href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a>(&amp;heap-&gt;<a class="code" href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">span_free_deferred</a>);</div>
<div class="line"><a name="l02778"></a><span class="lineno"> 2778</span>&#160;    <span class="keywordflow">while</span> (deferred) {</div>
<div class="line"><a name="l02779"></a><span class="lineno"> 2779</span>&#160;        <span class="keywordflow">if</span> (deferred-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> != <a class="code" href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>)</div>
<div class="line"><a name="l02780"></a><span class="lineno"> 2780</span>&#160;            stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#af75f9eeddb63a098824a555506334c8a">spancache</a> = (size_t)deferred-&gt;<a class="code" href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_count</a> * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l02781"></a><span class="lineno"> 2781</span>&#160;        deferred = (<a class="code" href="structspan__t.html">span_t</a>*)deferred-&gt;<a class="code" href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">free_list</a>;</div>
<div class="line"><a name="l02782"></a><span class="lineno"> 2782</span>&#160;    }</div>
<div class="line"><a name="l02783"></a><span class="lineno"> 2783</span>&#160; </div>
<div class="line"><a name="l02784"></a><span class="lineno"> 2784</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02785"></a><span class="lineno"> 2785</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#affc9a9b9fff3b494c0f0dd63884be0e4">thread_to_global</a> = (size_t)<a class="code" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;thread_to_global);</div>
<div class="line"><a name="l02786"></a><span class="lineno"> 2786</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a29f83756e4d2a2bdebcfdfc8a8908081">global_to_thread</a> = (size_t)<a class="code" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;global_to_thread);</div>
<div class="line"><a name="l02787"></a><span class="lineno"> 2787</span>&#160; </div>
<div class="line"><a name="l02788"></a><span class="lineno"> 2788</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02789"></a><span class="lineno"> 2789</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#abb5fa3f3219c6ed85ac00b5d4fbd6ff3">current</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].current);</div>
<div class="line"><a name="l02790"></a><span class="lineno"> 2790</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a6f2158d4c33a0bc6f70979b6a75e5d17">peak</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].high);</div>
<div class="line"><a name="l02791"></a><span class="lineno"> 2791</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a96620ca188ca92d642ed88b803db35fc">to_global</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_global);</div>
<div class="line"><a name="l02792"></a><span class="lineno"> 2792</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a079156bbe2b2ed6c95e5f203916375fa">from_global</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_global);</div>
<div class="line"><a name="l02793"></a><span class="lineno"> 2793</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a47dc214231db2729538940b8db899c79">to_cache</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_cache);</div>
<div class="line"><a name="l02794"></a><span class="lineno"> 2794</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a953c50560183aabed3e8cf5bdf5bd98f">from_cache</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_cache);</div>
<div class="line"><a name="l02795"></a><span class="lineno"> 2795</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a0b1fa423f8933d241c6f3a19a9e77e20">to_reserved</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_reserved);</div>
<div class="line"><a name="l02796"></a><span class="lineno"> 2796</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a0789af6dab1aa1a24b9c9d326ab84373">from_reserved</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_reserved);</div>
<div class="line"><a name="l02797"></a><span class="lineno"> 2797</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">span_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a402952de4cb3d09cf5415ddbd7f77e6d">map_calls</a> = (size_t)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls);</div>
<div class="line"><a name="l02798"></a><span class="lineno"> 2798</span>&#160;    }</div>
<div class="line"><a name="l02799"></a><span class="lineno"> 2799</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02800"></a><span class="lineno"> 2800</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#aa6017e8ccbfca8428f4c724fb1034120">alloc_current</a> = (size_t)atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_current);</div>
<div class="line"><a name="l02801"></a><span class="lineno"> 2801</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#abc7ef0e7b7520db5b2e7c1867d364c0b">alloc_peak</a> = (size_t)heap-&gt;size_class_use[iclass].alloc_peak;</div>
<div class="line"><a name="l02802"></a><span class="lineno"> 2802</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a5a90e1e7a86699bcda3c9b41568aa3c2">alloc_total</a> = (<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total);</div>
<div class="line"><a name="l02803"></a><span class="lineno"> 2803</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a93550a9f6f5b5024d7af279f1c2d624c">free_total</a> = (size_t)atomic_load32(&amp;heap-&gt;size_class_use[iclass].free_total);</div>
<div class="line"><a name="l02804"></a><span class="lineno"> 2804</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a255e3ca61cb348d1f1f3bab7634e1a2c">spans_to_cache</a> = (size_t)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_to_cache);</div>
<div class="line"><a name="l02805"></a><span class="lineno"> 2805</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a7893d4d677b2ba355c45e4ec8b96b241">spans_from_cache</a> = (size_t)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_cache);</div>
<div class="line"><a name="l02806"></a><span class="lineno"> 2806</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#ab96c2c19f00e9acab6ef7651498965ed">spans_from_reserved</a> = (size_t)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_reserved);</div>
<div class="line"><a name="l02807"></a><span class="lineno"> 2807</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">size_use</a>[iclass].<a class="code" href="structrpmalloc__thread__statistics__t.html#a402952de4cb3d09cf5415ddbd7f77e6d">map_calls</a> = (size_t)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_map_calls);</div>
<div class="line"><a name="l02808"></a><span class="lineno"> 2808</span>&#160;    }</div>
<div class="line"><a name="l02809"></a><span class="lineno"> 2809</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02810"></a><span class="lineno"> 2810</span>&#160;}</div>
<div class="line"><a name="l02811"></a><span class="lineno"> 2811</span>&#160; </div>
<div class="line"><a name="l02812"></a><span class="lineno"> 2812</span>&#160;<span class="keywordtype">void</span></div>
<div class="line"><a name="l02813"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a21dbb043c42cbe1bfd7ba3f1fe012f5f"> 2813</a></span>&#160;<a class="code" href="rpmalloc_8c.html#ae6278b2864893c2bc2d86b5d6d9f2d51">rpmalloc_global_statistics</a>(<a class="code" href="structrpmalloc__global__statistics__t.html">rpmalloc_global_statistics_t</a>* stats) {</div>
<div class="line"><a name="l02814"></a><span class="lineno"> 2814</span>&#160;    memset(stats, 0, <span class="keyword">sizeof</span>(<a class="code" href="structrpmalloc__global__statistics__t.html">rpmalloc_global_statistics_t</a>));</div>
<div class="line"><a name="l02815"></a><span class="lineno"> 2815</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02816"></a><span class="lineno"> 2816</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#ab0d895a6016dd1c5937f2a74370f2727">mapped</a> = (size_t)atomic_load32(&amp;_mapped_pages) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02817"></a><span class="lineno"> 2817</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#ad5723376daeb707aa20547190ced2865">mapped_peak</a> = (size_t)_mapped_pages_peak * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02818"></a><span class="lineno"> 2818</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#af1916b4138cfc1e46ff0787ff9206375">mapped_total</a> = (size_t)atomic_load32(&amp;_mapped_total) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02819"></a><span class="lineno"> 2819</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#aa896cafa124a63254f56621fe2c5241f">unmapped_total</a> = (size_t)atomic_load32(&amp;_unmapped_total) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02820"></a><span class="lineno"> 2820</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#a5db28c5567049de1e58833c061841f7e">huge_alloc</a> = (size_t)atomic_load32(&amp;_huge_pages_current) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02821"></a><span class="lineno"> 2821</span>&#160;    stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#a308868b1a8740da06b79c1bdabae1997">huge_alloc_peak</a> = (size_t)_huge_pages_peak * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02822"></a><span class="lineno"> 2822</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02823"></a><span class="lineno"> 2823</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l02824"></a><span class="lineno"> 2824</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass)</div>
<div class="line"><a name="l02825"></a><span class="lineno"> 2825</span>&#160;        stats-&gt;<a class="code" href="structrpmalloc__global__statistics__t.html#a70b10faa79aac5df497ba5eccdd554ae">cached</a> += <a class="code" href="rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a>[iclass].<a class="code" href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">count</a> * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l02826"></a><span class="lineno"> 2826</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02827"></a><span class="lineno"> 2827</span>&#160;}</div>
<div class="line"><a name="l02828"></a><span class="lineno"> 2828</span>&#160; </div>
<div class="line"><a name="l02829"></a><span class="lineno"> 2829</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02830"></a><span class="lineno"> 2830</span>&#160; </div>
<div class="line"><a name="l02831"></a><span class="lineno"> 2831</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02832"></a><span class="lineno"> 2832</span>&#160;_memory_heap_dump_statistics(<a class="code" href="structheap__t.html">heap_t</a>* heap, <span class="keywordtype">void</span>* file) {</div>
<div class="line"><a name="l02833"></a><span class="lineno"> 2833</span>&#160;    fprintf(file, <span class="stringliteral">&quot;Heap %d stats:\n&quot;</span>, heap-&gt;<a class="code" href="structheap__t.html#a2342224142317f85fca91614fc973131">id</a>);</div>
<div class="line"><a name="l02834"></a><span class="lineno"> 2834</span>&#160;    fprintf(file, <span class="stringliteral">&quot;Class   CurAlloc  PeakAlloc   TotAlloc    TotFree  BlkSize BlkCount SpansCur SpansPeak  PeakAllocMiB  ToCacheMiB FromCacheMiB FromReserveMiB MmapCalls\n&quot;</span>);</div>
<div class="line"><a name="l02835"></a><span class="lineno"> 2835</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02836"></a><span class="lineno"> 2836</span>&#160;        <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total))</div>
<div class="line"><a name="l02837"></a><span class="lineno"> 2837</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02838"></a><span class="lineno"> 2838</span>&#160;        fprintf(file, <span class="stringliteral">&quot;%3u:  %10u %10u %10u %10u %8u %8u %8d %9d %13zu %11zu %12zu %14zu %9u\n&quot;</span>, (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)iclass,</div>
<div class="line"><a name="l02839"></a><span class="lineno"> 2839</span>&#160;            atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_current),</div>
<div class="line"><a name="l02840"></a><span class="lineno"> 2840</span>&#160;            heap-&gt;size_class_use[iclass].alloc_peak,</div>
<div class="line"><a name="l02841"></a><span class="lineno"> 2841</span>&#160;            atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total),</div>
<div class="line"><a name="l02842"></a><span class="lineno"> 2842</span>&#160;            atomic_load32(&amp;heap-&gt;size_class_use[iclass].free_total),</div>
<div class="line"><a name="l02843"></a><span class="lineno"> 2843</span>&#160;            <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>,</div>
<div class="line"><a name="l02844"></a><span class="lineno"> 2844</span>&#160;            <a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">block_count</a>,</div>
<div class="line"><a name="l02845"></a><span class="lineno"> 2845</span>&#160;            atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_current),</div>
<div class="line"><a name="l02846"></a><span class="lineno"> 2846</span>&#160;            heap-&gt;size_class_use[iclass].spans_peak,</div>
<div class="line"><a name="l02847"></a><span class="lineno"> 2847</span>&#160;            ((<span class="keywordtype">size_t</span>)heap-&gt;size_class_use[iclass].alloc_peak * (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a>[iclass].<a class="code" href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">block_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02848"></a><span class="lineno"> 2848</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_to_cache) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02849"></a><span class="lineno"> 2849</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_cache) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02850"></a><span class="lineno"> 2850</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_from_reserved) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02851"></a><span class="lineno"> 2851</span>&#160;            atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_map_calls));</div>
<div class="line"><a name="l02852"></a><span class="lineno"> 2852</span>&#160;    }</div>
<div class="line"><a name="l02853"></a><span class="lineno"> 2853</span>&#160;    fprintf(file, <span class="stringliteral">&quot;Spans  Current     Peak  PeakMiB  Cached  ToCacheMiB FromCacheMiB ToReserveMiB FromReserveMiB ToGlobalMiB FromGlobalMiB  MmapCalls\n&quot;</span>);</div>
<div class="line"><a name="l02854"></a><span class="lineno"> 2854</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l02855"></a><span class="lineno"> 2855</span>&#160;        <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;span_use[iclass].high) &amp;&amp; !atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls))</div>
<div class="line"><a name="l02856"></a><span class="lineno"> 2856</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02857"></a><span class="lineno"> 2857</span>&#160;        fprintf(file, <span class="stringliteral">&quot;%4u: %8d %8u %8zu %7u %11zu %12zu %12zu %14zu %11zu %13zu %10u\n&quot;</span>, (<a class="code" href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)(iclass + 1),</div>
<div class="line"><a name="l02858"></a><span class="lineno"> 2858</span>&#160;            atomic_load32(&amp;heap-&gt;span_use[iclass].current),</div>
<div class="line"><a name="l02859"></a><span class="lineno"> 2859</span>&#160;            atomic_load32(&amp;heap-&gt;span_use[iclass].high),</div>
<div class="line"><a name="l02860"></a><span class="lineno"> 2860</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].high) * (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> * (iclass + 1)) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02861"></a><span class="lineno"> 2861</span>&#160;#<span class="keywordflow">if</span> <a class="code" href="rpmalloc_8c.html#a69503d4619673c88e0882f291eb6d86f">ENABLE_THREAD_CACHE</a></div>
<div class="line"><a name="l02862"></a><span class="lineno"> 2862</span>&#160;            (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(!iclass ? heap-&gt;<a class="code" href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">span_cache</a>.<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> : heap-&gt;<a class="code" href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">span_large_cache</a>[iclass - 1].<a class="code" href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">count</a>),</div>
<div class="line"><a name="l02863"></a><span class="lineno"> 2863</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_cache) * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02864"></a><span class="lineno"> 2864</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_cache) * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02865"></a><span class="lineno"> 2865</span>&#160;#<span class="keywordflow">else</span></div>
<div class="line"><a name="l02866"></a><span class="lineno"> 2866</span>&#160;            0, (<span class="keywordtype">size_t</span>)0, (<span class="keywordtype">size_t</span>)0,</div>
<div class="line"><a name="l02867"></a><span class="lineno"> 2867</span>&#160;#endif</div>
<div class="line"><a name="l02868"></a><span class="lineno"> 2868</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_reserved) * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02869"></a><span class="lineno"> 2869</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_reserved) * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02870"></a><span class="lineno"> 2870</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_to_global) * (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> * (iclass + 1)) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02871"></a><span class="lineno"> 2871</span>&#160;            ((<span class="keywordtype">size_t</span>)atomic_load32(&amp;heap-&gt;span_use[iclass].spans_from_global) * (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a> * (iclass + 1)) / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02872"></a><span class="lineno"> 2872</span>&#160;            atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls));</div>
<div class="line"><a name="l02873"></a><span class="lineno"> 2873</span>&#160;    }</div>
<div class="line"><a name="l02874"></a><span class="lineno"> 2874</span>&#160;    fprintf(file, <span class="stringliteral">&quot;ThreadToGlobalMiB GlobalToThreadMiB\n&quot;</span>);</div>
<div class="line"><a name="l02875"></a><span class="lineno"> 2875</span>&#160;    fprintf(file, <span class="stringliteral">&quot;%17zu %17zu\n&quot;</span>, (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;thread_to_global) / (<span class="keywordtype">size_t</span>)(1024 * 1024), (<span class="keywordtype">size_t</span>)<a class="code" href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a>(&amp;heap-&gt;global_to_thread) / (<span class="keywordtype">size_t</span>)(1024 * 1024));</div>
<div class="line"><a name="l02876"></a><span class="lineno"> 2876</span>&#160;}</div>
<div class="line"><a name="l02877"></a><span class="lineno"> 2877</span>&#160; </div>
<div class="line"><a name="l02878"></a><span class="lineno"> 2878</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02879"></a><span class="lineno"> 2879</span>&#160; </div>
<div class="line"><a name="l02880"></a><span class="lineno"> 2880</span>&#160;<span class="keywordtype">void</span></div>
<div class="line"><a name="l02881"></a><span class="lineno"><a class="line" href="rpmalloc_8h.html#a3c33a5925ba558f8dc534c668e344db1"> 2881</a></span>&#160;<a class="code" href="rpmalloc_8c.html#a759e72612fab78b1159ab7129a7f7e86">rpmalloc_dump_statistics</a>(<span class="keywordtype">void</span>* file) {</div>
<div class="line"><a name="l02882"></a><span class="lineno"> 2882</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l02883"></a><span class="lineno"> 2883</span>&#160;    <span class="comment">//If you hit this assert, you still have active threads or forgot to finalize some thread(s)</span></div>
<div class="line"><a name="l02884"></a><span class="lineno"> 2884</span>&#160;    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(atomic_load32(&amp;_memory_active_heaps) == 0);</div>
<div class="line"><a name="l02885"></a><span class="lineno"> 2885</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> list_idx = 0; list_idx &lt; <a class="code" href="rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a>; ++list_idx) {</div>
<div class="line"><a name="l02886"></a><span class="lineno"> 2886</span>&#160;        <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a>[list_idx];</div>
<div class="line"><a name="l02887"></a><span class="lineno"> 2887</span>&#160;        <span class="keywordflow">while</span> (heap) {</div>
<div class="line"><a name="l02888"></a><span class="lineno"> 2888</span>&#160;            <span class="keywordtype">int</span> need_dump = 0;</div>
<div class="line"><a name="l02889"></a><span class="lineno"> 2889</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; !need_dump &amp;&amp; (iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>); ++iclass) {</div>
<div class="line"><a name="l02890"></a><span class="lineno"> 2890</span>&#160;                <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;size_class_use[iclass].alloc_total)) {</div>
<div class="line"><a name="l02891"></a><span class="lineno"> 2891</span>&#160;                    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!atomic_load32(&amp;heap-&gt;size_class_use[iclass].free_total));</div>
<div class="line"><a name="l02892"></a><span class="lineno"> 2892</span>&#160;                    <a class="code" href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a>(!atomic_load32(&amp;heap-&gt;size_class_use[iclass].spans_map_calls));</div>
<div class="line"><a name="l02893"></a><span class="lineno"> 2893</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02894"></a><span class="lineno"> 2894</span>&#160;                }</div>
<div class="line"><a name="l02895"></a><span class="lineno"> 2895</span>&#160;                need_dump = 1;</div>
<div class="line"><a name="l02896"></a><span class="lineno"> 2896</span>&#160;            }</div>
<div class="line"><a name="l02897"></a><span class="lineno"> 2897</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; !need_dump &amp;&amp; (iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>); ++iclass) {</div>
<div class="line"><a name="l02898"></a><span class="lineno"> 2898</span>&#160;                <span class="keywordflow">if</span> (!atomic_load32(&amp;heap-&gt;span_use[iclass].high) &amp;&amp; !atomic_load32(&amp;heap-&gt;span_use[iclass].spans_map_calls))</div>
<div class="line"><a name="l02899"></a><span class="lineno"> 2899</span>&#160;                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l02900"></a><span class="lineno"> 2900</span>&#160;                need_dump = 1;</div>
<div class="line"><a name="l02901"></a><span class="lineno"> 2901</span>&#160;            }</div>
<div class="line"><a name="l02902"></a><span class="lineno"> 2902</span>&#160;            <span class="keywordflow">if</span> (need_dump)</div>
<div class="line"><a name="l02903"></a><span class="lineno"> 2903</span>&#160;                _memory_heap_dump_statistics(heap, file);</div>
<div class="line"><a name="l02904"></a><span class="lineno"> 2904</span>&#160;            heap = heap-&gt;<a class="code" href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">next_heap</a>;</div>
<div class="line"><a name="l02905"></a><span class="lineno"> 2905</span>&#160;        }</div>
<div class="line"><a name="l02906"></a><span class="lineno"> 2906</span>&#160;    }</div>
<div class="line"><a name="l02907"></a><span class="lineno"> 2907</span>&#160;    fprintf(file, <span class="stringliteral">&quot;Global stats:\n&quot;</span>);</div>
<div class="line"><a name="l02908"></a><span class="lineno"> 2908</span>&#160;    <span class="keywordtype">size_t</span> huge_current = (size_t)atomic_load32(&amp;_huge_pages_current) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02909"></a><span class="lineno"> 2909</span>&#160;    <span class="keywordtype">size_t</span> huge_peak = (size_t)_huge_pages_peak * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02910"></a><span class="lineno"> 2910</span>&#160;    fprintf(file, <span class="stringliteral">&quot;HugeCurrentMiB HugePeakMiB\n&quot;</span>);</div>
<div class="line"><a name="l02911"></a><span class="lineno"> 2911</span>&#160;    fprintf(file, <span class="stringliteral">&quot;%14zu %11zu\n&quot;</span>, huge_current / (<span class="keywordtype">size_t</span>)(1024 * 1024), huge_peak / (<span class="keywordtype">size_t</span>)(1024 * 1024));</div>
<div class="line"><a name="l02912"></a><span class="lineno"> 2912</span>&#160; </div>
<div class="line"><a name="l02913"></a><span class="lineno"> 2913</span>&#160;    <span class="keywordtype">size_t</span> mapped = (size_t)atomic_load32(&amp;_mapped_pages) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02914"></a><span class="lineno"> 2914</span>&#160;    <span class="keywordtype">size_t</span> mapped_os = (size_t)atomic_load32(&amp;_mapped_pages_os) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02915"></a><span class="lineno"> 2915</span>&#160;    <span class="keywordtype">size_t</span> mapped_peak = (size_t)_mapped_pages_peak * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02916"></a><span class="lineno"> 2916</span>&#160;    <span class="keywordtype">size_t</span> mapped_total = (size_t)atomic_load32(&amp;_mapped_total) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02917"></a><span class="lineno"> 2917</span>&#160;    <span class="keywordtype">size_t</span> unmapped_total = (size_t)atomic_load32(&amp;_unmapped_total) * <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>;</div>
<div class="line"><a name="l02918"></a><span class="lineno"> 2918</span>&#160;    <span class="keywordtype">size_t</span> reserved_total = (size_t)atomic_load32(&amp;_reserved_spans) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>;</div>
<div class="line"><a name="l02919"></a><span class="lineno"> 2919</span>&#160;    fprintf(file, <span class="stringliteral">&quot;MappedMiB MappedOSMiB MappedPeakMiB MappedTotalMiB UnmappedTotalMiB ReservedTotalMiB\n&quot;</span>);</div>
<div class="line"><a name="l02920"></a><span class="lineno"> 2920</span>&#160;    fprintf(file, <span class="stringliteral">&quot;%9zu %11zu %13zu %14zu %16zu %16zu\n&quot;</span>,</div>
<div class="line"><a name="l02921"></a><span class="lineno"> 2921</span>&#160;        mapped / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02922"></a><span class="lineno"> 2922</span>&#160;        mapped_os / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02923"></a><span class="lineno"> 2923</span>&#160;        mapped_peak / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02924"></a><span class="lineno"> 2924</span>&#160;        mapped_total / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02925"></a><span class="lineno"> 2925</span>&#160;        unmapped_total / (<span class="keywordtype">size_t</span>)(1024 * 1024),</div>
<div class="line"><a name="l02926"></a><span class="lineno"> 2926</span>&#160;        reserved_total / (<span class="keywordtype">size_t</span>)(1024 * 1024));</div>
<div class="line"><a name="l02927"></a><span class="lineno"> 2927</span>&#160; </div>
<div class="line"><a name="l02928"></a><span class="lineno"> 2928</span>&#160;    fprintf(file, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l02929"></a><span class="lineno"> 2929</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02930"></a><span class="lineno"> 2930</span>&#160;    (void)<span class="keyword">sizeof</span>(file);</div>
<div class="line"><a name="l02931"></a><span class="lineno"> 2931</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02932"></a><span class="lineno"> 2932</span>&#160;}</div>
<div class="line"><a name="l02933"></a><span class="lineno"> 2933</span>&#160; </div>
<div class="line"><a name="l02934"></a><span class="lineno"> 2934</span>&#160;<span class="preprocessor">#if RPMALLOC_FIRST_CLASS_HEAPS</span></div>
<div class="line"><a name="l02935"></a><span class="lineno"> 2935</span>&#160; </div>
<div class="line"><a name="l02936"></a><span class="lineno"> 2936</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> rpmalloc_heap_t*</div>
<div class="line"><a name="l02937"></a><span class="lineno"> 2937</span>&#160;rpmalloc_heap_acquire(<span class="keywordtype">void</span>) {</div>
<div class="line"><a name="l02938"></a><span class="lineno"> 2938</span>&#160;    <span class="comment">// Must be a pristine heap from newly mapped memory pages, or else memory blocks</span></div>
<div class="line"><a name="l02939"></a><span class="lineno"> 2939</span>&#160;    <span class="comment">// could already be allocated from the heap which would (wrongly) be released when</span></div>
<div class="line"><a name="l02940"></a><span class="lineno"> 2940</span>&#160;    <span class="comment">// heap is cleared with rpmalloc_heap_free_all(). Also heaps guaranteed to be</span></div>
<div class="line"><a name="l02941"></a><span class="lineno"> 2941</span>&#160;    <span class="comment">// pristine from the dedicated orphan list can be used.</span></div>
<div class="line"><a name="l02942"></a><span class="lineno"> 2942</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* heap = <a class="code" href="rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a>(1);</div>
<div class="line"><a name="l02943"></a><span class="lineno"> 2943</span>&#160;    heap-&gt;<a class="code" href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">owner_thread</a> = 0;</div>
<div class="line"><a name="l02944"></a><span class="lineno"> 2944</span>&#160;    <a class="code" href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a>(&amp;_memory_active_heaps);</div>
<div class="line"><a name="l02945"></a><span class="lineno"> 2945</span>&#160;    <span class="keywordflow">return</span> heap;</div>
<div class="line"><a name="l02946"></a><span class="lineno"> 2946</span>&#160;}</div>
<div class="line"><a name="l02947"></a><span class="lineno"> 2947</span>&#160; </div>
<div class="line"><a name="l02948"></a><span class="lineno"> 2948</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l02949"></a><span class="lineno"> 2949</span>&#160;rpmalloc_heap_release(rpmalloc_heap_t* heap) {</div>
<div class="line"><a name="l02950"></a><span class="lineno"> 2950</span>&#160;    <span class="keywordflow">if</span> (heap)</div>
<div class="line"><a name="l02951"></a><span class="lineno"> 2951</span>&#160;        <a class="code" href="rpmalloc_8c.html#aa8eb0af2c0aa626bb527878b3401ac96">_rpmalloc_heap_release</a>(heap, 1);</div>
<div class="line"><a name="l02952"></a><span class="lineno"> 2952</span>&#160;}</div>
<div class="line"><a name="l02953"></a><span class="lineno"> 2953</span>&#160; </div>
<div class="line"><a name="l02954"></a><span class="lineno"> 2954</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02955"></a><span class="lineno"> 2955</span>&#160;rpmalloc_heap_alloc(rpmalloc_heap_t* heap, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02956"></a><span class="lineno"> 2956</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02957"></a><span class="lineno"> 2957</span>&#160;    <span class="keywordflow">if</span> (size &gt;= MAX_ALLOC_SIZE) {</div>
<div class="line"><a name="l02958"></a><span class="lineno"> 2958</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02959"></a><span class="lineno"> 2959</span>&#160;        <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02960"></a><span class="lineno"> 2960</span>&#160;    }</div>
<div class="line"><a name="l02961"></a><span class="lineno"> 2961</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02962"></a><span class="lineno"> 2962</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a>(heap, size);</div>
<div class="line"><a name="l02963"></a><span class="lineno"> 2963</span>&#160;}</div>
<div class="line"><a name="l02964"></a><span class="lineno"> 2964</span>&#160; </div>
<div class="line"><a name="l02965"></a><span class="lineno"> 2965</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02966"></a><span class="lineno"> 2966</span>&#160;rpmalloc_heap_aligned_alloc(rpmalloc_heap_t* heap, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02967"></a><span class="lineno"> 2967</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02968"></a><span class="lineno"> 2968</span>&#160;    <span class="keywordflow">if</span> (size &gt;= MAX_ALLOC_SIZE) {</div>
<div class="line"><a name="l02969"></a><span class="lineno"> 2969</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02970"></a><span class="lineno"> 2970</span>&#160;        <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l02971"></a><span class="lineno"> 2971</span>&#160;    }</div>
<div class="line"><a name="l02972"></a><span class="lineno"> 2972</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02973"></a><span class="lineno"> 2973</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, size);</div>
<div class="line"><a name="l02974"></a><span class="lineno"> 2974</span>&#160;}</div>
<div class="line"><a name="l02975"></a><span class="lineno"> 2975</span>&#160; </div>
<div class="line"><a name="l02976"></a><span class="lineno"> 2976</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02977"></a><span class="lineno"> 2977</span>&#160;rpmalloc_heap_calloc(rpmalloc_heap_t* heap, <span class="keywordtype">size_t</span> num, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02978"></a><span class="lineno"> 2978</span>&#160;    <span class="keywordflow">return</span> rpmalloc_heap_aligned_calloc(heap, 0, num, size);</div>
<div class="line"><a name="l02979"></a><span class="lineno"> 2979</span>&#160;}</div>
<div class="line"><a name="l02980"></a><span class="lineno"> 2980</span>&#160; </div>
<div class="line"><a name="l02981"></a><span class="lineno"> 2981</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l02982"></a><span class="lineno"> 2982</span>&#160;rpmalloc_heap_aligned_calloc(rpmalloc_heap_t* heap, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> num, <span class="keywordtype">size_t</span> size) {</div>
<div class="line"><a name="l02983"></a><span class="lineno"> 2983</span>&#160;    <span class="keywordtype">size_t</span> total;</div>
<div class="line"><a name="l02984"></a><span class="lineno"> 2984</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l02985"></a><span class="lineno"> 2985</span>&#160;<span class="preprocessor">#if PLATFORM_WINDOWS</span></div>
<div class="line"><a name="l02986"></a><span class="lineno"> 2986</span>&#160;    <span class="keywordtype">int</span> err = SizeTMult(num, size, &amp;total);</div>
<div class="line"><a name="l02987"></a><span class="lineno"> 2987</span>&#160;    <span class="keywordflow">if</span> ((err != S_OK) || (total &gt;= MAX_ALLOC_SIZE)) {</div>
<div class="line"><a name="l02988"></a><span class="lineno"> 2988</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02989"></a><span class="lineno"> 2989</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02990"></a><span class="lineno"> 2990</span>&#160;    }</div>
<div class="line"><a name="l02991"></a><span class="lineno"> 2991</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02992"></a><span class="lineno"> 2992</span>&#160;    <span class="keywordtype">int</span> err = __builtin_umull_overflow(num, size, &amp;total);</div>
<div class="line"><a name="l02993"></a><span class="lineno"> 2993</span>&#160;    <span class="keywordflow">if</span> (err || (total &gt;= MAX_ALLOC_SIZE)) {</div>
<div class="line"><a name="l02994"></a><span class="lineno"> 2994</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l02995"></a><span class="lineno"> 2995</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l02996"></a><span class="lineno"> 2996</span>&#160;    }</div>
<div class="line"><a name="l02997"></a><span class="lineno"> 2997</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l02998"></a><span class="lineno"> 2998</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l02999"></a><span class="lineno"> 2999</span>&#160;    total = num * size;</div>
<div class="line"><a name="l03000"></a><span class="lineno"> 3000</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03001"></a><span class="lineno"> 3001</span>&#160;    <span class="keywordtype">void</span>* block = <a class="code" href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a>(heap, alignment, total);</div>
<div class="line"><a name="l03002"></a><span class="lineno"> 3002</span>&#160;    <span class="keywordflow">if</span> (block)</div>
<div class="line"><a name="l03003"></a><span class="lineno"> 3003</span>&#160;        memset(block, 0, total);</div>
<div class="line"><a name="l03004"></a><span class="lineno"> 3004</span>&#160;    <span class="keywordflow">return</span> block;</div>
<div class="line"><a name="l03005"></a><span class="lineno"> 3005</span>&#160;}</div>
<div class="line"><a name="l03006"></a><span class="lineno"> 3006</span>&#160; </div>
<div class="line"><a name="l03007"></a><span class="lineno"> 3007</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l03008"></a><span class="lineno"> 3008</span>&#160;rpmalloc_heap_realloc(rpmalloc_heap_t* heap, <span class="keywordtype">void</span>* ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags) {</div>
<div class="line"><a name="l03009"></a><span class="lineno"> 3009</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03010"></a><span class="lineno"> 3010</span>&#160;    <span class="keywordflow">if</span> (size &gt;= MAX_ALLOC_SIZE) {</div>
<div class="line"><a name="l03011"></a><span class="lineno"> 3011</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l03012"></a><span class="lineno"> 3012</span>&#160;        <span class="keywordflow">return</span> ptr;</div>
<div class="line"><a name="l03013"></a><span class="lineno"> 3013</span>&#160;    }</div>
<div class="line"><a name="l03014"></a><span class="lineno"> 3014</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03015"></a><span class="lineno"> 3015</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a>(heap, ptr, size, 0, flags);</div>
<div class="line"><a name="l03016"></a><span class="lineno"> 3016</span>&#160;}</div>
<div class="line"><a name="l03017"></a><span class="lineno"> 3017</span>&#160; </div>
<div class="line"><a name="l03018"></a><span class="lineno"> 3018</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <a class="code" href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a> <span class="keywordtype">void</span>*</div>
<div class="line"><a name="l03019"></a><span class="lineno"> 3019</span>&#160;rpmalloc_heap_aligned_realloc(rpmalloc_heap_t* heap, <span class="keywordtype">void</span>* ptr, <span class="keywordtype">size_t</span> alignment, <span class="keywordtype">size_t</span> size, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags) {</div>
<div class="line"><a name="l03020"></a><span class="lineno"> 3020</span>&#160;<span class="preprocessor">#if ENABLE_VALIDATE_ARGS</span></div>
<div class="line"><a name="l03021"></a><span class="lineno"> 3021</span>&#160;    <span class="keywordflow">if</span> ((size + alignment &lt; size) || (alignment &gt; <a class="code" href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a>)) {</div>
<div class="line"><a name="l03022"></a><span class="lineno"> 3022</span>&#160;        errno = EINVAL;</div>
<div class="line"><a name="l03023"></a><span class="lineno"> 3023</span>&#160;        <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l03024"></a><span class="lineno"> 3024</span>&#160;    }</div>
<div class="line"><a name="l03025"></a><span class="lineno"> 3025</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03026"></a><span class="lineno"> 3026</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a>(heap, ptr, alignment, size, 0, flags);  </div>
<div class="line"><a name="l03027"></a><span class="lineno"> 3027</span>&#160;}</div>
<div class="line"><a name="l03028"></a><span class="lineno"> 3028</span>&#160; </div>
<div class="line"><a name="l03029"></a><span class="lineno"> 3029</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03030"></a><span class="lineno"> 3030</span>&#160;rpmalloc_heap_free(rpmalloc_heap_t* heap, <span class="keywordtype">void</span>* ptr) {</div>
<div class="line"><a name="l03031"></a><span class="lineno"> 3031</span>&#160;    (void)<span class="keyword">sizeof</span>(heap);</div>
<div class="line"><a name="l03032"></a><span class="lineno"> 3032</span>&#160;    <a class="code" href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a>(ptr);</div>
<div class="line"><a name="l03033"></a><span class="lineno"> 3033</span>&#160;}</div>
<div class="line"><a name="l03034"></a><span class="lineno"> 3034</span>&#160; </div>
<div class="line"><a name="l03035"></a><span class="lineno"> 3035</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03036"></a><span class="lineno"> 3036</span>&#160;rpmalloc_heap_free_all(rpmalloc_heap_t* heap) {</div>
<div class="line"><a name="l03037"></a><span class="lineno"> 3037</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* span;</div>
<div class="line"><a name="l03038"></a><span class="lineno"> 3038</span>&#160;    <a class="code" href="structspan__t.html">span_t</a>* next_span;</div>
<div class="line"><a name="l03039"></a><span class="lineno"> 3039</span>&#160; </div>
<div class="line"><a name="l03040"></a><span class="lineno"> 3040</span>&#160;    <a class="code" href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a>(heap, 0);</div>
<div class="line"><a name="l03041"></a><span class="lineno"> 3041</span>&#160; </div>
<div class="line"><a name="l03042"></a><span class="lineno"> 3042</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l03043"></a><span class="lineno"> 3043</span>&#160;        span = heap-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>[iclass].partial_span;</div>
<div class="line"><a name="l03044"></a><span class="lineno"> 3044</span>&#160;        <span class="keywordflow">while</span> (span) {</div>
<div class="line"><a name="l03045"></a><span class="lineno"> 3045</span>&#160;            next_span = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03046"></a><span class="lineno"> 3046</span>&#160;            <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l03047"></a><span class="lineno"> 3047</span>&#160;            span = next_span;</div>
<div class="line"><a name="l03048"></a><span class="lineno"> 3048</span>&#160;        }</div>
<div class="line"><a name="l03049"></a><span class="lineno"> 3049</span>&#160;        heap-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a>[iclass].partial_span = 0;</div>
<div class="line"><a name="l03050"></a><span class="lineno"> 3050</span>&#160;        span = heap-&gt;full_span[iclass];</div>
<div class="line"><a name="l03051"></a><span class="lineno"> 3051</span>&#160;        <span class="keywordflow">while</span> (span) {</div>
<div class="line"><a name="l03052"></a><span class="lineno"> 3052</span>&#160;            next_span = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03053"></a><span class="lineno"> 3053</span>&#160;            <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l03054"></a><span class="lineno"> 3054</span>&#160;            span = next_span;</div>
<div class="line"><a name="l03055"></a><span class="lineno"> 3055</span>&#160;        }</div>
<div class="line"><a name="l03056"></a><span class="lineno"> 3056</span>&#160;    }</div>
<div class="line"><a name="l03057"></a><span class="lineno"> 3057</span>&#160;    memset(heap-&gt;size_class, 0, <span class="keyword">sizeof</span>(heap-&gt;size_class));</div>
<div class="line"><a name="l03058"></a><span class="lineno"> 3058</span>&#160;    memset(heap-&gt;full_span, 0, <span class="keyword">sizeof</span>(heap-&gt;full_span));</div>
<div class="line"><a name="l03059"></a><span class="lineno"> 3059</span>&#160; </div>
<div class="line"><a name="l03060"></a><span class="lineno"> 3060</span>&#160;    span = heap-&gt;large_huge_span;</div>
<div class="line"><a name="l03061"></a><span class="lineno"> 3061</span>&#160;    <span class="keywordflow">while</span> (span) {</div>
<div class="line"><a name="l03062"></a><span class="lineno"> 3062</span>&#160;        next_span = span-&gt;<a class="code" href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">next</a>;</div>
<div class="line"><a name="l03063"></a><span class="lineno"> 3063</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a>(span-&gt;<a class="code" href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">size_class</a> == <a class="code" href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a>))</div>
<div class="line"><a name="l03064"></a><span class="lineno"> 3064</span>&#160;            <a class="code" href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46">_rpmalloc_deallocate_huge</a>(span);</div>
<div class="line"><a name="l03065"></a><span class="lineno"> 3065</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03066"></a><span class="lineno"> 3066</span>&#160;            <a class="code" href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a>(heap, span);</div>
<div class="line"><a name="l03067"></a><span class="lineno"> 3067</span>&#160;        span = next_span;</div>
<div class="line"><a name="l03068"></a><span class="lineno"> 3068</span>&#160;    }</div>
<div class="line"><a name="l03069"></a><span class="lineno"> 3069</span>&#160;    heap-&gt;large_huge_span = 0;</div>
<div class="line"><a name="l03070"></a><span class="lineno"> 3070</span>&#160;    heap-&gt;full_span_count = 0;</div>
<div class="line"><a name="l03071"></a><span class="lineno"> 3071</span>&#160; </div>
<div class="line"><a name="l03072"></a><span class="lineno"> 3072</span>&#160;<span class="preprocessor">#if ENABLE_THREAD_CACHE</span></div>
<div class="line"><a name="l03073"></a><span class="lineno"> 3073</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l03074"></a><span class="lineno"> 3074</span>&#160;        <a class="code" href="structspan__cache__t.html">span_cache_t</a>* span_cache;</div>
<div class="line"><a name="l03075"></a><span class="lineno"> 3075</span>&#160;        <span class="keywordflow">if</span> (!iclass)</div>
<div class="line"><a name="l03076"></a><span class="lineno"> 3076</span>&#160;            span_cache = &amp;heap-&gt;span_cache;</div>
<div class="line"><a name="l03077"></a><span class="lineno"> 3077</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l03078"></a><span class="lineno"> 3078</span>&#160;            span_cache = (<a class="code" href="structspan__cache__t.html">span_cache_t</a>*)(heap-&gt;span_large_cache + (iclass - 1));</div>
<div class="line"><a name="l03079"></a><span class="lineno"> 3079</span>&#160;        <span class="keywordflow">if</span> (!span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>)</div>
<div class="line"><a name="l03080"></a><span class="lineno"> 3080</span>&#160;            <span class="keywordflow">continue</span>;</div>
<div class="line"><a name="l03081"></a><span class="lineno"> 3081</span>&#160;<span class="preprocessor">#if ENABLE_GLOBAL_CACHE</span></div>
<div class="line"><a name="l03082"></a><span class="lineno"> 3082</span>&#160;        <a class="code" href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a>(&amp;heap-&gt;thread_to_global, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> * (iclass + 1) * <a class="code" href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a>);</div>
<div class="line"><a name="l03083"></a><span class="lineno"> 3083</span>&#160;        <a class="code" href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a>(&amp;heap-&gt;span_use[iclass].spans_to_global, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l03084"></a><span class="lineno"> 3084</span>&#160;        <a class="code" href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>, iclass + 1, span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>);</div>
<div class="line"><a name="l03085"></a><span class="lineno"> 3085</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l03086"></a><span class="lineno"> 3086</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> ispan = 0; ispan &lt; span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a>; ++ispan)</div>
<div class="line"><a name="l03087"></a><span class="lineno"> 3087</span>&#160;            <a class="code" href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a>(span_cache-&gt;<a class="code" href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span</a>[ispan]);</div>
<div class="line"><a name="l03088"></a><span class="lineno"> 3088</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03089"></a><span class="lineno"> 3089</span>&#160;        span_cache-&gt;<a class="code" href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">count</a> = 0;</div>
<div class="line"><a name="l03090"></a><span class="lineno"> 3090</span>&#160;    }</div>
<div class="line"><a name="l03091"></a><span class="lineno"> 3091</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03092"></a><span class="lineno"> 3092</span>&#160; </div>
<div class="line"><a name="l03093"></a><span class="lineno"> 3093</span>&#160;<span class="preprocessor">#if ENABLE_STATISTICS</span></div>
<div class="line"><a name="l03094"></a><span class="lineno"> 3094</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l03095"></a><span class="lineno"> 3095</span>&#160;        <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;size_class_use[iclass].alloc_current, 0);</div>
<div class="line"><a name="l03096"></a><span class="lineno"> 3096</span>&#160;        <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;size_class_use[iclass].spans_current, 0);</div>
<div class="line"><a name="l03097"></a><span class="lineno"> 3097</span>&#160;    }</div>
<div class="line"><a name="l03098"></a><span class="lineno"> 3098</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> iclass = 0; iclass &lt; <a class="code" href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a>; ++iclass) {</div>
<div class="line"><a name="l03099"></a><span class="lineno"> 3099</span>&#160;        <a class="code" href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a>(&amp;heap-&gt;span_use[iclass].current, 0 );</div>
<div class="line"><a name="l03100"></a><span class="lineno"> 3100</span>&#160;    }</div>
<div class="line"><a name="l03101"></a><span class="lineno"> 3101</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03102"></a><span class="lineno"> 3102</span>&#160;}</div>
<div class="line"><a name="l03103"></a><span class="lineno"> 3103</span>&#160; </div>
<div class="line"><a name="l03104"></a><span class="lineno"> 3104</span>&#160;<span class="keyword">extern</span> <span class="keyword">inline</span> <span class="keywordtype">void</span></div>
<div class="line"><a name="l03105"></a><span class="lineno"> 3105</span>&#160;rpmalloc_heap_thread_set_current(rpmalloc_heap_t* heap) {</div>
<div class="line"><a name="l03106"></a><span class="lineno"> 3106</span>&#160;    <a class="code" href="structheap__t.html">heap_t</a>* prev_heap = <a class="code" href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a>();</div>
<div class="line"><a name="l03107"></a><span class="lineno"> 3107</span>&#160;    <span class="keywordflow">if</span> (prev_heap != heap) {</div>
<div class="line"><a name="l03108"></a><span class="lineno"> 3108</span>&#160;        <a class="code" href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a>(heap);</div>
<div class="line"><a name="l03109"></a><span class="lineno"> 3109</span>&#160;        <span class="keywordflow">if</span> (prev_heap)</div>
<div class="line"><a name="l03110"></a><span class="lineno"> 3110</span>&#160;            rpmalloc_heap_release(prev_heap);</div>
<div class="line"><a name="l03111"></a><span class="lineno"> 3111</span>&#160;    }</div>
<div class="line"><a name="l03112"></a><span class="lineno"> 3112</span>&#160;}</div>
<div class="line"><a name="l03113"></a><span class="lineno"> 3113</span>&#160; </div>
<div class="line"><a name="l03114"></a><span class="lineno"> 3114</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03115"></a><span class="lineno"> 3115</span>&#160; </div>
<div class="line"><a name="l03116"></a><span class="lineno"> 3116</span>&#160;<span class="preprocessor">#if ENABLE_PRELOAD || ENABLE_OVERRIDE</span></div>
<div class="line"><a name="l03117"></a><span class="lineno"> 3117</span>&#160; </div>
<div class="line"><a name="l03118"></a><span class="lineno"> 3118</span>&#160;<span class="preprocessor">#include &quot;malloc.c&quot;</span></div>
<div class="line"><a name="l03119"></a><span class="lineno"> 3119</span>&#160; </div>
<div class="line"><a name="l03120"></a><span class="lineno"> 3120</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="arpmalloc_8c_html_a58f109a58b8e38970cda041f4ea96772"><div class="ttname"><a href="rpmalloc_8c.html#a58f109a58b8e38970cda041f4ea96772">_rpmalloc_heap_initialize</a></div><div class="ttdeci">static void _rpmalloc_heap_initialize(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01550">rpmalloc.c:1550</a></div></div>
<div class="ttc" id="astructspan__large__cache__t_html_a07da73cfe1c11642973a6eb1386a3a1c"><div class="ttname"><a href="structspan__large__cache__t.html#a07da73cfe1c11642973a6eb1386a3a1c">span_large_cache_t::count</a></div><div class="ttdeci">size_t count</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00465">rpmalloc.c:465</a></div></div>
<div class="ttc" id="astructheap__t_html_a6aa789c3cdf7e70df144c248d18c5f4c"><div class="ttname"><a href="structheap__t.html#a6aa789c3cdf7e70df144c248d18c5f4c">heap_t::full_span_count</a></div><div class="ttdeci">size_t full_span_count</div><div class="ttdoc">Number of full spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00494">rpmalloc.c:494</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a04406da3f5ff4e24f155c97591678ed9"><div class="ttname"><a href="rpmalloc_8c.html#a04406da3f5ff4e24f155c97591678ed9">LARGE_CLASS_COUNT</a></div><div class="ttdeci">#define LARGE_CLASS_COUNT</div><div class="ttdoc">Number of large block size classes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00300">rpmalloc.c:300</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html">rpmalloc_thread_statistics_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00085">rpmalloc.h:85</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abdbbc20ab63d76c1709722f3f2305610"><div class="ttname"><a href="rpmalloc_8c.html#abdbbc20ab63d76c1709722f3f2305610">_rpmalloc_heap_cache_insert</a></div><div class="ttdeci">static void _rpmalloc_heap_cache_insert(heap_t *heap, span_t *span)</div><div class="ttdoc">Span control.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01388">rpmalloc.c:1388</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_ab1a81b9e7c3dee077fafc85b5327ea6b"><div class="ttname"><a href="structrpmalloc__config__t.html#ab1a81b9e7c3dee077fafc85b5327ea6b">rpmalloc_config_t::memory_map</a></div><div class="ttdeci">void *(* memory_map)(size_t size, size_t *offset)</div><div class="ttdoc">Map memory pages for the given number of bytes. The returned address MUST be.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00147">rpmalloc.h:147</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a000afcda168a6fd19a9435e049508463"><div class="ttname"><a href="rpmalloc_8c.html#a000afcda168a6fd19a9435e049508463">SMALL_GRANULARITY</a></div><div class="ttdeci">#define SMALL_GRANULARITY</div><div class="ttdoc">Preconfigured limits and sizes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00284">rpmalloc.c:284</a></div></div>
<div class="ttc" id="astructspan__t_html_abf4fa6f8f0e7baff0d6a7a96df58bcca"><div class="ttname"><a href="structspan__t.html#abf4fa6f8f0e7baff0d6a7a96df58bcca">span_t::used_count</a></div><div class="ttdeci">uint32_t used_count</div><div class="ttdoc">Number of used blocks remaining when in partial state.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00430">rpmalloc.c:430</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3cf2ef5bd78a81c297328a5534f0ddf4"><div class="ttname"><a href="rpmalloc_8c.html#a3cf2ef5bd78a81c297328a5534f0ddf4">TLS_MODEL</a></div><div class="ttdeci">#define TLS_MODEL</div><div class="ttdoc">Thread local heap and ID.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00663">rpmalloc.c:663</a></div></div>
<div class="ttc" id="aringbuf__utils_8h_html_aa1c16a769601f3748a5839b20e6bd80e"><div class="ttname"><a href="ringbuf__utils_8h.html#aa1c16a769601f3748a5839b20e6bd80e">memory_order_release</a></div><div class="ttdeci">#define memory_order_release</div><div class="ttdef"><b>Definition:</b> <a href="ringbuf__utils_8h_source.html#l00085">ringbuf_utils.h:85</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae6278b2864893c2bc2d86b5d6d9f2d51"><div class="ttname"><a href="rpmalloc_8c.html#ae6278b2864893c2bc2d86b5d6d9f2d51">rpmalloc_global_statistics</a></div><div class="ttdeci">void rpmalloc_global_statistics(rpmalloc_global_statistics_t *stats)</div><div class="ttdoc">Get global statistics.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02813">rpmalloc.c:2813</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a255e3ca61cb348d1f1f3bab7634e1a2c"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a255e3ca61cb348d1f1f3bab7634e1a2c">rpmalloc_thread_statistics_t::spans_to_cache</a></div><div class="ttdeci">size_t spans_to_cache</div><div class="ttdoc">Number of spans transitioned to cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00126">rpmalloc.h:126</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2f7a67a3403fd19a70e7a0418714af57"><div class="ttname"><a href="rpmalloc_8c.html#a2f7a67a3403fd19a70e7a0418714af57">_rpmalloc_heap_global_finalize</a></div><div class="ttdeci">static void _rpmalloc_heap_global_finalize(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01340">rpmalloc.c:1340</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2aaa6595462b280c7c95e7804ab6f9fd"><div class="ttname"><a href="rpmalloc_8c.html#a2aaa6595462b280c7c95e7804ab6f9fd">rpcalloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpcalloc(size_t num, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02639">rpmalloc.c:2639</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a240396bd63b0822a9ec0ade52cab44b2"><div class="ttname"><a href="rpmalloc_8c.html#a240396bd63b0822a9ec0ade52cab44b2">rprealloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rprealloc(void *ptr, size_t size)</div><div class="ttdoc">Reallocate the given block to at least the given size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02666">rpmalloc.c:2666</a></div></div>
<div class="ttc" id="aringbuf__utils_8h_html_a79e2a618fa655a8bb4dcfc585dfc1780"><div class="ttname"><a href="ringbuf__utils_8h.html#a79e2a618fa655a8bb4dcfc585dfc1780">memory_order_acquire</a></div><div class="ttdeci">#define memory_order_acquire</div><div class="ttdef"><b>Definition:</b> <a href="ringbuf__utils_8h_source.html#l00084">ringbuf_utils.h:84</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a21ea40b81bca2d791bb633dd5602dee8"><div class="ttname"><a href="rpmalloc_8c.html#a21ea40b81bca2d791bb633dd5602dee8">free_list_pop</a></div><div class="ttdeci">static void * free_list_pop(void **list)</div><div class="ttdoc">Allocation entry points.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01739">rpmalloc.c:1739</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a3561e0c5cc9789f4f370cf5aa7044df5"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a3561e0c5cc9789f4f370cf5aa7044df5">rpmalloc_thread_statistics_t::size_use</a></div><div class="ttdeci">struct rpmalloc_thread_statistics_t::@9 size_use[128]</div><div class="ttdoc">Per size class statistics (only if ENABLE_STATISTICS=1)</div></div>
<div class="ttc" id="arpmalloc_8c_html_a49d22808308e599742e41ef2d4671cfa"><div class="ttname"><a href="rpmalloc_8c.html#a49d22808308e599742e41ef2d4671cfa">_rpmalloc_span_double_link_list_pop_head</a></div><div class="ttdeci">static void _rpmalloc_span_double_link_list_pop_head(span_t **head, span_t *span)</div><div class="ttdoc">Pop head span from double linked list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00874">rpmalloc.c:874</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abd4c41e806e09b0468b6db0ae56ed461"><div class="ttname"><a href="rpmalloc_8c.html#abd4c41e806e09b0468b6db0ae56ed461">_rpmalloc_stat_inc_alloc</a></div><div class="ttdeci">#define _rpmalloc_stat_inc_alloc(heap, class_idx)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00274">rpmalloc.c:274</a></div></div>
<div class="ttc" id="astructspan__t_html"><div class="ttname"><a href="structspan__t.html">span_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00420">rpmalloc.c:420</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af44e92f7ed42c434bd33a0ae98210a3f"><div class="ttname"><a href="rpmalloc_8c.html#af44e92f7ed42c434bd33a0ae98210a3f">_rpmalloc_heap_cache_adopt_deferred</a></div><div class="ttdeci">static void _rpmalloc_heap_cache_adopt_deferred(heap_t *heap, span_t **single_span)</div><div class="ttdoc">Adopt the deferred span cache list, optionally extracting the first single span for immediate re-use.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01279">rpmalloc.c:1279</a></div></div>
<div class="ttc" id="aringbuf__utils_8h_html_a97d09c5205f08d3094379e5555289ab0"><div class="ttname"><a href="ringbuf__utils_8h.html#a97d09c5205f08d3094379e5555289ab0">atomic_store_explicit</a></div><div class="ttdeci">#define atomic_store_explicit</div><div class="ttdef"><b>Definition:</b> <a href="ringbuf__utils_8h_source.html#l00090">ringbuf_utils.h:90</a></div></div>
<div class="ttc" id="astructheap__t_html_a8d5b27011e1ab5140090f90a75584329"><div class="ttname"><a href="structheap__t.html#a8d5b27011e1ab5140090f90a75584329">heap_t::spans_reserved</a></div><div class="ttdeci">uint32_t spans_reserved</div><div class="ttdoc">Number of mapped but unused spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00500">rpmalloc.c:500</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af8f864d9fe0055b43dc8034fe9060630"><div class="ttname"><a href="rpmalloc_8c.html#af8f864d9fe0055b43dc8034fe9060630">UNEXPECTED</a></div><div class="ttdeci">#define UNEXPECTED(x)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00240">rpmalloc.c:240</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af281178bc271d4b4a2f2bd11f17adc04"><div class="ttname"><a href="rpmalloc_8c.html#af281178bc271d4b4a2f2bd11f17adc04">_rpmalloc_heap_extract_orphan</a></div><div class="ttdeci">static heap_t * _rpmalloc_heap_extract_orphan(heap_t **heap_list)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01603">rpmalloc.c:1603</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a303f700546874a81e694eda44cc3174d"><div class="ttname"><a href="rpmalloc_8c.html#a303f700546874a81e694eda44cc3174d">atomic_cas_ptr</a></div><div class="ttdeci">static FORCEINLINE int atomic_cas_ptr(atomicptr_t *dst, void *val, void *ref)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00237">rpmalloc.c:237</a></div></div>
<div class="ttc" id="astructspan__cache__t_html_a894a66f329862f01de7619aee1954d19"><div class="ttname"><a href="structspan__cache__t.html#a894a66f329862f01de7619aee1954d19">span_cache_t::count</a></div><div class="ttdeci">size_t count</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00459">rpmalloc.c:459</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab4225911698b67188e1538c334cfe16c"><div class="ttname"><a href="rpmalloc_8c.html#ab4225911698b67188e1538c334cfe16c">pointer_offset</a></div><div class="ttdeci">#define pointer_offset(ptr, ofs)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00325">rpmalloc.c:325</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a58df6aa2dfcdd796fd55cd102fdb177f"><div class="ttname"><a href="rpmalloc_8c.html#a58df6aa2dfcdd796fd55cd102fdb177f">_memory_span_size</a></div><div class="ttdeci">#define _memory_span_size</div><div class="ttdoc">Hardwired span size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00594">rpmalloc.c:594</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a84e326ca88dee0bd7ca995727bb52381"><div class="ttname"><a href="rpmalloc_8c.html#a84e326ca88dee0bd7ca995727bb52381">get_thread_id</a></div><div class="ttdeci">static uintptr_t get_thread_id(void)</div><div class="ttdoc">Fast thread ID.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00696">rpmalloc.c:696</a></div></div>
<div class="ttc" id="astructglobal__cache__t_html_a440c6f31099f3836f7beb5e47d14fb2d"><div class="ttname"><a href="structglobal__cache__t.html#a440c6f31099f3836f7beb5e47d14fb2d">global_cache_t::count</a></div><div class="ttdeci">uint32_t count</div><div class="ttdoc">Cache count.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00555">rpmalloc.c:555</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac8a96725f034c08fdff774eb54785947"><div class="ttname"><a href="rpmalloc_8c.html#ac8a96725f034c08fdff774eb54785947">_rpmalloc_deallocate_defer_free_span</a></div><div class="ttdeci">static void _rpmalloc_deallocate_defer_free_span(heap_t *heap, span_t *span)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02037">rpmalloc.c:2037</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0cbe158c682e307dc9372ee5a0b5167a"><div class="ttname"><a href="rpmalloc_8c.html#a0cbe158c682e307dc9372ee5a0b5167a">MEDIUM_GRANULARITY</a></div><div class="ttdeci">#define MEDIUM_GRANULARITY</div><div class="ttdoc">Granularity of a medium allocation block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00292">rpmalloc.c:292</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a34805759f2f107ac549c3394840ebf35"><div class="ttname"><a href="rpmalloc_8c.html#a34805759f2f107ac549c3394840ebf35">_rpmalloc_heap_allocate_new</a></div><div class="ttdeci">static heap_t * _rpmalloc_heap_allocate_new(void)</div><div class="ttdoc">Allocate a new heap from newly mapped memory pages.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01575">rpmalloc.c:1575</a></div></div>
<div class="ttc" id="astructspan__t_html_ad842dbc76a30fb5beee77a2d773a3e91"><div class="ttname"><a href="structspan__t.html#ad842dbc76a30fb5beee77a2d773a3e91">span_t::list_size</a></div><div class="ttdeci">uint32_t list_size</div><div class="ttdoc">Size of deferred free list, or list of spans when part of a cache list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00434">rpmalloc.c:434</a></div></div>
<div class="ttc" id="arpmalloc_8h_html"><div class="ttname"><a href="rpmalloc_8h.html">rpmalloc.h</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3667b745f7290a10ff5c5a71575533d9"><div class="ttname"><a href="rpmalloc_8c.html#a3667b745f7290a10ff5c5a71575533d9">_memory_page_size</a></div><div class="ttdeci">static size_t _memory_page_size</div><div class="ttdoc">Memory page size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00580">rpmalloc.c:580</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad7af40ab0c9174515ec06efb45ebdd73"><div class="ttname"><a href="rpmalloc_8c.html#ad7af40ab0c9174515ec06efb45ebdd73">_memory_span_cache</a></div><div class="ttdeci">static global_cache_t _memory_span_cache[LARGE_CLASS_COUNT]</div><div class="ttdoc">Global span cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00614">rpmalloc.c:614</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab3168e56cb172bc471c410e9daaf7ca1"><div class="ttname"><a href="rpmalloc_8c.html#ab3168e56cb172bc471c410e9daaf7ca1">_rpmalloc_stat_inc_free</a></div><div class="ttdeci">#define _rpmalloc_stat_inc_free(heap, class_idx)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00275">rpmalloc.c:275</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a93550a9f6f5b5024d7af279f1c2d624c"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a93550a9f6f5b5024d7af279f1c2d624c">rpmalloc_thread_statistics_t::free_total</a></div><div class="ttdeci">size_t free_total</div><div class="ttdoc">Total number of frees.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00124">rpmalloc.h:124</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad50f153ecceb184b179138a3965954b6"><div class="ttname"><a href="rpmalloc_8c.html#ad50f153ecceb184b179138a3965954b6">_rpmalloc_heap_extract_new_span</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_extract_new_span(heap_t *heap, size_t span_count, uint32_t class_idx)</div><div class="ttdoc">Get a span from one of the cache levels (thread cache, reserved, global cache) or fallback to mapping...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01505">rpmalloc.c:1505</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a90593dceacf0c04f14d084bed7e7eabe"><div class="ttname"><a href="rpmalloc_8c.html#a90593dceacf0c04f14d084bed7e7eabe">EXPECTED</a></div><div class="ttdeci">#define EXPECTED(x)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00239">rpmalloc.c:239</a></div></div>
<div class="ttc" id="astructspan__t_html_a22b0340927d02f0c7c4486f01c31358e"><div class="ttname"><a href="structspan__t.html#a22b0340927d02f0c7c4486f01c31358e">span_t::free_list_deferred</a></div><div class="ttdeci">atomicptr_t free_list_deferred</div><div class="ttdoc">Deferred free list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00432">rpmalloc.c:432</a></div></div>
<div class="ttc" id="aringbuf__utils_8h_html_af85affb01b77d2d468ee9c93b5b42ef9"><div class="ttname"><a href="ringbuf__utils_8h.html#af85affb01b77d2d468ee9c93b5b42ef9">memory_order_relaxed</a></div><div class="ttdeci">#define memory_order_relaxed</div><div class="ttdef"><b>Definition:</b> <a href="ringbuf__utils_8h_source.html#l00083">ringbuf_utils.h:83</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_ab3774a093749aeca1d4e387b11e79395"><div class="ttname"><a href="rpmalloc_8h.html#ab3774a093749aeca1d4e387b11e79395">RPMALLOC_GROW_OR_FAIL</a></div><div class="ttdeci">#define RPMALLOC_GROW_OR_FAIL</div><div class="ttdoc">Flag to rpaligned_realloc to fail and return null pointer if grow cannot be done in-place,...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00066">rpmalloc.h:66</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a83ddc23debb02a3c47f0b00939fc8f35"><div class="ttname"><a href="rpmalloc_8c.html#a83ddc23debb02a3c47f0b00939fc8f35">atomic_load_ptr</a></div><div class="ttdeci">static FORCEINLINE void * atomic_load_ptr(atomicptr_t *src)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00233">rpmalloc.c:233</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_ad5723376daeb707aa20547190ced2865"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#ad5723376daeb707aa20547190ced2865">rpmalloc_global_statistics_t::mapped_peak</a></div><div class="ttdeci">size_t mapped_peak</div><div class="ttdoc">Peak amount of virtual memory mapped, all of which might not have been committed (only if ENABLE_STAT...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00072">rpmalloc.h:72</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aec7913670102d551e3fd60509cd381a3"><div class="ttname"><a href="rpmalloc_8c.html#aec7913670102d551e3fd60509cd381a3">_rpmalloc_span_double_link_list_remove</a></div><div class="ttdeci">static void _rpmalloc_span_double_link_list_remove(span_t **head, span_t *span)</div><div class="ttdoc">Remove a span from double linked list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00882">rpmalloc.c:882</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a04a025a8c2529bc60cb95c78d3948c52"><div class="ttname"><a href="rpmalloc_8c.html#a04a025a8c2529bc60cb95c78d3948c52">_memory_default_span_size</a></div><div class="ttdeci">#define _memory_default_span_size</div><div class="ttdoc">Global data.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00571">rpmalloc.c:571</a></div></div>
<div class="ttc" id="authash_8h_html_a435d1572bf3f880d55459d9805097f62"><div class="ttname"><a href="uthash_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div><div class="ttdeci">unsigned int uint32_t</div><div class="ttdef"><b>Definition:</b> <a href="uthash_8h_source.html#l00078">uthash.h:78</a></div></div>
<div class="ttc" id="astructheap__t_html_aa6719c6b21d6c30ce96e404a63cc4bae"><div class="ttname"><a href="structheap__t.html#aa6719c6b21d6c30ce96e404a63cc4bae">heap_t::span_reserve_master</a></div><div class="ttdeci">span_t * span_reserve_master</div><div class="ttdoc">Master span for mapped but unused spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00498">rpmalloc.c:498</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a079156bbe2b2ed6c95e5f203916375fa"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a079156bbe2b2ed6c95e5f203916375fa">rpmalloc_thread_statistics_t::from_global</a></div><div class="ttdeci">size_t from_global</div><div class="ttdoc">Number of spans transitioned from global cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00103">rpmalloc.h:103</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a03eedb1d5d48520b6ec939744051f9ee"><div class="ttname"><a href="rpmalloc_8c.html#a03eedb1d5d48520b6ec939744051f9ee">_memory_span_release_count</a></div><div class="ttdeci">static size_t _memory_span_release_count</div><div class="ttdoc">Number of spans to release from thread cache to global cache (single spans)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00601">rpmalloc.c:601</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af801d58362e979c2a31744800624dcf9"><div class="ttname"><a href="rpmalloc_8c.html#af801d58362e979c2a31744800624dcf9">span_active_t</a></div><div class="ttdeci">struct span_active_t span_active_t</div><div class="ttdoc">Span active data.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00346">rpmalloc.c:346</a></div></div>
<div class="ttc" id="astructheap__t_html_a87e83453c93d1e6de70f6a45044e510d"><div class="ttname"><a href="structheap__t.html#a87e83453c93d1e6de70f6a45044e510d">heap_t::next_orphan</a></div><div class="ttdeci">heap_t * next_orphan</div><div class="ttdoc">Next heap in orphan list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00506">rpmalloc.c:506</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_aaa9983844f7fcf2da6731ad8ca784f93"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#aaa9983844f7fcf2da6731ad8ca784f93">rpmalloc_thread_statistics_t::span_use</a></div><div class="ttdeci">struct rpmalloc_thread_statistics_t::@8 span_use[64]</div><div class="ttdoc">Per span count statistics (only if ENABLE_STATISTICS=1)</div></div>
<div class="ttc" id="arpmalloc_8c_html_a3dedf1d71cda4a8f3d1f372934ddad30"><div class="ttname"><a href="rpmalloc_8c.html#a3dedf1d71cda4a8f3d1f372934ddad30">_memory_default_span_size_shift</a></div><div class="ttdeci">#define _memory_default_span_size_shift</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00572">rpmalloc.c:572</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6414f61e9643ce358f1a33e6a2c6aeaa"><div class="ttname"><a href="rpmalloc_8c.html#a6414f61e9643ce358f1a33e6a2c6aeaa">_rpmalloc_initialized</a></div><div class="ttdeci">static int _rpmalloc_initialized</div><div class="ttdoc">Initialized flag.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00576">rpmalloc.c:576</a></div></div>
<div class="ttc" id="astructheap__t_html_a59fb66e831ef1e0d56d826b1851576eb"><div class="ttname"><a href="structheap__t.html#a59fb66e831ef1e0d56d826b1851576eb">heap_t::child_count</a></div><div class="ttdeci">atomic32_t child_count</div><div class="ttdoc">Child count.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00502">rpmalloc.c:502</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2ae01990651a75a352409fb1fbf85d05"><div class="ttname"><a href="rpmalloc_8c.html#a2ae01990651a75a352409fb1fbf85d05">rpmalloc_initialize_config</a></div><div class="ttdeci">int rpmalloc_initialize_config(const rpmalloc_config_t *config)</div><div class="ttdoc">Initialize allocator with given configuration.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02346">rpmalloc.c:2346</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2d8a3eac487ff2943f8aae4dd20badd3"><div class="ttname"><a href="rpmalloc_8c.html#a2d8a3eac487ff2943f8aae4dd20badd3">_rpmalloc_mmap</a></div><div class="ttdeci">static void * _rpmalloc_mmap(size_t size, size_t *offset)</div><div class="ttdoc">Low level memory map/unmap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00743">rpmalloc.c:743</a></div></div>
<div class="ttc" id="astructspan__t_html_a4aecbd1cbb36425fddd53125ea1a84c7"><div class="ttname"><a href="structspan__t.html#a4aecbd1cbb36425fddd53125ea1a84c7">span_t::remaining_spans</a></div><div class="ttdeci">atomic32_t remaining_spans</div><div class="ttdoc">Remaining span counter, for master spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00446">rpmalloc.c:446</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4a53d0cfdcf755d4fbbae446a055440c"><div class="ttname"><a href="rpmalloc_8c.html#a4a53d0cfdcf755d4fbbae446a055440c">_rpmalloc_stat_add</a></div><div class="ttdeci">#define _rpmalloc_stat_add(counter, value)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00270">rpmalloc.c:270</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a91bf3ee061b188b8a650fbac9babef4a"><div class="ttname"><a href="rpmalloc_8c.html#a91bf3ee061b188b8a650fbac9babef4a">_rpmalloc_span_mark_as_subspan_unless_master</a></div><div class="ttdeci">static void _rpmalloc_span_mark_as_subspan_unless_master(span_t *master, span_t *subspan, size_t span_count)</div><div class="ttdoc">Declare the span to be a subspan and store distance from master span and span count.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00914">rpmalloc.c:914</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac7e4a352a230ef04d4372db43a454b7f"><div class="ttname"><a href="rpmalloc_8c.html#ac7e4a352a230ef04d4372db43a454b7f">HEAP_ARRAY_SIZE</a></div><div class="ttdeci">#define HEAP_ARRAY_SIZE</div><div class="ttdoc">Build time configurable limits.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00030">rpmalloc.c:30</a></div></div>
<div class="ttc" id="aringbuf__utils_8h_html_ac51df1d84ac23ed8f656f9fbc3f66363"><div class="ttname"><a href="ringbuf__utils_8h.html#ac51df1d84ac23ed8f656f9fbc3f66363">atomic_load_explicit</a></div><div class="ttdeci">#define atomic_load_explicit</div><div class="ttdef"><b>Definition:</b> <a href="ringbuf__utils_8h_source.html#l00093">ringbuf_utils.h:93</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_aa896cafa124a63254f56621fe2c5241f"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#aa896cafa124a63254f56621fe2c5241f">rpmalloc_global_statistics_t::unmapped_total</a></div><div class="ttdeci">size_t unmapped_total</div><div class="ttdoc">Total amount of memory unmapped since initialization (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00082">rpmalloc.h:82</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a0b1fa423f8933d241c6f3a19a9e77e20"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a0b1fa423f8933d241c6f3a19a9e77e20">rpmalloc_thread_statistics_t::to_reserved</a></div><div class="ttdeci">size_t to_reserved</div><div class="ttdoc">Number of spans transitioned to reserved state.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00109">rpmalloc.h:109</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af330a53810a7e9a1d2a151bc229a9dc4"><div class="ttname"><a href="rpmalloc_8c.html#af330a53810a7e9a1d2a151bc229a9dc4">rpmalloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpmalloc(size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02622">rpmalloc.c:2622</a></div></div>
<div class="ttc" id="astructspan__t_html_af093d9cb1719d72c20f96a9b467590f5"><div class="ttname"><a href="structspan__t.html#af093d9cb1719d72c20f96a9b467590f5">span_t::free_list_limit</a></div><div class="ttdeci">uint32_t free_list_limit</div><div class="ttdoc">Index of last block initialized in free list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00428">rpmalloc.c:428</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae6f35022f9384e2a22ed2b96c00995b2"><div class="ttname"><a href="rpmalloc_8c.html#ae6f35022f9384e2a22ed2b96c00995b2">rpposix_memalign</a></div><div class="ttdeci">int rpposix_memalign(void **memptr, size_t alignment, size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size and alignment.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02728">rpmalloc.c:2728</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a71ab817e272e211aed203f0416a622a6"><div class="ttname"><a href="rpmalloc_8c.html#a71ab817e272e211aed203f0416a622a6">_rpmalloc_heap_release_raw</a></div><div class="ttdeci">static void _rpmalloc_heap_release_raw(void *heapptr)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01675">rpmalloc.c:1675</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a29f83756e4d2a2bdebcfdfc8a8908081"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a29f83756e4d2a2bdebcfdfc8a8908081">rpmalloc_thread_statistics_t::global_to_thread</a></div><div class="ttdeci">size_t global_to_thread</div><div class="ttdoc">Total number of bytes transitioned from global cache to thread cache (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00093">rpmalloc.h:93</a></div></div>
<div class="ttc" id="astructspan__cache__t_html_a8cc6a9b0d6d8d6bf8367bca0101b1ae3"><div class="ttname"><a href="structspan__cache__t.html#a8cc6a9b0d6d8d6bf8367bca0101b1ae3">span_cache_t::span</a></div><div class="ttdeci">span_t * span[MAX_THREAD_SPAN_CACHE]</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00460">rpmalloc.c:460</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a645356809d937167848705edabde7d44"><div class="ttname"><a href="rpmalloc_8c.html#a645356809d937167848705edabde7d44">SPAN_HEADER_SIZE</a></div><div class="ttdeci">#define SPAN_HEADER_SIZE</div><div class="ttdoc">Size of a span header (must be a multiple of SMALL_GRANULARITY and a power of two)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00306">rpmalloc.c:306</a></div></div>
<div class="ttc" id="astructspan__t_html_a97df83853dc6ddf7e0114691b15edb49"><div class="ttname"><a href="structspan__t.html#a97df83853dc6ddf7e0114691b15edb49">span_t::block_size</a></div><div class="ttdeci">uint32_t block_size</div><div class="ttdoc">Size of a block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00436">rpmalloc.c:436</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac0d9f7ba6a7fbb2c64e323a0f55c66d7"><div class="ttname"><a href="rpmalloc_8c.html#ac0d9f7ba6a7fbb2c64e323a0f55c66d7">_rpmalloc_global_cache_extract_spans</a></div><div class="ttdeci">static size_t _rpmalloc_global_cache_extract_spans(span_t **span, size_t span_count, size_t count)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01235">rpmalloc.c:1235</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a95d666267d99d22454086d5fa0390bff"><div class="ttname"><a href="rpmalloc_8c.html#a95d666267d99d22454086d5fa0390bff">INVALID_POINTER</a></div><div class="ttdeci">#define INVALID_POINTER</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00328">rpmalloc.c:328</a></div></div>
<div class="ttc" id="astructspan__t_html_a386f776cc556d33534161ece5083e4de"><div class="ttname"><a href="structspan__t.html#a386f776cc556d33534161ece5083e4de">span_t::prev</a></div><div class="ttdeci">span_t * prev</div><div class="ttdoc">Previous span.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00454">rpmalloc.c:454</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a98c82279e204e31a5dc89b64d2c6c27c"><div class="ttname"><a href="rpmalloc_8c.html#a98c82279e204e31a5dc89b64d2c6c27c">SPAN_FLAG_MASTER</a></div><div class="ttdeci">#define SPAN_FLAG_MASTER</div><div class="ttdoc">Flag indicating span is the first (master) span of a split superspan.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00353">rpmalloc.c:353</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_abb5fa3f3219c6ed85ac00b5d4fbd6ff3"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#abb5fa3f3219c6ed85ac00b5d4fbd6ff3">rpmalloc_thread_statistics_t::current</a></div><div class="ttdeci">size_t current</div><div class="ttdoc">Currently used number of spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00097">rpmalloc.h:97</a></div></div>
<div class="ttc" id="astructheap__t_html_a13ccab5430ace95c471aacf1fab0fcd6"><div class="ttname"><a href="structheap__t.html#a13ccab5430ace95c471aacf1fab0fcd6">heap_t::finalize</a></div><div class="ttdeci">int finalize</div><div class="ttdoc">Finalization state flag.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00512">rpmalloc.c:512</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a573fc7baab7be24c6bac115b7f62192f"><div class="ttname"><a href="rpmalloc_8c.html#a573fc7baab7be24c6bac115b7f62192f">_rpmalloc_deallocate_large</a></div><div class="ttdeci">static void _rpmalloc_deallocate_large(span_t *span)</div><div class="ttdoc">Deallocate the given large memory block to the current heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02089">rpmalloc.c:2089</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa74d427b2b9955ff2d9719693d9fc80e"><div class="ttname"><a href="rpmalloc_8c.html#aa74d427b2b9955ff2d9719693d9fc80e">SIZE_CLASS_COUNT</a></div><div class="ttdeci">#define SIZE_CLASS_COUNT</div><div class="ttdoc">Total number of small + medium size classes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00298">rpmalloc.c:298</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a402952de4cb3d09cf5415ddbd7f77e6d"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a402952de4cb3d09cf5415ddbd7f77e6d">rpmalloc_thread_statistics_t::map_calls</a></div><div class="ttdeci">size_t map_calls</div><div class="ttdoc">Number of raw memory map calls (not hitting the reserve spans but resulting in actual OS mmap calls)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00113">rpmalloc.h:113</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a51b78975d481805f29847ad91c77d6ad"><div class="ttname"><a href="rpmalloc_8c.html#a51b78975d481805f29847ad91c77d6ad">MAX_THREAD_SPAN_LARGE_CACHE</a></div><div class="ttdeci">#define MAX_THREAD_SPAN_LARGE_CACHE</div><div class="ttdoc">Number of spans in thread cache for large spans (must be greater than LARGE_CLASS_COUNT / 2)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00312">rpmalloc.c:312</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aebbd8639c3b627f526bd557e065f1c00"><div class="ttname"><a href="rpmalloc_8c.html#aebbd8639c3b627f526bd557e065f1c00">MAX_THREAD_SPAN_CACHE</a></div><div class="ttdeci">#define MAX_THREAD_SPAN_CACHE</div><div class="ttdoc">Number of spans in thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00308">rpmalloc.c:308</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6cc5147be3d12c47a533a9cd14e36801"><div class="ttname"><a href="rpmalloc_8c.html#a6cc5147be3d12c47a533a9cd14e36801">_rpmalloc_deallocate_defer_small_or_medium</a></div><div class="ttdeci">static void _rpmalloc_deallocate_defer_small_or_medium(span_t *span, void *block)</div><div class="ttdoc">Put the block in the deferred free list of the owning span.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02046">rpmalloc.c:2046</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2a1e3b11c0a8fc714d6def51250c6906"><div class="ttname"><a href="rpmalloc_8c.html#a2a1e3b11c0a8fc714d6def51250c6906">_rpmalloc_heap_finalize</a></div><div class="ttdeci">static void _rpmalloc_heap_finalize(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01680">rpmalloc.c:1680</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html"><div class="ttname"><a href="structrpmalloc__config__t.html">rpmalloc_config_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00136">rpmalloc.h:136</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a083ecd4af0f476009595e8ee78cf2ac0"><div class="ttname"><a href="rpmalloc_8c.html#a083ecd4af0f476009595e8ee78cf2ac0">atomic_load64</a></div><div class="ttdeci">static FORCEINLINE int64_t atomic_load64(atomic64_t *val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00231">rpmalloc.c:231</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_ab96c2c19f00e9acab6ef7651498965ed"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#ab96c2c19f00e9acab6ef7651498965ed">rpmalloc_thread_statistics_t::spans_from_reserved</a></div><div class="ttdeci">size_t spans_from_reserved</div><div class="ttdoc">Number of spans transitioned from reserved state.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00130">rpmalloc.h:130</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a91e8ecc3f466b065c5d14e8506b47e3f"><div class="ttname"><a href="rpmalloc_8c.html#a91e8ecc3f466b065c5d14e8506b47e3f">rpaligned_realloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpaligned_realloc(void *ptr, size_t alignment, size_t size, size_t oldsize, unsigned int flags)</div><div class="ttdoc">Reallocate the given block to at least the given size and alignment,.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02678">rpmalloc.c:2678</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a66893939b9053e9bf8a97a5f50bc773a"><div class="ttname"><a href="rpmalloc_8c.html#a66893939b9053e9bf8a97a5f50bc773a">SMALL_GRANULARITY_SHIFT</a></div><div class="ttdeci">#define SMALL_GRANULARITY_SHIFT</div><div class="ttdoc">Small granularity shift count.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00286">rpmalloc.c:286</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_abfbbb8e2f9b086d466fe2898a283c98d"><div class="ttname"><a href="rpmalloc_8c.html#abfbbb8e2f9b086d466fe2898a283c98d">_rpmalloc_unmap</a></div><div class="ttdeci">static void _rpmalloc_unmap(void *address, size_t size, size_t offset, size_t release)</div><div class="ttdoc">Unmap virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00757">rpmalloc.c:757</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a223c890fd871bff9081258f6520fc8a9"><div class="ttname"><a href="rpmalloc_8c.html#a223c890fd871bff9081258f6520fc8a9">_rpmalloc_adjust_size_class</a></div><div class="ttdeci">static void _rpmalloc_adjust_size_class(size_t iclass)</div><div class="ttdoc">Adjust and optimize the size class properties for the given class.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02314">rpmalloc.c:2314</a></div></div>
<div class="ttc" id="astructspan__t_html_a345270ce5d1e5e112b45cfde43f37da0"><div class="ttname"><a href="structspan__t.html#a345270ce5d1e5e112b45cfde43f37da0">span_t::heap</a></div><div class="ttdeci">heap_t * heap</div><div class="ttdoc">Owning heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00450">rpmalloc.c:450</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_adcf8dfc992b8b4a4e6cd72e213bf1035"><div class="ttname"><a href="structrpmalloc__config__t.html#adcf8dfc992b8b4a4e6cd72e213bf1035">rpmalloc_config_t::page_size</a></div><div class="ttdeci">size_t page_size</div><div class="ttdoc">Size of memory pages. The page size MUST be a power of two. All memory mapping.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00159">rpmalloc.h:159</a></div></div>
<div class="ttc" id="astructheap__t_html_aa549da79e540bdd3e963e294a39f64cf"><div class="ttname"><a href="structheap__t.html#aa549da79e540bdd3e963e294a39f64cf">heap_t::span_reserve</a></div><div class="ttdeci">span_t * span_reserve</div><div class="ttdoc">Mapped but unused spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00496">rpmalloc.c:496</a></div></div>
<div class="ttc" id="astructsize__class__t_html_a007fc7dd52ba1f95d9a6ce88f47a614b"><div class="ttname"><a href="structsize__class__t.html#a007fc7dd52ba1f95d9a6ce88f47a614b">size_class_t::block_size</a></div><div class="ttdeci">uint32_t block_size</div><div class="ttdoc">Size of blocks in this class.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00543">rpmalloc.c:543</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_ae1b16b8970cd1354befab4f0e4b993ac"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#ae1b16b8970cd1354befab4f0e4b993ac">rpmalloc_thread_statistics_t::sizecache</a></div><div class="ttdeci">size_t sizecache</div><div class="ttdoc">Current number of bytes available in thread size class caches for small and medium sizes (&lt;32KiB)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00087">rpmalloc.h:87</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a61e3c97b4484c79f1edd1757dc3d0e46"><div class="ttname"><a href="rpmalloc_8c.html#a61e3c97b4484c79f1edd1757dc3d0e46">_rpmalloc_deallocate_huge</a></div><div class="ttdeci">static void _rpmalloc_deallocate_huge(span_t *)</div><div class="ttdoc">Heap control.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02136">rpmalloc.c:2136</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa776faada2c6d5b7edda58a3a1d701c4"><div class="ttname"><a href="rpmalloc_8c.html#aa776faada2c6d5b7edda58a3a1d701c4">_rpmalloc_span_finalize</a></div><div class="ttdeci">static int _rpmalloc_span_finalize(heap_t *heap, size_t iclass, span_t *span, span_t **list_head)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01133">rpmalloc.c:1133</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0d896198d6c5673397704f9f6bdadbdf"><div class="ttname"><a href="rpmalloc_8c.html#a0d896198d6c5673397704f9f6bdadbdf">_rpmalloc_heap_unmap</a></div><div class="ttdeci">static void _rpmalloc_heap_unmap(heap_t *heap)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01325">rpmalloc.c:1325</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7f0d32d7a842d13c6a15e4ddae3814eb"><div class="ttname"><a href="rpmalloc_8c.html#a7f0d32d7a842d13c6a15e4ddae3814eb">rpmemalign</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpmemalign(size_t alignment, size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size and alignment.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02723">rpmalloc.c:2723</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a00b91d87f9efd9b1073443761130d595"><div class="ttname"><a href="rpmalloc_8c.html#a00b91d87f9efd9b1073443761130d595">_rpmalloc_allocate_huge</a></div><div class="ttdeci">static void * _rpmalloc_allocate_huge(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a huge block by mapping memory pages directly.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01852">rpmalloc.c:1852</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af2f2ee0936896aa297771a26dec63027"><div class="ttname"><a href="rpmalloc_8c.html#af2f2ee0936896aa297771a26dec63027">span_list_t</a></div><div class="ttdeci">struct span_list_t span_list_t</div><div class="ttdoc">Span list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00344">rpmalloc.c:344</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2071bf7ebae50eced1f16b359f9d5c7d"><div class="ttname"><a href="rpmalloc_8c.html#a2071bf7ebae50eced1f16b359f9d5c7d">atomic_cas32_acquire</a></div><div class="ttdeci">static FORCEINLINE int atomic_cas32_acquire(atomic32_t *dst, int32_t val, int32_t ref)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00229">rpmalloc.c:229</a></div></div>
<div class="ttc" id="astructspan__t_html_a85527ad364915bcb39b7d421524d0bd6"><div class="ttname"><a href="structspan__t.html#a85527ad364915bcb39b7d421524d0bd6">span_t::free_list</a></div><div class="ttdeci">void * free_list</div><div class="ttdoc">Free list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00422">rpmalloc.c:422</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4f0dc3c548801773a4da1c96f39b04c9"><div class="ttname"><a href="rpmalloc_8c.html#a4f0dc3c548801773a4da1c96f39b04c9">atomic_decr32</a></div><div class="ttdeci">static FORCEINLINE int32_t atomic_decr32(atomic32_t *val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00227">rpmalloc.c:227</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a33cddb08b9ee0f969cc82dbf9cddb947"><div class="ttname"><a href="rpmalloc_8c.html#a33cddb08b9ee0f969cc82dbf9cddb947">_memory_size_class</a></div><div class="ttdeci">static size_class_t _memory_size_class[SIZE_CLASS_COUNT]</div><div class="ttdoc">Global size classes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00605">rpmalloc.c:605</a></div></div>
<div class="ttc" id="astructheap__t_html_ac4c9ca5afe45b09eb1ed79a98d308316"><div class="ttname"><a href="structheap__t.html#ac4c9ca5afe45b09eb1ed79a98d308316">heap_t::align_offset</a></div><div class="ttdeci">size_t align_offset</div><div class="ttdoc">Memory pages alignment offset.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00508">rpmalloc.c:508</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a554df4bc024ffaa8328e6ef37cec5c77"><div class="ttname"><a href="rpmalloc_8c.html#a554df4bc024ffaa8328e6ef37cec5c77">MEDIUM_CLASS_COUNT</a></div><div class="ttdeci">#define MEDIUM_CLASS_COUNT</div><div class="ttdoc">Number of medium block size classes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00296">rpmalloc.c:296</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9891bc299af5a3533139ca76ce76cd70"><div class="ttname"><a href="rpmalloc_8c.html#a9891bc299af5a3533139ca76ce76cd70">_rpmalloc_allocate_large</a></div><div class="ttdeci">static void * _rpmalloc_allocate_large(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a large sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01822">rpmalloc.c:1822</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad3b62974f1bafcc293cde80eb05a7abe"><div class="ttname"><a href="rpmalloc_8c.html#ad3b62974f1bafcc293cde80eb05a7abe">_rpmalloc_global_cache_finalize</a></div><div class="ttdeci">static void _rpmalloc_global_cache_finalize(global_cache_t *cache)</div><div class="ttdoc">Global cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01183">rpmalloc.c:1183</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a284460248778c94b6ee9ea1529299439"><div class="ttname"><a href="rpmalloc_8c.html#a284460248778c94b6ee9ea1529299439">SIZE_CLASS_HUGE</a></div><div class="ttdeci">#define SIZE_CLASS_HUGE</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00331">rpmalloc.c:331</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a693c463bae081b54b0b799e97bf84fb5"><div class="ttname"><a href="rpmalloc_8c.html#a693c463bae081b54b0b799e97bf84fb5">_rpmalloc_unmap_os</a></div><div class="ttdeci">static void _rpmalloc_unmap_os(void *address, size_t size, size_t offset, size_t release)</div><div class="ttdoc">Default implementation to unmap pages from virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00816">rpmalloc.c:816</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_afef7a20458b75404cdbba364a751694a"><div class="ttname"><a href="rpmalloc_8c.html#afef7a20458b75404cdbba364a751694a">SMALL_CLASS_COUNT</a></div><div class="ttdeci">#define SMALL_CLASS_COUNT</div><div class="ttdoc">Number of small block size classes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00288">rpmalloc.c:288</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_acb3289e60a1c405dbb154dce3f3d6c7a"><div class="ttname"><a href="rpmalloc_8c.html#acb3289e60a1c405dbb154dce3f3d6c7a">rpmalloc_thread_statistics</a></div><div class="ttdeci">void rpmalloc_thread_statistics(rpmalloc_thread_statistics_t *stats)</div><div class="ttdoc">Get per-thread statistics.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02746">rpmalloc.c:2746</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_a5db28c5567049de1e58833c061841f7e"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#a5db28c5567049de1e58833c061841f7e">rpmalloc_global_statistics_t::huge_alloc</a></div><div class="ttdeci">size_t huge_alloc</div><div class="ttdoc">Current amount of memory allocated in huge allocations, i.e larger than LARGE_SIZE_LIMIT which is 2Mi...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00076">rpmalloc.h:76</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab1224666923d459edcb9bc5a7399a419"><div class="ttname"><a href="rpmalloc_8c.html#ab1224666923d459edcb9bc5a7399a419">_rpmalloc_span_map_from_reserve</a></div><div class="ttdeci">static span_t * _rpmalloc_span_map_from_reserve(heap_t *heap, size_t span_count)</div><div class="ttdoc">Use reserved spans to fulfill a memory map request (reserve size must be checked by caller)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00926">rpmalloc.c:926</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_afa1244471261835d7a8a2fa23464834b"><div class="ttname"><a href="rpmalloc_8c.html#afa1244471261835d7a8a2fa23464834b">rpaligned_calloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpaligned_calloc(size_t alignment, size_t num, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02697">rpmalloc.c:2697</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4cdf64413eaa3e80f8a1dfe158bd2525"><div class="ttname"><a href="rpmalloc_8c.html#a4cdf64413eaa3e80f8a1dfe158bd2525">_memory_huge_pages</a></div><div class="ttdeci">static int _memory_huge_pages</div><div class="ttdoc">Huge page support.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00611">rpmalloc.c:611</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9d7ec974d864302bb4f8516859c4b212"><div class="ttname"><a href="rpmalloc_8c.html#a9d7ec974d864302bb4f8516859c4b212">_memory_page_size_shift</a></div><div class="ttdeci">static size_t _memory_page_size_shift</div><div class="ttdoc">Shift to divide by page size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00582">rpmalloc.c:582</a></div></div>
<div class="ttc" id="astructheap__t_html_a2342224142317f85fca91614fc973131"><div class="ttname"><a href="structheap__t.html#a2342224142317f85fca91614fc973131">heap_t::id</a></div><div class="ttdeci">int32_t id</div><div class="ttdoc">Heap ID.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00510">rpmalloc.c:510</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_af75f9eeddb63a098824a555506334c8a"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#af75f9eeddb63a098824a555506334c8a">rpmalloc_thread_statistics_t::spancache</a></div><div class="ttdeci">size_t spancache</div><div class="ttdoc">Current number of bytes available in thread span caches for small and medium sizes (&lt;32KiB)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00089">rpmalloc.h:89</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a759e72612fab78b1159ab7129a7f7e86"><div class="ttname"><a href="rpmalloc_8c.html#a759e72612fab78b1159ab7129a7f7e86">rpmalloc_dump_statistics</a></div><div class="ttdeci">void rpmalloc_dump_statistics(void *file)</div><div class="ttdoc">Dump all statistics in human readable format to file (should be a FILE*)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02881">rpmalloc.c:2881</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab6bd4a5eb2a9f92ae4b0042a31d215ed"><div class="ttname"><a href="rpmalloc_8c.html#ab6bd4a5eb2a9f92ae4b0042a31d215ed">_rpmalloc_span_initialize_new</a></div><div class="ttdeci">static void * _rpmalloc_span_initialize_new(heap_t *heap, span_t *span, uint32_t class_idx)</div><div class="ttdoc">Initialize an unused span (from cache or mapped) to be new active span, putting the initial free list...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01084">rpmalloc.c:1084</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a9cfb1a2f571e8ebe68185b387f04260b"><div class="ttname"><a href="structrpmalloc__config__t.html#a9cfb1a2f571e8ebe68185b387f04260b">rpmalloc_config_t::enable_huge_pages</a></div><div class="ttdeci">int enable_huge_pages</div><div class="ttdoc">Enable use of large/huge pages. If this flag is set to non-zero and page size is.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00177">rpmalloc.h:177</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad5eb163989618d4ea0eff254cdbdd596"><div class="ttname"><a href="rpmalloc_8c.html#ad5eb163989618d4ea0eff254cdbdd596">_rpmalloc_span_initialize</a></div><div class="ttdeci">static void _rpmalloc_span_initialize(span_t *span, size_t total_span_count, size_t span_count, size_t align_offset)</div><div class="ttdoc">Setup a newly mapped span.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00950">rpmalloc.c:950</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae261e72f93968b03a76ada7a6b150965"><div class="ttname"><a href="rpmalloc_8c.html#ae261e72f93968b03a76ada7a6b150965">atomic_store_ptr</a></div><div class="ttdeci">static FORCEINLINE void atomic_store_ptr(atomicptr_t *dst, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00234">rpmalloc.c:234</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7fdcd37f930a06ca527ab10334bf1d1e"><div class="ttname"><a href="rpmalloc_8c.html#a7fdcd37f930a06ca527ab10334bf1d1e">_rpmalloc_deallocate_small_or_medium</a></div><div class="ttdeci">static void _rpmalloc_deallocate_small_or_medium(span_t *span, void *p)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02067">rpmalloc.c:2067</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_abc7ef0e7b7520db5b2e7c1867d364c0b"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#abc7ef0e7b7520db5b2e7c1867d364c0b">rpmalloc_thread_statistics_t::alloc_peak</a></div><div class="ttdeci">size_t alloc_peak</div><div class="ttdoc">Peak number of allocations.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00120">rpmalloc.h:120</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a5bd98ea2cfee2186b2aa2b921450807f"><div class="ttname"><a href="rpmalloc_8c.html#a5bd98ea2cfee2186b2aa2b921450807f">_rpmalloc_heap_orphan</a></div><div class="ttdeci">static void _rpmalloc_heap_orphan(heap_t *heap, int first_class)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01561">rpmalloc.c:1561</a></div></div>
<div class="ttc" id="astructheap__size__class__t_html"><div class="ttname"><a href="structheap__size__class__t.html">heap_size_class_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00470">rpmalloc.c:470</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa3b1a6473db3c198691da8c7b8918f7a"><div class="ttname"><a href="rpmalloc_8c.html#aa3b1a6473db3c198691da8c7b8918f7a">_rpmalloc_mmap_os</a></div><div class="ttdeci">static void * _rpmalloc_mmap_os(size_t size, size_t *offset)</div><div class="ttdoc">Default implementation to map new pages to virtual memory.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00770">rpmalloc.c:770</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3f784cd2178650b1990ea81980646a3b"><div class="ttname"><a href="rpmalloc_8c.html#a3f784cd2178650b1990ea81980646a3b">_memory_span_mask</a></div><div class="ttdeci">#define _memory_span_mask</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00596">rpmalloc.c:596</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af696dfc58704b5b75dc6b0a02c6fed66"><div class="ttname"><a href="rpmalloc_8c.html#af696dfc58704b5b75dc6b0a02c6fed66">rpaligned_alloc</a></div><div class="ttdeci">RPMALLOC_ALLOCATOR void * rpaligned_alloc(size_t alignment, size_t size)</div><div class="ttdoc">Allocate a memory block of at least the given size and alignment.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02691">rpmalloc.c:2691</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a19186eb24d08ef02b924951abb865b51"><div class="ttname"><a href="rpmalloc_8c.html#a19186eb24d08ef02b924951abb865b51">rpfree</a></div><div class="ttdeci">void rpfree(void *ptr)</div><div class="ttdoc">Free the given memory block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02634">rpmalloc.c:2634</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_a308868b1a8740da06b79c1bdabae1997"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#a308868b1a8740da06b79c1bdabae1997">rpmalloc_global_statistics_t::huge_alloc_peak</a></div><div class="ttdeci">size_t huge_alloc_peak</div><div class="ttdoc">Peak amount of memory allocated in huge allocations, i.e larger than LARGE_SIZE_LIMIT which is 2MiB b...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00078">rpmalloc.h:78</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_afed57ac88686e15e2d9cee4743e31857"><div class="ttname"><a href="rpmalloc_8c.html#afed57ac88686e15e2d9cee4743e31857">rpmalloc_config</a></div><div class="ttdeci">const rpmalloc_config_t * rpmalloc_config(void)</div><div class="ttdoc">Get allocator configuration.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02615">rpmalloc.c:2615</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a9641beb0030ad56b2df025775823b2af"><div class="ttname"><a href="rpmalloc_8c.html#a9641beb0030ad56b2df025775823b2af">_memory_medium_size_limit</a></div><div class="ttdeci">static size_t _memory_medium_size_limit</div><div class="ttdoc">Run-time size limit of medium blocks.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00607">rpmalloc.c:607</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4a224c6ef987eb60f3e3be98239109ec"><div class="ttname"><a href="rpmalloc_8c.html#a4a224c6ef987eb60f3e3be98239109ec">set_thread_heap</a></div><div class="ttdeci">static void set_thread_heap(heap_t *heap)</div><div class="ttdoc">Set the current thread heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00722">rpmalloc.c:722</a></div></div>
<div class="ttc" id="astructheap__size__class__t_html_a72cb3beffa763418cb7c8e89ff257b8e"><div class="ttname"><a href="structheap__size__class__t.html#a72cb3beffa763418cb7c8e89ff257b8e">heap_size_class_t::cache</a></div><div class="ttdeci">span_t * cache</div><div class="ttdoc">Early level cache of fully free spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00477">rpmalloc.c:477</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a7893d4d677b2ba355c45e4ec8b96b241"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a7893d4d677b2ba355c45e4ec8b96b241">rpmalloc_thread_statistics_t::spans_from_cache</a></div><div class="ttdeci">size_t spans_from_cache</div><div class="ttdoc">Number of spans transitioned from cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00128">rpmalloc.h:128</a></div></div>
<div class="ttc" id="astructspan__t_html_a13753de75bc52a5b8a1a9532083c9ba4"><div class="ttname"><a href="structspan__t.html#a13753de75bc52a5b8a1a9532083c9ba4">span_t::align_offset</a></div><div class="ttdeci">uint32_t align_offset</div><div class="ttdoc">Alignment offset.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00448">rpmalloc.c:448</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a94d4ba8d2181723f35b45da39c91d8ab"><div class="ttname"><a href="rpmalloc_8c.html#a94d4ba8d2181723f35b45da39c91d8ab">atomic_store_ptr_release</a></div><div class="ttdeci">static FORCEINLINE void atomic_store_ptr_release(atomicptr_t *dst, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00235">rpmalloc.c:235</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af2ca2fcf7e544c9458ef49057a40b78e"><div class="ttname"><a href="rpmalloc_8c.html#af2ca2fcf7e544c9458ef49057a40b78e">_rpmalloc_span_extract_free_list_deferred</a></div><div class="ttdeci">static void _rpmalloc_span_extract_free_list_deferred(span_t *span)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01115">rpmalloc.c:1115</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a69503d4619673c88e0882f291eb6d86f"><div class="ttname"><a href="rpmalloc_8c.html#a69503d4619673c88e0882f291eb6d86f">ENABLE_THREAD_CACHE</a></div><div class="ttdeci">#define ENABLE_THREAD_CACHE</div><div class="ttdoc">Enable per-thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00034">rpmalloc.c:34</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af1cf3243cc57cc5033ae07b71984abcf"><div class="ttname"><a href="rpmalloc_8c.html#af1cf3243cc57cc5033ae07b71984abcf">_rpmalloc_heap_reserved_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_reserved_extract(heap_t *heap, size_t span_count)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01462">rpmalloc.c:1462</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6866e2b7c1e8f60d6c74ea8fba6be44d"><div class="ttname"><a href="rpmalloc_8c.html#a6866e2b7c1e8f60d6c74ea8fba6be44d">LARGE_SIZE_LIMIT</a></div><div class="ttdeci">#define LARGE_SIZE_LIMIT</div><div class="ttdoc">Maximum size of a large block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00304">rpmalloc.c:304</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a724fb9f82013c782db5c3c12ea36aac8"><div class="ttname"><a href="rpmalloc_8c.html#a724fb9f82013c782db5c3c12ea36aac8">FORCEINLINE</a></div><div class="ttdeci">#define FORCEINLINE</div><div class="ttdoc">Platform and arch specifics.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00116">rpmalloc.c:116</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae3a524405e2a853229e95546df284be2"><div class="ttname"><a href="rpmalloc_8c.html#ae3a524405e2a853229e95546df284be2">_memory_orphan_heaps</a></div><div class="ttdeci">static heap_t * _memory_orphan_heaps</div><div class="ttdoc">Orphaned heaps.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00621">rpmalloc.c:621</a></div></div>
<div class="ttc" id="astructsize__class__t_html_a7524fc81b83a0b54ef5ec3fb4563b69d"><div class="ttname"><a href="structsize__class__t.html#a7524fc81b83a0b54ef5ec3fb4563b69d">size_class_t::class_idx</a></div><div class="ttdeci">uint16_t class_idx</div><div class="ttdoc">Class index this class is merged with.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00547">rpmalloc.c:547</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2a87a6060d5387fe8491a00600073687"><div class="ttname"><a href="rpmalloc_8c.html#a2a87a6060d5387fe8491a00600073687">atomic_store32_release</a></div><div class="ttdeci">static FORCEINLINE void atomic_store32_release(atomic32_t *dst, int32_t val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00230">rpmalloc.c:230</a></div></div>
<div class="ttc" id="astructheap__size__class__t_html_af829c49d9fc4d933c14113ba0d694e7c"><div class="ttname"><a href="structheap__size__class__t.html#af829c49d9fc4d933c14113ba0d694e7c">heap_size_class_t::partial_span</a></div><div class="ttdeci">span_t * partial_span</div><div class="ttdoc">Double linked list of partially used spans with free blocks.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00475">rpmalloc.c:475</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a24ad9380461f94f601227da3fe3676da"><div class="ttname"><a href="rpmalloc_8c.html#a24ad9380461f94f601227da3fe3676da">THREAD_SPAN_CACHE_TRANSFER</a></div><div class="ttdeci">#define THREAD_SPAN_CACHE_TRANSFER</div><div class="ttdoc">Number of spans to transfer between thread and global cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00310">rpmalloc.c:310</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af7213260e19fbad385988302247150d4"><div class="ttname"><a href="rpmalloc_8c.html#af7213260e19fbad385988302247150d4">get_thread_heap_raw</a></div><div class="ttdeci">static heap_t * get_thread_heap_raw(void)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00672">rpmalloc.c:672</a></div></div>
<div class="ttc" id="astructspan__t_html_af32dc4254a995d8ba3ab99376c9ad4d0"><div class="ttname"><a href="structspan__t.html#af32dc4254a995d8ba3ab99376c9ad4d0">span_t::total_spans</a></div><div class="ttdeci">uint32_t total_spans</div><div class="ttdoc">Total span counter for master spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00442">rpmalloc.c:442</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1b31ff8fa0abcdb205dadd8afc026014"><div class="ttname"><a href="rpmalloc_8c.html#a1b31ff8fa0abcdb205dadd8afc026014">_rpmalloc_span_unmap</a></div><div class="ttdeci">static void _rpmalloc_span_unmap(span_t *span)</div><div class="ttdoc">Unmap memory pages for the given number of spans (or mark as unused if no partial unmappings)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00995">rpmalloc.c:995</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1c835ad1c58fa13f9cfb055a0372c40a"><div class="ttname"><a href="rpmalloc_8c.html#a1c835ad1c58fa13f9cfb055a0372c40a">_memory_orphan_lock</a></div><div class="ttdeci">static atomic32_t _memory_orphan_lock</div><div class="ttdoc">Orphan lock.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00619">rpmalloc.c:619</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1138b9406eb249def65f0f30a4820553"><div class="ttname"><a href="rpmalloc_8c.html#a1138b9406eb249def65f0f30a4820553">rpmalloc_thread_finalize</a></div><div class="ttdeci">void rpmalloc_thread_finalize(void)</div><div class="ttdoc">Finalize thread, orphan heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02599">rpmalloc.c:2599</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aff58cf54f7ebc5d3d71a2ad80a0dab94"><div class="ttname"><a href="rpmalloc_8c.html#aff58cf54f7ebc5d3d71a2ad80a0dab94">rpmalloc_finalize</a></div><div class="ttdeci">void rpmalloc_finalize(void)</div><div class="ttdoc">Finalize the allocator.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02544">rpmalloc.c:2544</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a06d0861a56c7d5aac6e215ab0dceb9ca"><div class="ttname"><a href="rpmalloc_8c.html#a06d0861a56c7d5aac6e215ab0dceb9ca">_rpmalloc_global_cache_insert_spans</a></div><div class="ttdeci">static void _rpmalloc_global_cache_insert_spans(span_t **span, size_t span_count, size_t count)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01203">rpmalloc.c:1203</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html">rpmalloc_global_statistics_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00068">rpmalloc.h:68</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa1ee77cdccf0341222f64395d0be2626"><div class="ttname"><a href="rpmalloc_8c.html#aa1ee77cdccf0341222f64395d0be2626">atomic_store32</a></div><div class="ttdeci">static FORCEINLINE void atomic_store32(atomic32_t *dst, int32_t val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00225">rpmalloc.c:225</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae82498bcdc6e7af0bc9adc0e75c60cee"><div class="ttname"><a href="rpmalloc_8c.html#ae82498bcdc6e7af0bc9adc0e75c60cee">_rpmalloc_span_map_aligned_count</a></div><div class="ttdeci">static span_t * _rpmalloc_span_map_aligned_count(heap_t *heap, size_t span_count)</div><div class="ttdoc">Map an aligned set of spans, taking configured mapping granularity and the page size into account.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00960">rpmalloc.c:960</a></div></div>
<div class="ttc" id="astructglobal__cache__t_html_a9c0563645d0d1fd53044a9c00dad6dc0"><div class="ttname"><a href="structglobal__cache__t.html#a9c0563645d0d1fd53044a9c00dad6dc0">global_cache_t::lock</a></div><div class="ttdeci">atomic32_t lock</div><div class="ttdoc">Cache lock.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00553">rpmalloc.c:553</a></div></div>
<div class="ttc" id="astructspan__t_html_a7ee7892ce3c5d8342af193f1824a5098"><div class="ttname"><a href="structspan__t.html#a7ee7892ce3c5d8342af193f1824a5098">span_t::block_count</a></div><div class="ttdeci">uint32_t block_count</div><div class="ttdoc">Total block count of size class.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00424">rpmalloc.c:424</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af327588f7260778f453d9a212396e0e0"><div class="ttname"><a href="rpmalloc_8c.html#af327588f7260778f453d9a212396e0e0">atomic_add32</a></div><div class="ttdeci">static FORCEINLINE int32_t atomic_add32(atomic32_t *val, int32_t add)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00228">rpmalloc.c:228</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad9fade5754c34dc5e3ee99c1e432ccb7"><div class="ttname"><a href="rpmalloc_8c.html#ad9fade5754c34dc5e3ee99c1e432ccb7">_rpmalloc_heap_global_cache_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_global_cache_extract(heap_t *heap, size_t span_count)</div><div class="ttdoc">Extract a span from the global cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01470">rpmalloc.c:1470</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_af1916b4138cfc1e46ff0787ff9206375"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#af1916b4138cfc1e46ff0787ff9206375">rpmalloc_global_statistics_t::mapped_total</a></div><div class="ttdeci">size_t mapped_total</div><div class="ttdoc">Total amount of memory mapped since initialization (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00080">rpmalloc.h:80</a></div></div>
<div class="ttc" id="astructheap__t_html_ae112aace519bbe14edb9127cefb59705"><div class="ttname"><a href="structheap__t.html#ae112aace519bbe14edb9127cefb59705">heap_t::span_cache</a></div><div class="ttdeci">span_cache_t span_cache</div><div class="ttdoc">Arrays of fully freed spans, single span.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00489">rpmalloc.c:489</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a80aeb0b9294d1463006c963e7073244e"><div class="ttname"><a href="rpmalloc_8c.html#a80aeb0b9294d1463006c963e7073244e">_rpmalloc_span_map</a></div><div class="ttdeci">static span_t * _rpmalloc_span_map(heap_t *heap, size_t span_count)</div><div class="ttdoc">Map in memory pages for the given number of spans (or use previously reserved pages)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00987">rpmalloc.c:987</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4be7846b7aabc5b469a4cc66dbc6fb36"><div class="ttname"><a href="rpmalloc_8c.html#a4be7846b7aabc5b469a4cc66dbc6fb36">_rpmalloc_aligned_allocate</a></div><div class="ttdeci">static void * _rpmalloc_aligned_allocate(heap_t *heap, size_t alignment, size_t size)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01891">rpmalloc.c:1891</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a4ca7faed398dff40d231cbce5ebcc845"><div class="ttname"><a href="rpmalloc_8c.html#a4ca7faed398dff40d231cbce5ebcc845">_rpmalloc_heap_allocate</a></div><div class="ttdeci">static heap_t * _rpmalloc_heap_allocate(int first_class)</div><div class="ttdoc">Allocate a new heap, potentially reusing a previously orphaned heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01611">rpmalloc.c:1611</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_affda05352198b9ef86d42be851a1349f"><div class="ttname"><a href="rpmalloc_8h.html#affda05352198b9ef86d42be851a1349f">RPMALLOC_NO_PRESERVE</a></div><div class="ttdeci">#define RPMALLOC_NO_PRESERVE</div><div class="ttdoc">Flag to rpaligned_realloc to not preserve content in reallocation.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00062">rpmalloc.h:62</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a14828817b96941a8a2ad71e2bb95143b"><div class="ttname"><a href="rpmalloc_8c.html#a14828817b96941a8a2ad71e2bb95143b">MAP_UNINITIALIZED</a></div><div class="ttdeci">#define MAP_UNINITIALIZED</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00167">rpmalloc.c:167</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_addf543f30c5eefc1dded60025c78a816"><div class="ttname"><a href="rpmalloc_8c.html#addf543f30c5eefc1dded60025c78a816">free_list_partial_init</a></div><div class="ttdeci">static uint32_t free_list_partial_init(void **list, void **first_block, void *page_start, void *block_start, uint32_t block_count, uint32_t block_size)</div><div class="ttdoc">Initialize a (partial) free list up to next system memory page, while reserving the first block as al...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01053">rpmalloc.c:1053</a></div></div>
<div class="ttc" id="astructspan__t_html_ae77d9a2cdd2a2fd46e3b27739d6c88cc"><div class="ttname"><a href="structspan__t.html#ae77d9a2cdd2a2fd46e3b27739d6c88cc">span_t::span_count</a></div><div class="ttdeci">uint32_t span_count</div><div class="ttdoc">Number of spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00440">rpmalloc.c:440</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a953c50560183aabed3e8cf5bdf5bd98f"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a953c50560183aabed3e8cf5bdf5bd98f">rpmalloc_thread_statistics_t::from_cache</a></div><div class="ttdeci">size_t from_cache</div><div class="ttdoc">Number of spans transitioned from thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00107">rpmalloc.h:107</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a84cfc60f2a133ca255a762778cc024c6"><div class="ttname"><a href="structrpmalloc__config__t.html#a84cfc60f2a133ca255a762778cc024c6">rpmalloc_config_t::span_map_count</a></div><div class="ttdeci">size_t span_map_count</div><div class="ttdoc">Number of spans to map at each request to map new virtual memory blocks. This can.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00169">rpmalloc.h:169</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a7a9f597c853963de259b40e985d81113"><div class="ttname"><a href="rpmalloc_8c.html#a7a9f597c853963de259b40e985d81113">rpmalloc_usable_size</a></div><div class="ttdeci">size_t rpmalloc_usable_size(void *ptr)</div><div class="ttdoc">Query the usable size of the given memory block (from given pointer to the end of block)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02737">rpmalloc.c:2737</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af8bd0cd08a93d20cb117e18d85f877cd"><div class="ttname"><a href="rpmalloc_8c.html#af8bd0cd08a93d20cb117e18d85f877cd">_rpmalloc_allocate</a></div><div class="ttdeci">static void * _rpmalloc_allocate(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a block of the given size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01880">rpmalloc.c:1880</a></div></div>
<div class="ttc" id="astructheap__t_html_a354c0beb35fd982bc4dbd3783b2dd1ff"><div class="ttname"><a href="structheap__t.html#a354c0beb35fd982bc4dbd3783b2dd1ff">heap_t::span_free_deferred</a></div><div class="ttdeci">atomicptr_t span_free_deferred</div><div class="ttdoc">List of deferred free spans (single linked list)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00492">rpmalloc.c:492</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0e1e1399df4fbb1246dc73f3c6d14427"><div class="ttname"><a href="rpmalloc_8c.html#a0e1e1399df4fbb1246dc73f3c6d14427">_Static_assert</a></div><div class="ttdeci">_Static_assert((SMALL_GRANULARITY &amp;(SMALL_GRANULARITY - 1))==0, &quot;Small granularity must be power of two&quot;)</div></div>
<div class="ttc" id="arpmalloc_8c_html_a2e9cc04738eb37814086f557943373d8"><div class="ttname"><a href="rpmalloc_8c.html#a2e9cc04738eb37814086f557943373d8">THREAD_SPAN_LARGE_CACHE_TRANSFER</a></div><div class="ttdeci">#define THREAD_SPAN_LARGE_CACHE_TRANSFER</div><div class="ttdoc">Number of spans to transfer between thread and global cache for large spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00314">rpmalloc.c:314</a></div></div>
<div class="ttc" id="astructspan__cache__t_html"><div class="ttname"><a href="structspan__cache__t.html">span_cache_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00458">rpmalloc.c:458</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ada0a343b3498bb882ebd7e0c3caa0935"><div class="ttname"><a href="rpmalloc_8c.html#ada0a343b3498bb882ebd7e0c3caa0935">_memory_default_span_mask</a></div><div class="ttdeci">#define _memory_default_span_mask</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00573">rpmalloc.c:573</a></div></div>
<div class="ttc" id="arpmalloc_8h_html_a85561f3ac6a729bf480cdf706d6c75dc"><div class="ttname"><a href="rpmalloc_8h.html#a85561f3ac6a729bf480cdf706d6c75dc">RPMALLOC_ALLOCATOR</a></div><div class="ttdeci">#define RPMALLOC_ALLOCATOR</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00042">rpmalloc.h:42</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a481f7733c3d6469b66e9a746e0afb0e9"><div class="ttname"><a href="rpmalloc_8c.html#a481f7733c3d6469b66e9a746e0afb0e9">atomic_add64</a></div><div class="ttdeci">static FORCEINLINE int64_t atomic_add64(atomic64_t *val, int64_t add)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00232">rpmalloc.c:232</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6780f79fe39d5c99886e27fccaf4133c"><div class="ttname"><a href="rpmalloc_8c.html#a6780f79fe39d5c99886e27fccaf4133c">_rpmalloc_span_align_count</a></div><div class="ttdeci">static size_t _rpmalloc_span_align_count(size_t span_count)</div><div class="ttdoc">Get the aligned number of spans to map in based on wanted count, configured mapping granularity and t...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00941">rpmalloc.c:941</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a391da97cc59f31607c1453ccd6951a15"><div class="ttname"><a href="rpmalloc_8c.html#a391da97cc59f31607c1453ccd6951a15">_rpmalloc_allocate_from_heap_fallback</a></div><div class="ttdeci">static void * _rpmalloc_allocate_from_heap_fallback(heap_t *heap, uint32_t class_idx)</div><div class="ttdoc">Allocate a small/medium sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01747">rpmalloc.c:1747</a></div></div>
<div class="ttc" id="astructspan__large__cache__t_html_a77eff1faca249ec6ae27881769f7d979"><div class="ttname"><a href="structspan__large__cache__t.html#a77eff1faca249ec6ae27881769f7d979">span_large_cache_t::span</a></div><div class="ttdeci">span_t * span[MAX_THREAD_SPAN_LARGE_CACHE]</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00466">rpmalloc.c:466</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_affc9a9b9fff3b494c0f0dd63884be0e4"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#affc9a9b9fff3b494c0f0dd63884be0e4">rpmalloc_thread_statistics_t::thread_to_global</a></div><div class="ttdeci">size_t thread_to_global</div><div class="ttdoc">Total number of bytes transitioned from thread cache to global cache (only if ENABLE_STATISTICS=1)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00091">rpmalloc.h:91</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_a10fb22a2f8775aafd70b1c79f6b80630"><div class="ttname"><a href="structrpmalloc__config__t.html#a10fb22a2f8775aafd70b1c79f6b80630">rpmalloc_config_t::memory_unmap</a></div><div class="ttdeci">void(* memory_unmap)(void *address, size_t size, size_t offset, size_t release)</div><div class="ttdoc">Unmap the memory pages starting at address and spanning the given number of bytes.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00155">rpmalloc.h:155</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a95449a66565995789e144cfc3f538261"><div class="ttname"><a href="rpmalloc_8c.html#a95449a66565995789e144cfc3f538261">MEDIUM_GRANULARITY_SHIFT</a></div><div class="ttdeci">#define MEDIUM_GRANULARITY_SHIFT</div><div class="ttdoc">Medium granularity shift count.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00294">rpmalloc.c:294</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a63b187e233e7b190db2bac536cf8a09b"><div class="ttname"><a href="rpmalloc_8c.html#a63b187e233e7b190db2bac536cf8a09b">_rpmalloc_allocate_medium</a></div><div class="ttdeci">static void * _rpmalloc_allocate_medium(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a medium sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01809">rpmalloc.c:1809</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aecf578949f89fb109c5f6f527a2dc49d"><div class="ttname"><a href="rpmalloc_8c.html#aecf578949f89fb109c5f6f527a2dc49d">SMALL_SIZE_LIMIT</a></div><div class="ttdeci">#define SMALL_SIZE_LIMIT</div><div class="ttdoc">Maximum size of a small block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00290">rpmalloc.c:290</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a0789af6dab1aa1a24b9c9d326ab84373"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a0789af6dab1aa1a24b9c9d326ab84373">rpmalloc_thread_statistics_t::from_reserved</a></div><div class="ttdeci">size_t from_reserved</div><div class="ttdoc">Number of spans transitioned from reserved state.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00111">rpmalloc.h:111</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae4a00ccf859d64a7519ae121563a56e7"><div class="ttname"><a href="rpmalloc_8c.html#ae4a00ccf859d64a7519ae121563a56e7">_rpmalloc_heap_set_reserved_spans</a></div><div class="ttdeci">static void _rpmalloc_heap_set_reserved_spans(heap_t *heap, span_t *master, span_t *reserve, size_t reserve_span_count)</div><div class="ttdoc">Store the given spans as reserve in the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01271">rpmalloc.c:1271</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a5c46183a2d82b761e9438c65b0dbad62"><div class="ttname"><a href="rpmalloc_8c.html#a5c46183a2d82b761e9438c65b0dbad62">_rpmalloc_reallocate</a></div><div class="ttdeci">static void * _rpmalloc_reallocate(heap_t *heap, void *p, size_t size, size_t oldsize, unsigned int flags)</div><div class="ttdoc">Reallocate the given block to the given size.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02186">rpmalloc.c:2186</a></div></div>
<div class="ttc" id="astructheap__t_html_a436e67271364d132c12f2f5f0d4c79ef"><div class="ttname"><a href="structheap__t.html#a436e67271364d132c12f2f5f0d4c79ef">heap_t::owner_thread</a></div><div class="ttdeci">uintptr_t owner_thread</div><div class="ttdoc">Owning thread ID.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00484">rpmalloc.c:484</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ade7fb930b30a5a8bd04ecc97cad60e6b"><div class="ttname"><a href="rpmalloc_8c.html#ade7fb930b30a5a8bd04ecc97cad60e6b">_rpmalloc_span_is_fully_utilized</a></div><div class="ttdeci">static int _rpmalloc_span_is_fully_utilized(span_t *span)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01127">rpmalloc.c:1127</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3f84dd23eb0ef3cf54aeb6afff0618ae"><div class="ttname"><a href="rpmalloc_8c.html#a3f84dd23eb0ef3cf54aeb6afff0618ae">SIZE_CLASS_LARGE</a></div><div class="ttdeci">#define SIZE_CLASS_LARGE</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00330">rpmalloc.c:330</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a47dc214231db2729538940b8db899c79"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a47dc214231db2729538940b8db899c79">rpmalloc_thread_statistics_t::to_cache</a></div><div class="ttdeci">size_t to_cache</div><div class="ttdoc">Number of spans transitioned to thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00105">rpmalloc.h:105</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a599c57201987cc23a9787a745296e575"><div class="ttname"><a href="rpmalloc_8c.html#a599c57201987cc23a9787a745296e575">_rpmalloc_stat_add_peak</a></div><div class="ttdeci">#define _rpmalloc_stat_add_peak(counter, value, peak)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00272">rpmalloc.c:272</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2fcaea32cf5846f1f5b40a882175dbb0"><div class="ttname"><a href="rpmalloc_8c.html#a2fcaea32cf5846f1f5b40a882175dbb0">SPAN_FLAG_SUBSPAN</a></div><div class="ttdeci">#define SPAN_FLAG_SUBSPAN</div><div class="ttdoc">Flag indicating span is a secondary (sub) span of a split superspan.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00355">rpmalloc.c:355</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a09739783c3930851b45151ebfb1dde31"><div class="ttname"><a href="rpmalloc_8c.html#a09739783c3930851b45151ebfb1dde31">_memory_span_size_shift</a></div><div class="ttdeci">#define _memory_span_size_shift</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00595">rpmalloc.c:595</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a0d0546abbe1244019d00ecf28aac359c"><div class="ttname"><a href="rpmalloc_8c.html#a0d0546abbe1244019d00ecf28aac359c">_rpmalloc_aligned_reallocate</a></div><div class="ttdeci">static void * _rpmalloc_aligned_reallocate(heap_t *heap, void *ptr, size_t alignment, size_t size, size_t oldsize, unsigned int flags)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02261">rpmalloc.c:2261</a></div></div>
<div class="ttc" id="astructheap__t_html_a348c1835d21f0af4a3776f96bdba64fb"><div class="ttname"><a href="structheap__t.html#a348c1835d21f0af4a3776f96bdba64fb">heap_t::master_heap</a></div><div class="ttdeci">heap_t * master_heap</div><div class="ttdoc">Master heap owning the memory pages.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00514">rpmalloc.c:514</a></div></div>
<div class="ttc" id="astructspan__t_html_a5a977febdd2e9ae15bcf66f83d0cf817"><div class="ttname"><a href="structspan__t.html#a5a977febdd2e9ae15bcf66f83d0cf817">span_t::size_class</a></div><div class="ttdeci">uint32_t size_class</div><div class="ttdoc">Size class.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00426">rpmalloc.c:426</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af576bf8ffa22a44e53018c67095ffbf0"><div class="ttname"><a href="rpmalloc_8c.html#af576bf8ffa22a44e53018c67095ffbf0">assert</a></div><div class="ttdeci">#define assert(x)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00180">rpmalloc.c:180</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aa8eb0af2c0aa626bb527878b3401ac96"><div class="ttname"><a href="rpmalloc_8c.html#aa8eb0af2c0aa626bb527878b3401ac96">_rpmalloc_heap_release</a></div><div class="ttdeci">static void _rpmalloc_heap_release(void *heapptr, int first_class)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01628">rpmalloc.c:1628</a></div></div>
<div class="ttc" id="astructglobal__cache__t_html"><div class="ttname"><a href="structglobal__cache__t.html">global_cache_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00551">rpmalloc.c:551</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_ab0d895a6016dd1c5937f2a74370f2727"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#ab0d895a6016dd1c5937f2a74370f2727">rpmalloc_global_statistics_t::mapped</a></div><div class="ttdeci">size_t mapped</div><div class="ttdoc">Current amount of virtual memory mapped, all of which might not have been committed (only if ENABLE_S...</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00070">rpmalloc.h:70</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3e39052a111a2e243645494f1d6ca439"><div class="ttname"><a href="rpmalloc_8c.html#a3e39052a111a2e243645494f1d6ca439">_memory_heaps</a></div><div class="ttdeci">static heap_t * _memory_heaps[HEAP_ARRAY_SIZE]</div><div class="ttdoc">All heaps.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00617">rpmalloc.c:617</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ab51bbcd0d9d41ba9c6f4ad547ba77405"><div class="ttname"><a href="rpmalloc_8c.html#ab51bbcd0d9d41ba9c6f4ad547ba77405">_rpmalloc_stat_inc</a></div><div class="ttdeci">#define _rpmalloc_stat_inc(counter)</div><div class="ttdoc">Statistics related functions (evaluate to nothing when statistics not enabled)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00268">rpmalloc.c:268</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2a7ceea1aafc39d3196091847b88e701"><div class="ttname"><a href="rpmalloc_8c.html#a2a7ceea1aafc39d3196091847b88e701">_rpmalloc_allocate_small</a></div><div class="ttdeci">static void * _rpmalloc_allocate_small(heap_t *heap, size_t size)</div><div class="ttdoc">Allocate a small sized memory block from the given heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01797">rpmalloc.c:1797</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a5a90e1e7a86699bcda3c9b41568aa3c2"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a5a90e1e7a86699bcda3c9b41568aa3c2">rpmalloc_thread_statistics_t::alloc_total</a></div><div class="ttdeci">size_t alloc_total</div><div class="ttdoc">Total number of allocations.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00122">rpmalloc.h:122</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_adc5743a6b15192da5b7e023f85360208"><div class="ttname"><a href="rpmalloc_8c.html#adc5743a6b15192da5b7e023f85360208">_rpmalloc_usable_size</a></div><div class="ttdeci">static size_t _rpmalloc_usable_size(void *p)</div><div class="ttdoc">Reallocation entry points.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02294">rpmalloc.c:2294</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a472f0bf448a2dc3f31c0b79acd70d829"><div class="ttname"><a href="rpmalloc_8c.html#a472f0bf448a2dc3f31c0b79acd70d829">_Atomic</a></div><div class="ttdeci">volatile _Atomic(int32_t)</div><div class="ttdoc">Atomic access abstraction (since MSVC does not do C11 yet)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00220">rpmalloc.c:220</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1fe9c932f58e2baffed3ea33fd299691"><div class="ttname"><a href="rpmalloc_8c.html#a1fe9c932f58e2baffed3ea33fd299691">atomic_incr32</a></div><div class="ttdeci">static FORCEINLINE int32_t atomic_incr32(atomic32_t *val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00226">rpmalloc.c:226</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ac32a750ddf4072d46c28f52b9f3ee018"><div class="ttname"><a href="rpmalloc_8c.html#ac32a750ddf4072d46c28f52b9f3ee018">_rpmalloc_span_double_link_list_add</a></div><div class="ttdeci">static void _rpmalloc_span_double_link_list_add(span_t **head, span_t *span)</div><div class="ttdoc">Span linked list management.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00862">rpmalloc.c:862</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6f18b8696daac522d93e448aadd7cd4b"><div class="ttname"><a href="rpmalloc_8c.html#a6f18b8696daac522d93e448aadd7cd4b">rpmalloc_is_thread_initialized</a></div><div class="ttdeci">int rpmalloc_is_thread_initialized(void)</div><div class="ttdoc">Query if allocator is initialized for calling thread.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02610">rpmalloc.c:2610</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a3d9a7f69f3e3cc2dc7ea18d8c58b274c"><div class="ttname"><a href="rpmalloc_8c.html#a3d9a7f69f3e3cc2dc7ea18d8c58b274c">_memory_span_map_count</a></div><div class="ttdeci">static size_t _memory_span_map_count</div><div class="ttdoc">Number of spans to map in each map call.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00599">rpmalloc.c:599</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aec9c1ea6434b5703d7b6e01cfffd1261"><div class="ttname"><a href="rpmalloc_8c.html#aec9c1ea6434b5703d7b6e01cfffd1261">GLOBAL_CACHE_MULTIPLIER</a></div><div class="ttdeci">#define GLOBAL_CACHE_MULTIPLIER</div><div class="ttdoc">Multiplier for global cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00078">rpmalloc.c:78</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6c1102ef8a3812f1098cad573ea7794e"><div class="ttname"><a href="rpmalloc_8c.html#a6c1102ef8a3812f1098cad573ea7794e">_rpmalloc_deallocate_direct_small_or_medium</a></div><div class="ttdeci">static void _rpmalloc_deallocate_direct_small_or_medium(span_t *span, void *block)</div><div class="ttdoc">Deallocation entry points.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02015">rpmalloc.c:2015</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a96620ca188ca92d642ed88b803db35fc"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a96620ca188ca92d642ed88b803db35fc">rpmalloc_thread_statistics_t::to_global</a></div><div class="ttdeci">size_t to_global</div><div class="ttdoc">Number of spans transitioned to global cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00101">rpmalloc.h:101</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a6db2d5852bc3af5ee8bbbfae2db30997"><div class="ttname"><a href="rpmalloc_8c.html#a6db2d5852bc3af5ee8bbbfae2db30997">rpmalloc_thread_collect</a></div><div class="ttdeci">void rpmalloc_thread_collect(void)</div><div class="ttdoc">Perform deferred deallocations pending for the calling thread heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02742">rpmalloc.c:2742</a></div></div>
<div class="ttc" id="astructheap__t_html"><div class="ttname"><a href="structheap__t.html">heap_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00482">rpmalloc.c:482</a></div></div>
<div class="ttc" id="astructheap__size__class__t_html_ac411b0f198d4e31569fc30ca2c174f65"><div class="ttname"><a href="structheap__size__class__t.html#ac411b0f198d4e31569fc30ca2c174f65">heap_size_class_t::free_list</a></div><div class="ttdeci">void * free_list</div><div class="ttdoc">Free list of active span.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00472">rpmalloc.c:472</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af6f24a9d51e940bbad434106b1d56e20"><div class="ttname"><a href="rpmalloc_8c.html#af6f24a9d51e940bbad434106b1d56e20">atomic_exchange_ptr_acquire</a></div><div class="ttdeci">static FORCEINLINE void * atomic_exchange_ptr_acquire(atomicptr_t *dst, void *val)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00236">rpmalloc.c:236</a></div></div>
<div class="ttc" id="astructglobal__cache__t_html_a9d6636075b348ce9cbd7e59e45d097c7"><div class="ttname"><a href="structglobal__cache__t.html#a9d6636075b348ce9cbd7e59e45d097c7">global_cache_t::span</a></div><div class="ttdeci">span_t * span[GLOBAL_CACHE_MULTIPLIER *MAX_THREAD_SPAN_CACHE]</div><div class="ttdoc">Cached spans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00557">rpmalloc.c:557</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae1f1297fe3d143e41deac95ee7a7f8d4"><div class="ttname"><a href="rpmalloc_8c.html#ae1f1297fe3d143e41deac95ee7a7f8d4">_memory_config</a></div><div class="ttdeci">static rpmalloc_config_t _memory_config</div><div class="ttdoc">Configuration.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00578">rpmalloc.c:578</a></div></div>
<div class="ttc" id="astructheap__t_html_a74b47a0eacf313fe421d32379a2b942c"><div class="ttname"><a href="structheap__t.html#a74b47a0eacf313fe421d32379a2b942c">heap_t::next_heap</a></div><div class="ttdeci">heap_t * next_heap</div><div class="ttdoc">Next heap in id list.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00504">rpmalloc.c:504</a></div></div>
<div class="ttc" id="astructrpmalloc__config__t_html_ab730f9de6da78affe64497f859d6d345"><div class="ttname"><a href="structrpmalloc__config__t.html#ab730f9de6da78affe64497f859d6d345">rpmalloc_config_t::span_size</a></div><div class="ttdeci">size_t span_size</div><div class="ttdoc">Size of a span of memory blocks. MUST be a power of two, and in [4096,262144].</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00163">rpmalloc.h:163</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a1e29d8d18139babda354d5d92d46ca02"><div class="ttname"><a href="rpmalloc_8c.html#a1e29d8d18139babda354d5d92d46ca02">_memory_map_granularity</a></div><div class="ttdeci">static size_t _memory_map_granularity</div><div class="ttdoc">Granularity at which memory pages are mapped by OS.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00584">rpmalloc.c:584</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a2c70a492ba1920b405001750ab3e6622"><div class="ttname"><a href="rpmalloc_8c.html#a2c70a492ba1920b405001750ab3e6622">_rpmalloc_heap_thread_cache_extract</a></div><div class="ttdeci">static span_t * _rpmalloc_heap_thread_cache_extract(heap_t *heap, size_t span_count)</div><div class="ttdoc">Extract the given number of spans from the different cache levels.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01440">rpmalloc.c:1440</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_a6f2158d4c33a0bc6f70979b6a75e5d17"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#a6f2158d4c33a0bc6f70979b6a75e5d17">rpmalloc_thread_statistics_t::peak</a></div><div class="ttdeci">size_t peak</div><div class="ttdoc">High water mark of spans used.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00099">rpmalloc.h:99</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aab22b36fb2408434cc731fb9fe6a5cec"><div class="ttname"><a href="rpmalloc_8c.html#aab22b36fb2408434cc731fb9fe6a5cec">_rpmalloc_stat_dec</a></div><div class="ttdeci">#define _rpmalloc_stat_dec(counter)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00269">rpmalloc.c:269</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a995ec0e5a8f40e3fb178abab89dc7fd5"><div class="ttname"><a href="rpmalloc_8c.html#a995ec0e5a8f40e3fb178abab89dc7fd5">rpmalloc_initialize</a></div><div class="ttdeci">int rpmalloc_initialize(void)</div><div class="ttdoc">Initialize the allocator and setup global data.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02337">rpmalloc.c:2337</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a49e532a65b873a6c3315aa769299687c"><div class="ttname"><a href="rpmalloc_8c.html#a49e532a65b873a6c3315aa769299687c">_rpmalloc_stat_add64</a></div><div class="ttdeci">#define _rpmalloc_stat_add64(counter, value)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00271">rpmalloc.c:271</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae75d84f0a9ac27b96d18fcd652249cda"><div class="ttname"><a href="rpmalloc_8c.html#ae75d84f0a9ac27b96d18fcd652249cda">get_thread_heap</a></div><div class="ttdeci">static heap_t * get_thread_heap(void)</div><div class="ttdoc">Get the current thread heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00682">rpmalloc.c:682</a></div></div>
<div class="ttc" id="astructspan__large__cache__t_html"><div class="ttname"><a href="structspan__large__cache__t.html">span_large_cache_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00464">rpmalloc.c:464</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af42cdefbf9addf1c268ba19e63c60f29"><div class="ttname"><a href="rpmalloc_8c.html#af42cdefbf9addf1c268ba19e63c60f29">_memory_heap_id</a></div><div class="ttdeci">static atomic32_t _memory_heap_id</div><div class="ttdoc">Heap ID counter.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00609">rpmalloc.c:609</a></div></div>
<div class="ttc" id="astructrpmalloc__global__statistics__t_html_a70b10faa79aac5df497ba5eccdd554ae"><div class="ttname"><a href="structrpmalloc__global__statistics__t.html#a70b10faa79aac5df497ba5eccdd554ae">rpmalloc_global_statistics_t::cached</a></div><div class="ttdeci">size_t cached</div><div class="ttdoc">Current amount of memory in global caches for small and medium sizes (&lt;32KiB)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00074">rpmalloc.h:74</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a829d3a1ca51d0ba687990a8111940c42"><div class="ttname"><a href="rpmalloc_8c.html#a829d3a1ca51d0ba687990a8111940c42">_rpmalloc_stat_sub</a></div><div class="ttdeci">#define _rpmalloc_stat_sub(counter, value)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00273">rpmalloc.c:273</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a75c19bcef00dee4542c1ddab212e29a8"><div class="ttname"><a href="rpmalloc_8c.html#a75c19bcef00dee4542c1ddab212e29a8">heap_t</a></div><div class="ttdeci">struct heap_t heap_t</div><div class="ttdoc">Data types.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00340">rpmalloc.c:340</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a95516c8eac47786193b7172bed4a3ef7"><div class="ttname"><a href="rpmalloc_8c.html#a95516c8eac47786193b7172bed4a3ef7">_memory_span_release_count_large</a></div><div class="ttdeci">static size_t _memory_span_release_count_large</div><div class="ttdoc">Number of spans to release from thread cache to global cache (large multiple spans)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00603">rpmalloc.c:603</a></div></div>
<div class="ttc" id="astructsize__class__t_html"><div class="ttname"><a href="structsize__class__t.html">size_class_t</a></div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00541">rpmalloc.c:541</a></div></div>
<div class="ttc" id="astructheap__t_html_aea02bb1ed60acc428d5a2d2db2cd9a7b"><div class="ttname"><a href="structheap__t.html#aea02bb1ed60acc428d5a2d2db2cd9a7b">heap_t::span_large_cache</a></div><div class="ttdeci">span_large_cache_t span_large_cache[LARGE_CLASS_COUNT - 1]</div><div class="ttdoc">Arrays of fully freed spans, large spans with &gt; 1 span count.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00517">rpmalloc.c:517</a></div></div>
<div class="ttc" id="astructheap__t_html_a70f9a96b9071ccb6642894f5a7f56432"><div class="ttname"><a href="structheap__t.html#a70f9a96b9071ccb6642894f5a7f56432">heap_t::size_class</a></div><div class="ttdeci">heap_size_class_t size_class[SIZE_CLASS_COUNT]</div><div class="ttdoc">Free lists for each size class.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00486">rpmalloc.c:486</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af8803f4eab133ac4c823104577553d78"><div class="ttname"><a href="rpmalloc_8c.html#af8803f4eab133ac4c823104577553d78">DEFAULT_SPAN_MAP_COUNT</a></div><div class="ttdeci">#define DEFAULT_SPAN_MAP_COUNT</div><div class="ttdoc">Default number of spans to map in call to map more virtual memory (default values yield 4MiB here)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00074">rpmalloc.c:74</a></div></div>
<div class="ttc" id="astructspan__t_html_ac62e0e77eb38ebff4443eb5db3ccd45c"><div class="ttname"><a href="structspan__t.html#ac62e0e77eb38ebff4443eb5db3ccd45c">span_t::next</a></div><div class="ttdeci">span_t * next</div><div class="ttdoc">Next span.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00452">rpmalloc.c:452</a></div></div>
<div class="ttc" id="astructspan__t_html_a4de89d484559557bb639a2703c750b17"><div class="ttname"><a href="structspan__t.html#a4de89d484559557bb639a2703c750b17">span_t::flags</a></div><div class="ttdeci">uint32_t flags</div><div class="ttdoc">Flags and counters.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00438">rpmalloc.c:438</a></div></div>
<div class="ttc" id="astructspan__t_html_a07d2ba73260e7e5dbe98c76436888c5f"><div class="ttname"><a href="structspan__t.html#a07d2ba73260e7e5dbe98c76436888c5f">span_t::offset_from_master</a></div><div class="ttdeci">uint32_t offset_from_master</div><div class="ttdoc">Offset from master span for subspans.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00444">rpmalloc.c:444</a></div></div>
<div class="ttc" id="astructsize__class__t_html_aeded978bd21c13b71d9b0310b5bb09ec"><div class="ttname"><a href="structsize__class__t.html#aeded978bd21c13b71d9b0310b5bb09ec">size_class_t::block_count</a></div><div class="ttdeci">uint16_t block_count</div><div class="ttdoc">Number of blocks in each chunk.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00545">rpmalloc.c:545</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a62b31eca2760e37676716c54c5b64947"><div class="ttname"><a href="rpmalloc_8c.html#a62b31eca2760e37676716c54c5b64947">_rpmalloc_span_release_to_cache</a></div><div class="ttdeci">static void _rpmalloc_span_release_to_cache(heap_t *heap, span_t *span)</div><div class="ttdoc">Move the span (used for small or medium allocations) to the heap thread cache.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l01032">rpmalloc.c:1032</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_af51a6ed47e80b1b57187f1d5be6c8b4c"><div class="ttname"><a href="rpmalloc_8c.html#af51a6ed47e80b1b57187f1d5be6c8b4c">pointer_diff</a></div><div class="ttdeci">#define pointer_diff(first, second)</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00326">rpmalloc.c:326</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ad1094486bd3e5ee282e7a4ce7de9c7db"><div class="ttname"><a href="rpmalloc_8c.html#ad1094486bd3e5ee282e7a4ce7de9c7db">SPAN_FLAG_ALIGNED_BLOCKS</a></div><div class="ttdeci">#define SPAN_FLAG_ALIGNED_BLOCKS</div><div class="ttdoc">Flag indicating span has blocks with increased alignment.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00357">rpmalloc.c:357</a></div></div>
<div class="ttc" id="astructrpmalloc__thread__statistics__t_html_aa6017e8ccbfca8428f4c724fb1034120"><div class="ttname"><a href="structrpmalloc__thread__statistics__t.html#aa6017e8ccbfca8428f4c724fb1034120">rpmalloc_thread_statistics_t::alloc_current</a></div><div class="ttdeci">size_t alloc_current</div><div class="ttdoc">Current number of allocations.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8h_source.html#l00118">rpmalloc.h:118</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_a85a64540090a42380ee6d969ec1897c1"><div class="ttname"><a href="rpmalloc_8c.html#a85a64540090a42380ee6d969ec1897c1">rpmalloc_thread_initialize</a></div><div class="ttdeci">void rpmalloc_thread_initialize(void)</div><div class="ttdoc">Initialize thread, assign heap.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02584">rpmalloc.c:2584</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_ae324fa158db468143544693dfe539800"><div class="ttname"><a href="rpmalloc_8c.html#ae324fa158db468143544693dfe539800">_rpmalloc_deallocate</a></div><div class="ttdeci">static void _rpmalloc_deallocate(void *p)</div><div class="ttdoc">Deallocate the given block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l02161">rpmalloc.c:2161</a></div></div>
<div class="ttc" id="arpmalloc_8c_html_aecb085054ab2d682b41748925519c084"><div class="ttname"><a href="rpmalloc_8c.html#aecb085054ab2d682b41748925519c084">MEDIUM_SIZE_LIMIT</a></div><div class="ttdeci">#define MEDIUM_SIZE_LIMIT</div><div class="ttdoc">Maximum size of a medium block.</div><div class="ttdef"><b>Definition:</b> <a href="rpmalloc_8c_source.html#l00302">rpmalloc.c:302</a></div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="rpmalloc_8c.html">rpmalloc.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
